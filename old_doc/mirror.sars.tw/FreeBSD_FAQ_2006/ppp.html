<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="generator" content="HTML Tidy, see www.w3.org" />
<title>PPP</title>
<meta name="GENERATOR" content="Modular DocBook HTML Stylesheet Version 1.79" />
<link rel="HOME" title="FreeBSD 4.X、5.X、6.X 常見問答集" href="index.html" />
<link rel="PREVIOUS" title="系統安全篇" href="security.html" />
<link rel="NEXT" title="Serial Communications" href="serial.html" />
<link rel="STYLESHEET" type="text/css" href="docbook.css" />
<meta http-equiv="Content-Type" content="text/html; charset=Big5" />
</head>
<body class="CHAPTER" bgcolor="#FFFFFF" text="#000000" link="#0000FF" vlink="#840084"
alink="#0000FF">
<div class="NAVHEADER">
<table summary="Header navigation table" width="100%" border="0" cellpadding="0"
cellspacing="0">
<tr>
<th colspan="3" align="center">FreeBSD 4.X、5.X、6.X 常見問答集</th>
</tr>

<tr>
<td width="10%" align="left" valign="bottom"><a href="security.html"
accesskey="P">Prev</a></td>
<td width="80%" align="center" valign="bottom"></td>
<td width="10%" align="right" valign="bottom"><a href="serial.html"
accesskey="N">Next</a></td>
</tr>
</table>

<hr align="LEFT" width="100%" />
</div>

<div class="CHAPTER">
<h1><a id="PPP" name="PPP"></a>Chapter 14 PPP</h1>

<div class="QANDASET">
<dl>
<dt>14.1. <a href="ppp.html#USERPPP">I cannot make <span class="CITEREFENTRY"><span
class="REFENTRYTITLE">ppp</span>(8)</span> work. What am I doing wrong?</a></dt>

<dt>14.2. <a href="ppp.html#PPP-HANGS">Why does <span class="CITEREFENTRY"><span
class="REFENTRYTITLE">ppp</span>(8)</span> hang when I run it?</a></dt>

<dt>14.3. <a href="ppp.html#PPP-NODIAL-AUTO">Why will <span class="CITEREFENTRY"><span
class="REFENTRYTITLE">ppp</span>(8)</span> not dial in <tt class="LITERAL">-auto</tt>
mode?</a></dt>

<dt>14.4. <a href="ppp.html#NO-ROUTE-TO-HOST">What does “<tt class="ERRORNAME">No route
to host</tt>” mean?</a></dt>

<dt>14.5. <a href="ppp.html#CONNECTION-THREEMINUTEDROP">Why does my connection drop after
about 3 minutes?</a></dt>

<dt>14.6. <a href="ppp.html#PPP-DROP-HEAVY-LOAD">Why does my connection drop under heavy
load?</a></dt>

<dt>14.7. <a href="ppp.html#PPP-DROP-RANDOM">Why does my connection drop after a random
amount of time?</a></dt>

<dt>14.8. <a href="ppp.html#PPP-HANGS-RANDOM">Why does my connection hang after a random
amount of time?</a></dt>

<dt>14.9. <a href="ppp.html#PPP-REMOTE-NOT-RESPONDING">The remote end is not responding.
What can I do?</a></dt>

<dt>14.10. <a href="ppp.html#PPP-HUNG"><span class="CITEREFENTRY"><span
class="REFENTRYTITLE">ppp</span>(8)</span> has hung. What can I do?</a></dt>

<dt>14.11. <a href="ppp.html#PPP-LOGINOK-THENNOTHING">Why does nothing happen after the
“Login OK!” message?</a></dt>

<dt>14.12. <a href="ppp.html#PPP-SAME-MAGIC">I keep seeing errors about magic being the
same. What does it mean?</a></dt>

<dt>14.13. <a href="ppp.html#PPP-LCP-CONSTANT">LCP negotiations continue until the
connection is closed. What is wrong?</a></dt>

<dt>14.14. <a href="ppp.html#PPP-LOCKUPS">Why does <span class="CITEREFENTRY"><span
class="REFENTRYTITLE">ppp</span>(8)</span> lock up shortly after connection?</a></dt>

<dt>14.15. <a href="ppp.html#PPP-SHELL-TEST-LOCKUP">Why does <span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span> lock up when I
shell out to test it?</a></dt>

<dt>14.16. <a href="ppp.html#PPP-NULLMODEM">Why does <span class="CITEREFENTRY"><span
class="REFENTRYTITLE">ppp</span>(8)</span> over a null-modem cable never exit?</a></dt>

<dt>14.17. <a href="ppp.html#PPP-AUTO-NOREASONDIAL">Why does <span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span> dial for no reason
in -auto mode?</a></dt>

<dt>14.18. <a href="ppp.html#CCP-ERRORS">What do these CCP errors mean?</a></dt>

<dt>14.19. <a href="ppp.html#PPP-LOCKUP-IOERRORS">Why does <span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span> lock up during file
transfers with IO errors?</a></dt>

<dt>14.20. <a href="ppp.html#PPP-CONNECTIONSPEED">Why does <span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span> not log my
connection speed?</a></dt>

<dt>14.21. <a href="ppp.html#PPP-IGNORES-BACKSLASH">Why does <span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span> ignore the <tt
class="LITERAL">\</tt> character in my chat script?</a></dt>

<dt>14.22. <a href="ppp.html#PPP-SEGFAULT-NOCORE">Why does <span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span> get a seg-fault,
but I see no <tt class="FILENAME">ppp.core</tt> file?</a></dt>

<dt>14.23. <a href="ppp.html#PPP-AUTODIALPROCESS-NOCONNECT">Why does the process that
forces a dial in auto mode never connect?</a></dt>

<dt>14.24. <a href="ppp.html#PPP-NAT-GAMES">Why do most games not work with the -nat
switch?</a></dt>

<dt>14.25. <a href="ppp.html#USEFUL-PORT-NUMBERS">Has anybody made a list of useful port
numbers?</a></dt>

<dt>14.26. <a href="ppp.html#FCS-ERRORS">What are FCS errors?</a></dt>

<dt>14.27. <a href="ppp.html#MACOS-WIN98-PPPOE-FREEZE">Why do MacOS and Windows 98
connections freeze when running PPPoE on the gateway?</a></dt>

<dt>14.28. <a href="ppp.html#DESPERATION">None of this helps - I am desperate! What can I
do?</a></dt>
</dl>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="USERPPP" name="USERPPP"></a><b>14.1.</b> I cannot make <span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span> work. What am I
doing wrong?</p>
</div>

<div class="ANSWER">
<p><b></b>You should first read the <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> man page and
the <a href="../handbook/ppp-and-slip.html#USERPPP" target="_top">PPP section of the
handbook</a>. Enable logging with the command</p>

<pre class="PROGRAMLISTING">
set log Phase Chat Connect Carrier lcp ipcp ccp command
</pre>

<p>This command may be typed at the <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> command prompt
or it may be entered in the <tt class="FILENAME">/etc/ppp/ppp.conf</tt> configuration
file (the start of the <tt class="LITERAL">default</tt> section is the best place to put
it). Make sure that <tt class="FILENAME">/etc/syslog.conf</tt> (see <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=syslog.conf&amp;sektion=5"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">syslog.conf</span>(5)</span></a>)
contains the lines</p>

<pre class="PROGRAMLISTING">
!ppp
*.*        /var/log/ppp.log
</pre>

<p>and that the file <tt class="FILENAME">/var/log/ppp.log</tt> exists. You can now find
out a lot about what is going on from the log file. Do not worry if it does not all make
sense. If you need to get help from someone, it may make sense to them.</p>

<p>If your version of <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> does not
understand the <tt class="COMMAND">set log</tt> command, you should download the <a
href="http://people.FreeBSD.org/~brian/" target="_top">latest version</a>. It will build
on FreeBSD version 2.1.5 and higher.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="PPP-HANGS" name="PPP-HANGS"></a><b>14.2.</b> Why does <span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span> hang when I run
it?</p>
</div>

<div class="ANSWER">
<p><b></b>This is usually because your hostname will not resolve. The best way to fix
this is to make sure that <tt class="FILENAME">/etc/hosts</tt> is consulted by your
resolver first by editing <tt class="FILENAME">/etc/host.conf</tt> and putting the <tt
class="LITERAL">hosts</tt> line first. Then, simply put an entry in <tt
class="FILENAME">/etc/hosts</tt> for your local machine. If you have no local network,
change your <tt class="HOSTID">localhost</tt> line:</p>

<pre class="PROGRAMLISTING">
127.0.0.1        foo.bar.com foo localhost
</pre>

<p>Otherwise, simply add another entry for your host. Consult the relevant man pages for
more details.</p>

<p>You should be able to successfully <tt class="COMMAND">ping -c1 `hostname`</tt> when
you are done.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="PPP-NODIAL-AUTO" name="PPP-NODIAL-AUTO"></a><b>14.3.</b> Why will <span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span> not dial in <tt
class="LITERAL">-auto</tt> mode?</p>
</div>

<div class="ANSWER">
<p><b></b>First, check that you have got a default route. By running <tt
class="COMMAND">netstat -rn</tt> (see <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=netstat&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">netstat</span>(1)</span></a>), you
should see two entries like this:</p>

<pre class="PROGRAMLISTING">
Destination        Gateway            Flags     Refs     Use     Netif Expire
default            10.0.0.2           UGSc        0        0      tun0
10.0.0.2           10.0.0.1           UH          0        0      tun0
</pre>

<p>This is assuming that you have used the addresses from the handbook, the man page or
from the ppp.conf.sample file. If you do not have a default route, it may be because you
are running an old version of <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> that does not
understand the word <tt class="LITERAL">HISADDR</tt> in the ppp.conf file. If your
version of <a href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> is from before
FreeBSD 2.2.5, change the</p>

<pre class="PROGRAMLISTING">
add 0 0 HISADDR
</pre>

<p>line to one saying</p>

<pre class="PROGRAMLISTING">
add 0 0 10.0.0.2
</pre>

<p>Another reason for the default route line being missing is that you have mistakenly
set up a default router in your <tt class="FILENAME">/etc/rc.conf</tt> (see <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=rc.conf&amp;sektion=5"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">rc.conf</span>(5)</span></a>) file (this
file was called <tt class="FILENAME">/etc/sysconfig</tt> prior to release 2.2.2), and you
have omitted the line saying</p>

<pre class="PROGRAMLISTING">
delete ALL
</pre>

<p>from <tt class="FILENAME">ppp.conf</tt>. If this is the case, go back to the <a
href="../handbook/ppp-and-slip.html#USERPPP-FINAL" target="_top">Final system
configuration</a> section of the handbook.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="NO-ROUTE-TO-HOST" name="NO-ROUTE-TO-HOST"></a><b>14.4.</b> What does “<tt
class="ERRORNAME">No route to host</tt>” mean?</p>
</div>

<div class="ANSWER">
<p><b></b>This error is usually due to a missing</p>

<pre class="PROGRAMLISTING">
MYADDR:
  delete ALL
  add 0 0 HISADDR
</pre>

<p>section in your <tt class="FILENAME">/etc/ppp/ppp.linkup</tt> file. This is only
necessary if you have a dynamic IP address or do not know the address of your gateway. If
you are using interactive mode, you can type the following after entering <tt
class="LITERAL">packet mode</tt> (packet mode is indicated by the capitalized <acronym
class="ACRONYM">PPP</acronym> in the prompt):</p>

<pre class="PROGRAMLISTING">
delete ALL
add 0 0 HISADDR
</pre>

<p>Refer to the <a href="../handbook/ppp-and-slip.html#USERPPP-DYNAMICIP"
target="_top">PPP and Dynamic IP addresses</a> section of the handbook for further
details.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="CONNECTION-THREEMINUTEDROP" name="CONNECTION-THREEMINUTEDROP"></a><b>14.5.</b>
Why does my connection drop after about 3 minutes?</p>
</div>

<div class="ANSWER">
<p><b></b>The default PPP timeout is 3 minutes. This can be adjusted with the line</p>

<pre class="PROGRAMLISTING">
set timeout <tt class="REPLACEABLE"><i>NNN</i></tt>
</pre>

<p>where <tt class="REPLACEABLE"><i>NNN</i></tt> is the number of seconds of inactivity
before the connection is closed. If <tt class="REPLACEABLE"><i>NNN</i></tt> is zero, the
connection is never closed due to a timeout. It is possible to put this command in the
<tt class="FILENAME">ppp.conf</tt> file, or to type it at the prompt in interactive mode.
It is also possible to adjust it on the fly while the line is active by connecting to <b
class="APPLICATION">ppp</b>s server socket using <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=telnet&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">telnet</span>(1)</span></a> or <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=pppctl&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">pppctl</span>(8)</span></a>. Refer to
the <a href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> man page for
further details.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="PPP-DROP-HEAVY-LOAD" name="PPP-DROP-HEAVY-LOAD"></a><b>14.6.</b> Why does my
connection drop under heavy load?</p>
</div>

<div class="ANSWER">
<p><b></b>If you have Link Quality Reporting (LQR) configured, it is possible that too
many LQR packets are lost between your machine and the peer. Ppp deduces that the line
must therefore be bad, and disconnects. Prior to FreeBSD version 2.2.5, LQR was enabled
by default. It is now disabled by default. LQR can be disabled with the line</p>

<pre class="PROGRAMLISTING">
disable lqr
</pre>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="PPP-DROP-RANDOM" name="PPP-DROP-RANDOM"></a><b>14.7.</b> Why does my connection
drop after a random amount of time?</p>
</div>

<div class="ANSWER">
<p><b></b>Sometimes, on a noisy phone line or even on a line with call waiting enabled,
your modem may hang up because it thinks (incorrectly) that it lost carrier.</p>

<p>There is a setting on most modems for determining how tolerant it should be to
temporary losses of carrier. On a USR Sportster for example, this is measured by the S10
register in tenths of a second. To make your modem more forgiving, you could add the
following send-expect sequence to your dial string:</p>

<pre class="PROGRAMLISTING">
set dial "...... ATS10=10 OK ......"
</pre>

<p>Refer to your modem manual for details.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="PPP-HANGS-RANDOM" name="PPP-HANGS-RANDOM"></a><b>14.8.</b> Why does my
connection hang after a random amount of time?</p>
</div>

<div class="ANSWER">
<p><b></b>Many people experience hung connections with no apparent explanation. The first
thing to establish is which side of the link is hung.</p>

<p>If you are using an external modem, you can simply try using <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ping&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ping</span>(8)</span></a> to see if the
<acronym class="ACRONYM">TD</acronym> light is flashing when you transmit data. If it
flashes (and the <acronym class="ACRONYM">RD</acronym> light does not), the problem is
with the remote end. If <acronym class="ACRONYM">TD</acronym> does not flash, the problem
is local. With an internal modem, you will need to use the <tt class="LITERAL">set
server</tt> command in your <tt class="FILENAME">ppp.conf</tt> file. When the hang
occurs, connect to <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> using <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=pppctl&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">pppctl</span>(8)</span></a>. If your
network connection suddenly revives (PPP was revived due to the activity on the
diagnostic socket) or if you cannot connect (assuming the <tt class="LITERAL">set
socket</tt> command succeeded at startup time), the problem is local. If you can connect
and things are still hung, enable local async logging with <tt class="LITERAL">set log
local async</tt> and use <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ping&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ping</span>(8)</span></a> from another
window or terminal to make use of the link. The async logging will show you the data
being transmitted and received on the link. If data is going out and not coming back, the
problem is remote.</p>

<p>Having established whether the problem is local or remote, you now have two
possibilities:</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="PPP-REMOTE-NOT-RESPONDING" name="PPP-REMOTE-NOT-RESPONDING"></a><b>14.9.</b>
The remote end is not responding. What can I do?</p>
</div>

<div class="ANSWER">
<p><b></b>There is very little you can do about this. Most ISPs will refuse to help if
you are not running a Microsoft OS. You can <tt class="LITERAL">enable lqr</tt> in your
<tt class="FILENAME">ppp.conf</tt> file, allowing <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> to detect the
remote failure and hang up, but this detection is relatively slow and therefore not that
useful. You may want to avoid telling your ISP that you are running user-PPP...</p>

<p>First, try disabling all local compression by adding the following to your
configuration:</p>

<pre class="PROGRAMLISTING">
disable pred1 deflate deflate24 protocomp acfcomp shortseq vj
deny pred1 deflate deflate24 protocomp acfcomp shortseq vj
</pre>

<p>Then reconnect to ensure that this makes no difference. If things improve or if the
problem is solved completely, determine which setting makes the difference through trial
and error. This will provide good ammunition when you contact your ISP (although it may
make it apparent that you are not running a Microsoft product).</p>

<p>Before contacting your ISP, enable async logging locally and wait until the connection
hangs again. This may use up quite a bit of disk space. The last data read from the port
may be of interest. It is usually ascii data, and may even describe the problem (“Memory
fault, core dumped”?).</p>

<p>If your ISP is helpful, they should be able to enable logging on their end, then when
the next link drop occurs, they may be able to tell you why their side is having a
problem. Feel free to send the details to Brian Somers <code class="EMAIL">&#60;<a
href="mailto:brian@FreeBSD.org">brian@FreeBSD.org</a>&#62;</code>, or even to ask your
ISP to contact me directly.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="PPP-HUNG" name="PPP-HUNG"></a><b>14.10.</b> <span class="CITEREFENTRY"><span
class="REFENTRYTITLE">ppp</span>(8)</span> has hung. What can I do?</p>
</div>

<div class="ANSWER">
<p><b></b>Your best bet here is to rebuild <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> by adding <tt
class="LITERAL">CFLAGS+=-g</tt> and <tt class="LITERAL">STRIP=</tt> to the end of the
Makefile, then doing a <tt class="COMMAND">make clean &amp;&amp; make &amp;&amp; make
install</tt>. When <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> hangs, find the
<a href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> process id with
<tt class="COMMAND">ps ajxww | fgrep ppp</tt> and run <tt class="COMMAND">gdb ppp <tt
class="REPLACEABLE"><i>PID</i></tt></tt>. From the gdb prompt, you can then use <tt
class="COMMAND">bt</tt> to get a stack trace.</p>

<p>Send the results to <code class="EMAIL">&#60;<a
href="mailto:brian@Awfulhak.org">brian@Awfulhak.org</a>&#62;</code>.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="PPP-LOGINOK-THENNOTHING" name="PPP-LOGINOK-THENNOTHING"></a><b>14.11.</b> Why
does nothing happen after the “Login OK!” message?</p>
</div>

<div class="ANSWER">
<p><b></b>Prior to FreeBSD version 2.2.5, once the link was established, <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> would wait for
the peer to initiate the Line Control Protocol (LCP). Many ISPs will not initiate
negotiations and expect the client to do so. To force <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> to initiate the
LCP, use the following line:</p>

<pre class="PROGRAMLISTING">
set openmode active
</pre>

<div class="NOTE">
<blockquote class="NOTE">
<p><b>Note:</b> It usually does no harm if both sides initiate negotiation, so openmode
is now active by default. However, the next section explains when it <span
class="emphasis"><i class="EMPHASIS">does</i></span> do some harm.</p>
</blockquote>
</div>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="PPP-SAME-MAGIC" name="PPP-SAME-MAGIC"></a><b>14.12.</b> I keep seeing errors
about magic being the same. What does it mean?</p>
</div>

<div class="ANSWER">
<p><b></b>Occasionally, just after connecting, you may see messages in the log that say
“magic is the same”. Sometimes, these messages are harmless, and sometimes one side or
the other exits. Most PPP implementations cannot survive this problem, and even if the
link seems to come up, you will see repeated configure requests and configure
acknowledgments in the log file until <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> eventually
gives up and closes the connection.</p>

<p>This normally happens on server machines with slow disks that are spawning a getty on
the port, and executing <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> from a login
script or program after login. I have also heard reports of it happening consistently
when using slirp. The reason is that in the time taken between <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=getty&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">getty</span>(8)</span></a> exiting and
<a href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> starting, the
client-side <a href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> starts sending
Line Control Protocol (LCP) packets. Because ECHO is still switched on for the port on
the server, the client <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> sees these
packets “reflect” back.</p>

<p>One part of the LCP negotiation is to establish a magic number for each side of the
link so that “reflections” can be detected. The protocol says that when the peer tries
to negotiate the same magic number, a NAK should be sent and a new magic number should be
chosen. During the period that the server port has ECHO turned on, the client <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> sends LCP
packets, sees the same magic in the reflected packet and NAKs it. It also sees the NAK
reflect (which also means <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> must change its
magic). This produces a potentially enormous number of magic number changes, all of which
are happily piling into the server's tty buffer. As soon as <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> starts on the
server, it is flooded with magic number changes and almost immediately decides it has
tried enough to negotiate LCP and gives up. Meanwhile, the client, who no longer sees the
reflections, becomes happy just in time to see a hangup from the server.</p>

<p>This can be avoided by allowing the peer to start negotiating with the following line
in your ppp.conf file:</p>

<pre class="PROGRAMLISTING">
set openmode passive
</pre>

<p>This tells <a href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> to wait for the
server to initiate LCP negotiations. Some servers however may never initiate
negotiations. If this is the case, you can do something like:</p>

<pre class="PROGRAMLISTING">
set openmode active 3
</pre>

<p>This tells <a href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> to be passive
for 3 seconds, and then to start sending LCP requests. If the peer starts sending
requests during this period, <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> will
immediately respond rather than waiting for the full 3 second period.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="PPP-LCP-CONSTANT" name="PPP-LCP-CONSTANT"></a><b>14.13.</b> LCP negotiations
continue until the connection is closed. What is wrong?</p>
</div>

<div class="ANSWER">
<p><b></b>There is currently an implementation mis-feature in <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> where it does
not associate LCP, CCP &amp; IPCP responses with their original requests. As a result, if
one PPP implementation is more than 6 seconds slower than the other side, the other side
will send two additional LCP configuration requests. This is fatal.</p>

<p>Consider two implementations, <tt class="HOSTID">A</tt> and <tt class="HOSTID">B</tt>.
<tt class="HOSTID">A</tt> starts sending LCP requests immediately after connecting and
<tt class="HOSTID">B</tt> takes 7 seconds to start. When <tt class="HOSTID">B</tt>
starts, <tt class="HOSTID">A</tt> has sent 3 LCP REQs. We are assuming the line has ECHO
switched off, otherwise we would see magic number problems as described in the previous
section. <tt class="HOSTID">B</tt> sends a REQ, then an ACK to the first of <tt
class="HOSTID">A</tt>'s REQs. This results in <tt class="HOSTID">A</tt> entering the
<acronym class="ACRONYM">OPENED</acronym> state and sending and ACK (the first) back to
<tt class="HOSTID">B</tt>. In the meantime, <tt class="HOSTID">B</tt> sends back two more
ACKs in response to the two additional REQs sent by <tt class="HOSTID">A</tt> before <tt
class="HOSTID">B</tt> started up. <tt class="HOSTID">B</tt> then receives the first ACK
from <tt class="HOSTID">A</tt> and enters the <acronym class="ACRONYM">OPENED</acronym>
state. <tt class="HOSTID">A</tt> receives the second ACK from <tt class="HOSTID">B</tt>
and goes back to the <acronym class="ACRONYM">REQ-SENT</acronym> state, sending another
(forth) REQ as per the RFC. It then receives the third ACK and enters the <acronym
class="ACRONYM">OPENED</acronym> state. In the meantime, <tt class="HOSTID">B</tt>
receives the forth REQ from <tt class="HOSTID">A</tt>, resulting in it reverting to the
<acronym class="ACRONYM">ACK-SENT</acronym> state and sending another (second) REQ and
(forth) ACK as per the RFC. <tt class="HOSTID">A</tt> gets the REQ, goes into <acronym
class="ACRONYM">REQ-SENT</acronym> and sends another REQ. It immediately receives the
following ACK and enters <acronym class="ACRONYM">OPENED</acronym>.</p>

<p>This goes on until one side figures out that they are getting nowhere and gives
up.</p>

<p>The best way to avoid this is to configure one side to be <tt
class="LITERAL">passive</tt> - that is, make one side wait for the other to start
negotiating. This can be done with the</p>

<pre class="PROGRAMLISTING">
set openmode passive
</pre>

<p>command. Care should be taken with this option. You should also use the</p>

<pre class="PROGRAMLISTING">
set stopped N
</pre>

<p>command to limit the amount of time that <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> waits for the
peer to begin negotiations. Alternatively, the</p>

<pre class="PROGRAMLISTING">
set openmode active N
</pre>

<p>command (where <tt class="REPLACEABLE"><i>N</i></tt> is the number of seconds to wait
before starting negotiations) can be used. Check the manual page for details.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="PPP-LOCKUPS" name="PPP-LOCKUPS"></a><b>14.14.</b> Why does <span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span> lock up shortly
after connection?</p>
</div>

<div class="ANSWER">
<p><b></b>Prior to version 2.2.5 of FreeBSD, it was possible that your link was disabled
shortly after connection due to <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> mis-handling
Predictor1 compression negotiation. This would only happen if both sides tried to
negotiate different Compression Control Protocols (CCP). This problem is now corrected,
but if you are still running an old version of <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> the problem can
be circumvented with the line</p>

<pre class="PROGRAMLISTING">
disable pred1
</pre>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="PPP-SHELL-TEST-LOCKUP" name="PPP-SHELL-TEST-LOCKUP"></a><b>14.15.</b> Why does
<span class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span> lock up when
I shell out to test it?</p>
</div>

<div class="ANSWER">
<p><b></b>When you execute the <tt class="COMMAND">shell</tt> or <tt
class="COMMAND">!</tt> command, <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> executes a
shell (or if you have passed any arguments, <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> will execute
those arguments). Ppp will wait for the command to complete before continuing. If you
attempt to use the PPP link while running the command, the link will appear to have
frozen. This is because <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> is waiting for
the command to complete.</p>

<p>If you wish to execute commands like this, use the <tt class="COMMAND">!bg</tt>
command instead. This will execute the given command in the background, and <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> can continue to
service the link.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="PPP-NULLMODEM" name="PPP-NULLMODEM"></a><b>14.16.</b> Why does <span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span> over a null-modem
cable never exit?</p>
</div>

<div class="ANSWER">
<p><b></b>There is no way for <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> to
automatically determine that a direct connection has been dropped. This is due to the
lines that are used in a null-modem serial cable. When using this sort of connection, LQR
should always be enabled with the line</p>

<pre class="PROGRAMLISTING">
enable lqr
</pre>

<p>LQR is accepted by default if negotiated by the peer.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="PPP-AUTO-NOREASONDIAL" name="PPP-AUTO-NOREASONDIAL"></a><b>14.17.</b> Why does
<span class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span> dial for no
reason in -auto mode?</p>
</div>

<div class="ANSWER">
<p><b></b>If <a href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> is dialing
unexpectedly, you must determine the cause, and set up Dial filters (dfilters) to prevent
such dialing.</p>

<p>To determine the cause, use the following line:</p>

<pre class="PROGRAMLISTING">
set log +tcp/ip
</pre>

<p>This will log all traffic through the connection. The next time the line comes up
unexpectedly, you will see the reason logged with a convenient timestamp next to it.</p>

<p>You can now disable dialing under these circumstances. Usually, this sort of problem
arises due to DNS lookups. To prevent DNS lookups from establishing a connection (this
will <span class="emphasis"><i class="EMPHASIS">not</i></span> prevent <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> from passing
the packets through an established connection), use the following:</p>

<pre class="PROGRAMLISTING">
set dfilter 1 deny udp src eq 53
set dfilter 2 deny udp dst eq 53
set dfilter 3 permit 0/0 0/0
</pre>

<p>This is not always suitable, as it will effectively break your demand-dial
capabilities - most programs will need a DNS lookup before doing any other network
related things.</p>

<p>In the DNS case, you should try to determine what is actually trying to resolve a host
name. A lot of the time, <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=sendmail&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">sendmail</span>(8)</span></a> is the
culprit. You should make sure that you tell sendmail not to do any DNS lookups in its
configuration file. See the section on <a href="admin.html#ISPMAIL">Mail
Configuration</a> for details on how to create your own configuration file and what
should go into it. You may also want to add the following line to your <tt
class="FILENAME">.mc</tt> file:</p>

<pre class="PROGRAMLISTING">
define(`confDELIVERY_MODE', `d')dnl
</pre>

<p>This will make sendmail queue everything until the queue is run (usually, sendmail is
invoked with <code class="OPTION">-bd -q30m</code>, telling it to run the queue every 30
minutes) or until a <tt class="COMMAND">sendmail -q</tt> is done (perhaps from your
ppp.linkup file).</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="CCP-ERRORS" name="CCP-ERRORS"></a><b>14.18.</b> What do these CCP errors
mean?</p>
</div>

<div class="ANSWER">
<p><b></b>I keep seeing the following errors in my log file:</p>

<pre class="PROGRAMLISTING">
CCP: CcpSendConfigReq
CCP: Received Terminate Ack (1) state = Req-Sent (6)
</pre>

<p>This is because <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> is trying to
negotiate Predictor1 compression, and the peer does not want to negotiate any compression
at all. The messages are harmless, but if you wish to remove them, you can disable
Predictor1 compression locally too:</p>

<pre class="PROGRAMLISTING">
disable pred1
</pre>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="PPP-LOCKUP-IOERRORS" name="PPP-LOCKUP-IOERRORS"></a><b>14.19.</b> Why does
<span class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span> lock up
during file transfers with IO errors?</p>
</div>

<div class="ANSWER">
<p><b></b>Under FreeBSD 2.2.2 and before, there was a bug in the tun driver that prevents
incoming packets of a size larger than the tun interface's MTU size. Receipt of a packet
greater than the MTU size results in an IO error being logged via syslogd.</p>

<p>The PPP specification says that an MRU of 1500 should <span class="emphasis"><i
class="EMPHASIS">always</i></span> be accepted as a minimum, despite any LCP
negotiations, therefore it is possible that should you decrease the MTU to less than
1500, your ISP will transmit packets of 1500 regardless, and you will tickle this
non-feature - locking up your link.</p>

<p>The problem can be circumvented by never setting an MTU of less than 1500 under
FreeBSD 2.2.2 or before.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="PPP-CONNECTIONSPEED" name="PPP-CONNECTIONSPEED"></a><b>14.20.</b> Why does
<span class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span> not log my
connection speed?</p>
</div>

<div class="ANSWER">
<p><b></b>In order to log all lines of your modem “conversation”, you must enable the
following:</p>

<pre class="PROGRAMLISTING">
set log +connect
</pre>

<p>This will make <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> log everything
up until the last requested “expect” string.</p>

<p>If you wish to see your connect speed and are using PAP or CHAP (and therefore do not
have anything to “chat” after the CONNECT in the dial script - no <tt
class="LITERAL">set login</tt> script), you must make sure that you instruct <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> to “expect”
the whole CONNECT line, something like this:</p>

<pre class="PROGRAMLISTING">
set dial "ABORT BUSY ABORT NO\\sCARRIER TIMEOUT 4 \
  \"\" ATZ OK-ATZ-OK ATDT\\T TIMEOUT 60 CONNECT \\c \\n"
</pre>

<p>Here, we get our CONNECT, send nothing, then expect a line-feed, forcing <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> to read the
whole CONNECT response.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="PPP-IGNORES-BACKSLASH" name="PPP-IGNORES-BACKSLASH"></a><b>14.21.</b> Why does
<span class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span> ignore the
<tt class="LITERAL">\</tt> character in my chat script?</p>
</div>

<div class="ANSWER">
<p><b></b>Ppp parses each line in your config files so that it can interpret strings such
as <tt class="LITERAL">set phone "123 456 789"</tt> correctly (and realize that the
number is actually only <span class="emphasis"><i class="EMPHASIS">one</i></span>
argument. In order to specify a <tt class="LITERAL">&quot;</tt> character, you must
escape it using a backslash (<tt class="LITERAL">\</tt>).</p>

<p>When the chat interpreter parses each argument, it re-interprets the argument in order
to find any special escape sequences such as <tt class="LITERAL">\P</tt> or <tt
class="LITERAL">\T</tt> (see the man page). As a result of this double-parsing, you must
remember to use the correct number of escapes.</p>

<p>If you wish to actually send a <tt class="LITERAL">\</tt> character to (say) your
modem, you would need something like:</p>

<pre class="PROGRAMLISTING">
set dial "\"\" ATZ OK-ATZ-OK AT\\\\X OK"
</pre>

<p>resulting in the following sequence:</p>

<pre class="PROGRAMLISTING">
ATZ
OK
AT\X
OK
</pre>

<p>or</p>

<pre class="PROGRAMLISTING">
set phone 1234567
set dial "\"\" ATZ OK ATDT\\T"
</pre>

<p>resulting in the following sequence:</p>

<pre class="PROGRAMLISTING">
ATZ
OK
ATDT1234567
</pre>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="PPP-SEGFAULT-NOCORE" name="PPP-SEGFAULT-NOCORE"></a><b>14.22.</b> Why does
<span class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span> get a
seg-fault, but I see no <tt class="FILENAME">ppp.core</tt> file?</p>
</div>

<div class="ANSWER">
<p><b></b>Ppp (or any other program for that matter) should never dump core. Because <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> runs with an
effective user id of 0, the operating system will not write <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a>'s core image to
disk before terminating it. If, however <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> is actually
terminating due to a segmentation violation or some other signal that normally causes
core to be dumped, <span class="emphasis"><i class="EMPHASIS">and</i></span> you are sure
you are using the latest version (see the start of this section), then you should do the
following:</p>

<pre class="SCREEN">
<samp class="PROMPT">%</samp> <kbd class="USERINPUT">tar xfz ppp-*.src.tar.gz</kbd>
<samp class="PROMPT">%</samp> <kbd class="USERINPUT">cd ppp*/ppp</kbd>
<samp class="PROMPT">%</samp> <kbd class="USERINPUT">echo STRIP= &gt;&gt;Makefile</kbd>
<samp class="PROMPT">%</samp> <kbd
class="USERINPUT">echo CFLAGS+=-g &gt;&gt;Makefile</kbd>
<samp class="PROMPT">%</samp> <kbd class="USERINPUT">make clean all</kbd>
<samp class="PROMPT">%</samp> <kbd class="USERINPUT">su</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make install</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">chmod 555 /usr/sbin/ppp</kbd>
</pre>

<p>You will now have a debuggable version of <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> installed. You
will have to be <tt class="USERNAME">root</tt> to run <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> as all of its
privileges have been revoked. When you start <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a>, take a careful
note of what your current directory was at the time.</p>

<p>Now, if and when <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> receives the
segmentation violation, it will dump a core file called <tt
class="FILENAME">ppp.core</tt>. You should then do the following:</p>

<pre class="SCREEN">
<samp class="PROMPT">%</samp> <kbd class="USERINPUT">su</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">gdb /usr/sbin/ppp ppp.core</kbd>
<samp class="PROMPT">(gdb)</samp> <kbd class="USERINPUT">bt</kbd>
.....
<samp class="PROMPT">(gdb)</samp> <kbd class="USERINPUT">f 0</kbd>
....
<samp class="PROMPT">(gdb)</samp> <kbd class="USERINPUT">i args</kbd>
....
<samp class="PROMPT">(gdb)</samp> <kbd class="USERINPUT">l</kbd>
.....
</pre>

<p>All of this information should be given alongside your question, making it possible to
diagnose the problem.</p>

<p>If you are familiar with gdb, you may wish to find out some other bits and pieces such
as what actually caused the dump and the addresses &amp; values of the relevant
variables.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="PPP-AUTODIALPROCESS-NOCONNECT"
name="PPP-AUTODIALPROCESS-NOCONNECT"></a><b>14.23.</b> Why does the process that forces a
dial in auto mode never connect?</p>
</div>

<div class="ANSWER">
<p><b></b>This was a known problem with <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> set up to
negotiate a dynamic local IP number with the peer in auto mode. It is fixed in the latest
version - search the man page for <tt class="LITERAL">iface</tt>.</p>

<p>The problem was that when that initial program calls <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=connect&amp;sektion=2"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">connect</span>(2)</span></a>, the IP
number of the tun interface is assigned to the socket endpoint. The kernel creates the
first outgoing packet and writes it to the tun device. <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> then reads the
packet and establishes a connection. If, as a result of <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a>'s dynamic IP
assignment, the interface address is changed, the original socket endpoint will be
invalid. Any subsequent packets sent to the peer will usually be dropped. Even if they
are not, any responses will not route back to the originating machine as the IP number is
no longer owned by that machine.</p>

<p>There are several theoretical ways to approach this problem. It would be nicest if the
peer would re-assign the same IP number if possible <tt class="LITERAL">:-)</tt> The
current version of <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> does this, but
most other implementations do not.</p>

<p>The easiest method from our side would be to never change the tun interface IP number,
but instead to change all outgoing packets so that the source IP number is changed from
the interface IP to the negotiated IP on the fly. This is essentially what the <tt
class="LITERAL">iface-alias</tt> option in the latest version of <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> is doing (with
the help of <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=libalias&amp;sektion=3"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">libalias</span>(3)</span></a> and <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a>'s <code
class="OPTION">-nat</code> switch) - it is maintaining all previous interface addresses
and NATing them to the last negotiated address.</p>

<p>Another alternative (and probably the most reliable) would be to implement a system
call that changes all bound sockets from one IP to another. <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> would use this
call to modify the sockets of all existing programs when a new IP number is negotiated.
The same system call could be used by dhcp clients when they are forced to re-bind()
their sockets.</p>

<p>Yet another possibility is to allow an interface to be brought up without an IP
number. Outgoing packets would be given an IP number of 255.255.255.255 up until the
first SIOCAIFADDR ioctl is done. This would result in fully binding the socket. It would
be up to <a href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> to change the
source IP number, but only if it is set to 255.255.255.255, and only the IP number and IP
checksum would need to change. This, however is a bit of a hack as the kernel would be
sending bad packets to an improperly configured interface, on the assumption that some
other mechanism is capable of fixing things retrospectively.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="PPP-NAT-GAMES" name="PPP-NAT-GAMES"></a><b>14.24.</b> Why do most games not
work with the -nat switch?</p>
</div>

<div class="ANSWER">
<p><b></b>The reason games and the like do not work when libalias is in use is that the
machine on the outside will try to open a connection or send (unsolicited) UDP packets to
the machine on the inside. The NAT software does not know that it should send these
packets to the interior machine.</p>

<p>To make things work, make sure that the only thing running is the software that you
are having problems with, then either run tcpdump on the tun interface of the gateway or
enable <a href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> tcp/ip logging
(<tt class="LITERAL">set log +tcp/ip</tt>) on the gateway.</p>

<p>When you start the offending software, you should see packets passing through the
gateway machine. When something comes back from the outside, it will be dropped (that is
the problem). Note the port number of these packets then shut down the offending
software. Do this a few times to see if the port numbers are consistent. If they are,
then the following line in the relevant section of <tt
class="FILENAME">/etc/ppp/ppp.conf</tt> will make the software functional:</p>

<pre class="PROGRAMLISTING">
nat port <tt class="REPLACEABLE"><i>proto</i></tt> <tt
class="REPLACEABLE"><i>internalmachine</i></tt>:<tt
class="REPLACEABLE"><i>port</i></tt> <tt class="REPLACEABLE"><i>port</i></tt>
</pre>

<p>where <tt class="REPLACEABLE"><i>proto</i></tt> is either <tt class="LITERAL">tcp</tt>
or <tt class="LITERAL">udp</tt>, <tt class="REPLACEABLE"><i>internalmachine</i></tt> is
the machine that you want the packets to be sent to and <tt
class="REPLACEABLE"><i>port</i></tt> is the destination port number of the packets.</p>

<p>You will not be able to use the software on other machines without changing the above
command, and running the software on two internal machines at the same time is out of the
question - after all, the outside world is seeing your entire internal network as being
just a single machine.</p>

<p>If the port numbers are not consistent, there are three more options:</p>

<ol type="1">
<li>
<p>Submit support in libalias. Examples of “special cases” can be found in <tt
class="FILENAME">/usr/src/lib/libalias/alias_*.c</tt> (<tt
class="FILENAME">alias_ftp.c</tt> is a good prototype). This usually involves reading
certain recognised outgoing packets, identifying the instruction that tells the outside
machine to initiate a connection back to the internal machine on a specific (random) port
and setting up a “route” in the alias table so that the subsequent packets know where
to go.</p>

<p>This is the most difficult solution, but it is the best and will make the software
work with multiple machines.</p>
</li>

<li>
<p>Use a proxy. The application may support socks5 for example, or (as in the “cvsup”
case) may have a “passive” option that avoids ever requesting that the peer open
connections back to the local machine.</p>
</li>

<li>
<p>Redirect everything to the internal machine using <tt class="LITERAL">nat addr</tt>.
This is the sledge-hammer approach.</p>
</li>
</ol>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="USEFUL-PORT-NUMBERS" name="USEFUL-PORT-NUMBERS"></a><b>14.25.</b> Has anybody
made a list of useful port numbers?</p>
</div>

<div class="ANSWER">
<p><b></b>Not yet, but this is intended to grow into such a list (if any interest is
shown). In each example, <tt class="REPLACEABLE"><i>internal</i></tt> should be replaced
with the IP number of the machine playing the game.</p>

<ul>
<li>
<p><b class="APPLICATION">Asheron's Call</b></p>

<p><tt class="LITERAL">nat port udp <tt class="REPLACEABLE"><i>internal</i></tt> :65000
65000</tt></p>

<p>Manually change the port number within the game to 65000. If you have got a number of
machines that you wish to play on assign a unique port number for each (i.e. 65001,
65002, etc) and add a <tt class="LITERAL">nat port</tt> line for each one.</p>
</li>

<li>
<p><b class="APPLICATION">Half Life</b></p>

<p><tt class="LITERAL">nat port udp <tt class="REPLACEABLE"><i>internal</i></tt>:27005
27015</tt></p>
</li>

<li>
<p><b class="APPLICATION">PCAnywhere 8.0</b></p>

<p><tt class="LITERAL">nat port udp <tt class="REPLACEABLE"><i>internal</i></tt>:5632
5632</tt></p>

<p><tt class="LITERAL">nat port tcp <tt class="REPLACEABLE"><i>internal</i></tt>:5631
5631</tt></p>
</li>

<li>
<p><b class="APPLICATION">Quake</b></p>

<p><tt class="LITERAL">nat port udp <tt class="REPLACEABLE"><i>internal</i></tt>:6112
6112</tt></p>

<p>Alternatively, you may want to take a look at <a
href="http://www.battle.net/support/proxy/" target="_top">www.battle.net</a> for Quake
proxy support.</p>
</li>

<li>
<p><b class="APPLICATION">Quake 2</b></p>

<p><tt class="LITERAL">nat port udp <tt class="REPLACEABLE"><i>internal</i></tt>:27901
27910</tt></p>

<p><tt class="LITERAL">nat port udp <tt class="REPLACEABLE"><i>internal</i></tt>:60021
60021</tt></p>

<p><tt class="LITERAL">nat port udp <tt class="REPLACEABLE"><i>internal</i></tt>:60040
60040</tt></p>
</li>

<li>
<p><b class="APPLICATION">Red Alert</b></p>

<p><tt class="LITERAL">nat port udp <tt class="REPLACEABLE"><i>internal</i></tt>:8675
8675</tt></p>

<p><tt class="LITERAL">nat port udp <tt class="REPLACEABLE"><i>internal</i></tt>:5009
5009</tt></p>
</li>
</ul>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="FCS-ERRORS" name="FCS-ERRORS"></a><b>14.26.</b> What are FCS errors?</p>
</div>

<div class="ANSWER">
<p><b></b>FCS stands for <tt class="LITERAL">F</tt>rame <tt class="LITERAL">C</tt>heck
<tt class="LITERAL">S</tt>equence. Each PPP packet has a checksum attached to ensure that
the data being received is the data being sent. If the FCS of an incoming packet is
incorrect, the packet is dropped and the HDLC FCS count is increased. The HDLC error
values can be displayed using the <tt class="LITERAL">show hdlc</tt> command.</p>

<p>If your link is bad (or if your serial driver is dropping packets), you will see the
occasional FCS error. This is not usually worth worrying about although it does slow down
the compression protocols substantially. If you have an external modem, make sure your
cable is properly shielded from interference - this may eradicate the problem.</p>

<p>If your link freezes as soon as you have connected and you see a large number of FCS
errors, this may be because your link is not 8 bit clean. Make sure your modem is not
using software flow control (XON/XOFF). If your datalink <span class="emphasis"><i
class="EMPHASIS">must</i></span> use software flow control, use the command <tt
class="LITERAL">set accmap 0x000a0000</tt> to tell <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> to escape the
<tt class="LITERAL">^Q</tt> and <tt class="LITERAL">^S</tt> characters.</p>

<p>Another reason for seeing too many FCS errors may be that the remote end has stopped
talking <acronym class="ACRONYM">PPP</acronym>. You may want to enable <tt
class="LITERAL">async</tt> logging at this point to determine if the incoming data is
actually a login or shell prompt. If you have a shell prompt at the remote end, it is
possible to terminate <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> without
dropping the line by using the <tt class="LITERAL">close lcp</tt> command (a following
<tt class="LITERAL">term</tt> command will reconnect you to the shell on the remote
machine.</p>

<p>If nothing in your log file indicates why the link might have been terminated, you
should ask the remote administrator (your ISP?) why the session was terminated.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="MACOS-WIN98-PPPOE-FREEZE" name="MACOS-WIN98-PPPOE-FREEZE"></a><b>14.27.</b> Why
do MacOS and Windows 98 connections freeze when running PPPoE on the gateway?</p>
</div>

<div class="ANSWER">
<p><b></b>Thanks to Michael Wozniak <code class="EMAIL">&#60;<a
href="mailto:mwozniak@netcom.ca">mwozniak@netcom.ca</a>&#62;</code> for figuring this out
and Dan Flemming <code class="EMAIL">&#60;<a
href="mailto:danflemming@mac.com">danflemming@mac.com</a>&#62;</code> for the Mac
solution:</p>

<p>This is due to what is called a “Black Hole” router. MacOS and Windows 98 (and maybe
other Microsoft OSs) send TCP packets with a requested segment size too big to fit into a
PPPoE frame (MTU is 1500 by default for Ethernet) <span class="emphasis"><i
class="EMPHASIS">and</i></span> have the “do not fragment” bit set (default of TCP) and
the Telco router is not sending ICMP “must fragment” back to the www site you are
trying to load. (Alternatively, the router is sending the ICMP packet correctly, but the
firewall at the www site is dropping it.) When the www server is sending you frames that
do not fit into the PPPoE pipe the Telco router drops them on the floor and your page
does not load (some pages/graphics do as they are smaller than a MSS.) This seems to be
the default of most Telco PPPoE configurations (if only they knew how to program a
router... sigh...)</p>

<p>One fix is to use regedit on your 95/98 boxes to add the following registry
entry...</p>

<pre class="PROGRAMLISTING">
HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\Class\NetTrans\0000\MaxMTU
</pre>

<p>It should be a string with a value “1436”, as some ADSL routers are reported to be
unable to deal with packets larger than this. This registry key has been changed to <tt
class="LITERAL">Tcpip\Parameters\Interfaces\<tt class="REPLACEABLE"><i>ID for
adapter</i></tt>\MTU</tt> in Windows 2000 and becomes a DWORD.</p>

<p>Refer to the Microsoft Knowledge Base documents <a
href="http://support.microsoft.com/support/kb/articles/Q158/4/74.asp"
target="_top">Q158474 - Windows TCPIP Registry Entries</a> and <a
href="http://support.microsoft.com/support/kb/articles/Q120/6/42.asp"
target="_top">Q120642 - TCPIP &#38; NBT Configuration Parameters for Windows NT</a> for
more information on changing Windows MTU to work with a NAT router.</p>

<p>Another regedit possibility under Windows 2000 is to set the <tt
class="LITERAL">Tcpip\Parameters\Interfaces\<tt class="REPLACEABLE"><i>ID for
adapter</i></tt>\EnablePMTUBHDetect</tt> DWORD to 1 as mentioned in the Microsoft
document 120642 mentioned above.</p>

<p>Unfortunately, MacOS does not provide an interface for changing TCP/IP settings.
However, there is commercial software available, such as OTAdvancedTuner (OT for
OpenTransport, the MacOS TCP/IP stack) by <a href="http://www.softworks.com/"
target="_top">Sustainable Softworks</a>, that will allow users to customize TCP/IP
settings. MacOS NAT users should select <tt class="LITERAL">ip_interface_MTU</tt> from
the drop-down menu, enter <tt class="LITERAL">1450</tt> instead of <tt
class="LITERAL">1500</tt> in the box, click the box next to <tt class="LITERAL">Save as
Auto Configure</tt>, and click <tt class="LITERAL">Make Active</tt>.</p>

<p>The latest version of <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a> (2.3 or
greater) has an <tt class="COMMAND">enable tcpmssfixup</tt> command that will
automatically adjust the MSS to an appropriate value. This facility is enabled by
default. If you are stuck with an older version of <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a>, you may want
to look at the <b class="APPLICATION">tcpmssd</b> port.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="DESPERATION" name="DESPERATION"></a><b>14.28.</b> None of this helps - I am
desperate! What can I do?</p>
</div>

<div class="ANSWER">
<p><b></b>If all else fails, send as much information as you can, including your config
files, how you are starting <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ppp&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ppp</span>(8)</span></a>, the relevant
parts of your log file and the output of the <tt class="COMMAND">netstat -rn</tt> command
(before and after connecting) to the <a
href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-questions" target="_top">FreeBSD
general questions mailing list</a> or the <a href="news:comp.unix.bsd.freebsd.misc"
target="_top">comp.unix.bsd.freebsd.misc</a> news group, and someone should point you in
the right direction.</p>
</div>
</div>
</div>
</div>

<div class="NAVFOOTER">
<hr align="LEFT" width="100%" />
<table summary="Footer navigation table" width="100%" border="0" cellpadding="0"
cellspacing="0">
<tr>
<td width="33%" align="left" valign="top"><a href="security.html"
accesskey="P">Prev</a></td>
<td width="34%" align="center" valign="top"><a href="index.html"
accesskey="H">Home</a></td>
<td width="33%" align="right" valign="top"><a href="serial.html"
accesskey="N">Next</a></td>
</tr>

<tr>
<td width="33%" align="left" valign="top">系統安全篇</td>
<td width="34%" align="center" valign="top">&nbsp;</td>
<td width="33%" align="right" valign="top">Serial Communications</td>
</tr>
</table>
</div>

<p align="center"><small>This, and other documents, can be downloaded from <a
href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>.</small></p>

<p align="center"><small>For questions about FreeBSD, read the <a
href="http://www.FreeBSD.org/docs.html">documentation</a> before contacting &#60;<a
href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&#62;.<br />
For questions about this documentation, e-mail &#60;<a
href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&#62;.</small></p>
</body>
</html>

