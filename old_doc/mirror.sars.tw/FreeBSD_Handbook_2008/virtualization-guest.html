<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="generator" content="HTML Tidy, see www.w3.org" />
<title>安裝 FreeBSD 為 Guest OS</title>
<meta name="GENERATOR" content="Modular DocBook HTML Stylesheet Version 1.79" />
<link rel="HOME" title="FreeBSD 使用手冊" href="index.html" />
<link rel="UP" title="Virtualization(虛擬機器)" href="virtualization.html" />
<link rel="PREVIOUS" title="Virtualization(虛擬機器)" href="virtualization.html" />
<link rel="NEXT" title="以 FreeBSD 為 Host OS" href="virtualization-host.html" />
<link rel="STYLESHEET" type="text/css" href="docbook.css" />
<meta http-equiv="Content-Type" content="text/html; charset=Big5" />
</head>
<body class="SECT1" bgcolor="#FFFFFF" text="#000000" link="#0000FF" vlink="#840084"
alink="#0000FF">
<div class="NAVHEADER">
<table summary="Header navigation table" width="100%" border="0" cellpadding="0"
cellspacing="0">
<tr>
<th colspan="3" align="center">FreeBSD 使用手冊</th>
</tr>

<tr>
<td width="10%" align="left" valign="bottom"><a href="virtualization.html"
accesskey="P">Prev</a></td>
<td width="80%" align="center" valign="bottom">Chapter 21 Virtualization(虛擬機器)</td>
<td width="10%" align="right" valign="bottom"><a href="virtualization-host.html"
accesskey="N">Next</a></td>
</tr>
</table>

<hr align="LEFT" width="100%" />
</div>

<div class="SECT1">
<h1 class="SECT1"><a id="VIRTUALIZATION-GUEST" name="VIRTUALIZATION-GUEST">21.2 安裝
FreeBSD 為 Guest OS</a></h1>

<div class="SECT2">
<h2 class="SECT2"><a id="VIRTUALIZATION-GUEST-PARALLELS"
name="VIRTUALIZATION-GUEST-PARALLELS">21.2.1 MacOS 上的 Parallels</a></h2>

<p><span class="TRADEMARK">Mac</span>&reg; 版的 <b class="APPLICATION">Parallels
Desktop</b> 乃是可用於搭配 <span class="TRADEMARK">Intel</span>&reg; CPU 以及 <span
class="TRADEMARK">Mac&nbsp;OS</span>&reg; 10.4.6 以上的 <span
class="TRADEMARK">Apple</span>&reg; <span class="TRADEMARK">Mac</span> 電腦的商業軟體。
FreeBSD 是其有完整支援的 guest OS 之一。 在 <span class="TRADEMARK">Mac&nbsp;OS</span> X
裝好 <b class="APPLICATION">Parallels</b> 後， 必須針對所欲安裝的 guest OS
來作相關的虛擬機器設定。</p>

<div class="SECT3">
<h3 class="SECT3"><a id="VIRTUALIZATION-GUEST-PARALLELS-INSTALL"
name="VIRTUALIZATION-GUEST-PARALLELS-INSTALL">21.2.1.1 在 Parallels/<span
class="TRADEMARK">Mac&nbsp;OS</span>&reg; X 上安裝 FreeBSD</a></h3>

<p>在 <span class="TRADEMARK">Mac&nbsp;OS</span> X/<b class="APPLICATION">Parallels</b>
上安裝 FreeBSD 的第一步是新增虛擬機器。 如下所示，在提示視窗內請將 <span
class="GUIMENU">Guest OS Type</span> 勾選為 <span
class="GUIMENUITEM">FreeBSD</span>：</p>

<p><img src="virtualization/parallels-freebsd1.png" /></p>

<p>並依據自身需求來規劃硬碟容量跟記憶體的分配。 對大多數在 <b
class="APPLICATION">Parallels</b> 使用的情況而言，大約 4GB 硬碟以及 512MB RAM
就夠用了：</p>

<p><img src="virtualization/parallels-freebsd2.png" /></p>

<p><img src="virtualization/parallels-freebsd3.png" /></p>

<p><img src="virtualization/parallels-freebsd4.png" /></p>

<p><img src="virtualization/parallels-freebsd5.png" /></p>

<p>接下來，選擇網路種類以及網路卡：</p>

<p><img src="virtualization/parallels-freebsd6.png" /></p>

<p><img src="virtualization/parallels-freebsd7.png" /></p>

<p>最後，儲存設定檔就完成設定了：</p>

<p><img src="virtualization/parallels-freebsd8.png" /></p>

<p><img src="virtualization/parallels-freebsd9.png" /></p>

<p>在 FreeBSD 虛擬機器新增後，就可以繼續以其安裝 FreeBSD。
安裝方面，比較好的作法是使用官方的 FreeBSD 光碟或者從官方 FTP 站下載 ISO image 檔。
若您的 <span class="TRADEMARK">Mac</span> 本機已經有該 ISO 檔， 或者 <span
class="TRADEMARK">Mac</span> 的光碟機內有放安裝片，那麼就可以在 FreeBSD 的 <b
class="APPLICATION">Parallels</b> 視窗右下角按下光碟片圖示。
接著會出現一個視窗，可以把虛擬機器內的光碟機設定到該 ISO 檔， 或者是實體光碟機。</p>

<p><img src="virtualization/parallels-freebsd11.png" /></p>

<p>設好光碟片來源之後，就可以按下重開機圖示以重開 FreeBSD 虛擬機器。 <b
class="APPLICATION">Parallels</b> 會以特殊 BIOS 開機，並與普通的 BIOS
一樣會先檢查是否有光碟機。</p>

<p><img src="virtualization/parallels-freebsd10.png" /></p>

<p>此時，它就會找到 FreeBSD 安裝片，並開始在 <a href="install.html">Chapter 2</a>
內所介紹到的 <b class="APPLICATION">sysinstall</b> 安裝過程。 這時候也可順便裝
X11，但先不要進行相關設定。</p>

<p><img src="virtualization/parallels-freebsd12.png" /></p>

<p>完成安裝過程之後，就可以重開剛裝的 FreeBSD 虛擬機器。</p>

<p><img src="virtualization/parallels-freebsd13.png" /></p>
</div>

<div class="SECT3">
<h3 class="SECT3"><a id="VIRTUALIZATION-GUEST-PARALLELS-CONFIGURE"
name="VIRTUALIZATION-GUEST-PARALLELS-CONFIGURE">21.2.1.2 在 <span
class="TRADEMARK">Mac&nbsp;OS</span> X/Parallels 上設定 FreeBSD</a></h3>

<p>把 FreeBSD 成功裝到 <span class="TRADEMARK">Mac&nbsp;OS</span> X 的 <b
class="APPLICATION">Parallels</b> 之後，還需要作一些設定步驟， 以便將虛擬機器內的 FreeBSD
最佳化。</p>

<div class="PROCEDURE">
<ol type="1">
<li class="STEP">
<p><b>設定 boot loader 參數</b></p>

<p>最重要的步驟乃是藉由調降 <code class="OPTION">kern.hz</code> 來降低 <b
class="APPLICATION">Parallels</b> 環境內 FreeBSD 的 CPU 佔用率。 可以在 <tt
class="FILENAME">/boot/loader.conf</tt> 內加上下列設定即可：</p>

<pre class="PROGRAMLISTING">
kern.hz=100
</pre>

<p>若不作這設定，那麼光是 idle 狀態的 FreeBSD (<b class="APPLICATION">Parallels</b> guest
OS) 就會在僅單一處理器的 <span class="TRADEMARK">iMac</span>&reg; 上佔了大約 15% 的 CPU
佔用率。 作上述修改之後，佔用率就會降至大約 5%。</p>
</li>

<li class="STEP">
<p><b>設定新的 kernel 設定檔</b></p>

<p>可以放心把所有 SCSI、FireWire、USB 相關設備都移除。 <b
class="APPLICATION">Parallels</b> 有提供 <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ed&amp;sektion=4"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ed</span>(4)</span></a>
的虛擬網卡，因此，除了 <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ed&amp;sektion=4"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ed</span>(4)</span></a> 以及 <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=miibus&amp;sektion=4"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">miibus</span>(4)</span></a>
以外的其他網路卡也都可以從 kernel 中移除。</p>
</li>

<li class="STEP">
<p><b>設定網路</b></p>

<p>可以替虛擬機器簡單用 DHCP 來設定與 <span class="TRADEMARK">Mac</span> 相同的 LAN
網路環境，只要在 <tt class="FILENAME">/etc/rc.conf</tt> 內加上 <tt
class="LITERAL">ifconfig_ed0="DHCP"</tt> 即可完成。 其他進階的網路設定方式，請參考 <a
href="advanced-networking.html">Chapter 29</a>。</p>
</li>
</ol>
</div>
</div>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="VIRTUALIZATION-GUEST-XEN" name="VIRTUALIZATION-GUEST-XEN">21.2.2
在 Linux 透過 <span class="TRADEMARK">Xen</span>&#8482; 跑 FreeBSD</a></h2>

<i class="AUTHORGROUP"><span class="CONTRIB">Contributed by</span> Fukang Chen
(Loader).</i> 

<p><b class="APPLICATION"><span class="TRADEMARK">Xen</span>&#8482;</b> hypervisor
乃是開放源碼的 paravirtualization 產品，並由商業公司(XenSource)提供支援。 Guest OS
通常被稱為 domU domains，而 host OS 則是被稱為 dom0。 在 Linux 上建立 FreeBSD
虛擬機器的第一步，則是安裝 Linux dom0 的 <b class="APPLICATION"><span
class="TRADEMARK">Xen</span></b>。 在本例中， host OS 乃是 Slackware Linux。</p>

<div class="SECT3">
<h3 class="SECT3"><a id="XEN-SLACKWARE-DOM0" name="XEN-SLACKWARE-DOM0">21.2.2.1 在 Linux
dom0 上設定 <span class="TRADEMARK">Xen</span> 3</a></h3>

<div class="PROCEDURE">
<ol type="1">
<li class="STEP">
<p><b>從 XenSource 網站下載 <span class="TRADEMARK">Xen</span> 3.0</b></p>

<p>從 <a href="http://www.xensource.com/" target="_top">http://www.xensource.com/</a>
下載 <a
href="http://bits.xensource.com/oss-xen/release/3.0.4-1/src.tgz/xen-3.0.4_1-src.tgz"
target="_top">xen-3.0.4_1-src.tgz</a>。</p>
</li>

<li class="STEP">
<p><b>解壓縮</b></p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd xen-3.0.4_1-src</kbd>
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">KERNELS="linux-2.6-xen0 linux-2.6-xenU" make world</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make install</kbd>
</pre>

<div class="NOTE">
<blockquote class="NOTE">
<p><b>Note:</b> 為 dom0 重新編譯 kernel：</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">cd xen-3.0.4_1-src/linux-2.6.16.33-xen0</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make menuconfig</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make install</kbd>
</pre>

<p>舊版的 <b class="APPLICATION"><span class="TRADEMARK">Xen</span></b> 可能需要用 <tt
class="COMMAND">make ARCH=xen menuconfig</tt></p>
</blockquote>
</div>
</li>

<li class="STEP">
<p><b>增加選項到 Grub 的 menu.lst 選單</b></p>

<p>修改 <tt class="FILENAME">/boot/grub/menu.lst</tt> 加上下列設定：</p>

<pre class="PROGRAMLISTING">
title Xen-3.0.4
root (hd0,0)
kernel /boot/xen-3.0.4-1.gz dom0_mem=262144
module /boot/vmlinuz-2.6.16.33-xen0 root=/dev/hda1 ro
</pre>
</li>

<li class="STEP">
<p><b>重開機並進入 <span class="TRADEMARK">Xen</span></b></p>

<p>首先，修改 <tt class="FILENAME">/etc/xen/xend-config.sxp</tt> 加上下列設定：</p>

<pre class="PROGRAMLISTING">
(network-script 'network-bridge netdev=eth0')
</pre>

<p>接下來，就可以啟動 <b class="APPLICATION"><span class="TRADEMARK">Xen</span></b>：</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">/etc/init.d/xend start</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">/etc/init.d/xendomains start</kbd>
</pre>

<p>現在 dom0 已經開始運作：</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">xm list</kbd>
Name                                      ID   Mem VCPUs      State   Time(s)
Domain-0                                   0   256     1     r-----  54452.9
</pre>
</li>
</ol>
</div>
</div>

<div class="SECT3">
<h3 class="SECT3"><a id="AEN27564" name="AEN27564">21.2.2.2 FreeBSD 7-CURRENT
domU</a></h3>

<p>從 <a href="http://www.fsmware.com/" target="_top">http://www.fsmware.com/</a>
下載搭配 <b class="APPLICATION"><span class="TRADEMARK">Xen</span> 3.0</b> 的 FreeBSD
domU kernel 相關檔案</p>

<ul>
<li>
<p><a href="http://www.fsmware.com/xenofreebsd/7.0/download/kernel-current"
target="_top">kernel-current</a></p>
</li>

<li>
<p><a href="http://www.fsmware.com/xenofreebsd/7.0/download/mdroot-7.0.bz2"
target="_top">mdroot-7.0.bz2</a></p>
</li>

<li>
<p><a href="http://www.fsmware.com/xenofreebsd/7.0/download/config/xmexample1.bsd"
target="_top">xmexample1.bsd</a></p>
</li>
</ul>

<p>把 <tt class="FILENAME">xmexample1.bsd</tt> 設定檔放到 <tt
class="FILENAME">/etc/xen/</tt>，並修改 kernel 及 disk image 相關位置。
以下是示範的例子：</p>

<pre class="PROGRAMLISTING">
kernel = "/opt/kernel-current"
memory = 256
name = "freebsd"
vif = [ '' ]
disk = [ 'file:/opt/mdroot-7.0,hda1,w' ]
#on_crash    = 'preserve'
extra = "boot_verbose"
extra += ",boot_single"
extra += ",kern.hz=100"
extra += ",vfs.root.mountfrom=ufs:/dev/xbd769a"
</pre>

<p>其中 <tt class="FILENAME">mdroot-7.0.bz2</tt> 檔要記得解壓縮之。</p>

<p>接下來，要修改 <tt class="FILENAME">kernel-current</tt> 設定檔的 __xen_guest
小節，並加上 <b class="APPLICATION"><span class="TRADEMARK">Xen</span> 3.0.3</b> 所需的
VIRT_BASE：</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">objcopy kernel-current -R __xen_guest</kbd>
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">perl -e 'print "LOADER=generic,GUEST_OS=freebsd,GUEST_VER=7.0,XEN_VER=xen-3.0,BSD_SYMTAB,VIRT_BASE=0xC0000000\x00"' &gt; tmp</kbd>
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">objcopy kernel-current --add-section __xen_guest=tmp</kbd>
</pre>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">objdump -j __xen_guest -s kernel-current</kbd>

kernel-current:     file format elf32-i386

Contents of section __xen_guest:
 0000 4c4f4144 45523d67 656e6572 69632c47  LOADER=generic,G
 0010 55455354 5f4f533d 66726565 6273642c  UEST_OS=freebsd,
 0020 47554553 545f5645 523d372e 302c5845  GUEST_VER=7.0,XE
 0030 4e5f5645 523d7865 6e2d332e 302c4253  N_VER=xen-3.0,BS
 0040 445f5359 4d544142 2c564952 545f4241  D_SYMTAB,VIRT_BA
 0050 53453d30 78433030 30303030 3000      SE=0xC0000000.
</pre>

<p>現在可以新增並啟動 domU 囉：</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">xm create /etc/xen/xmexample1.bsd -c</kbd>
Using config file "/etc/xen/xmexample1.bsd".
Started domain freebsd
WARNING: loader(8) metadata is missing!
Copyright (c) 1992-2006 The FreeBSD Project.
Copyright (c) 1979, 1980, 1983, 1986, 1988, 1989, 1991, 1992, 1993, 1994
The Regents of the University of California. All rights reserved.
FreeBSD 7.0-CURRENT #113: Wed Jan  4 06:25:43 UTC 2006
    kmacy@freebsd7.gateway.2wire.net:/usr/home/kmacy/p4/freebsd7_xen3/src/sys/i386-xen/compile/XENCONF
WARNING: DIAGNOSTIC option enabled, expect reduced performance.
Xen reported: 1796.927 MHz processor.
Timecounter "ixen" frequency 1796927000 Hz quality 0
CPU: Intel(R) Pentium(R) 4 CPU 1.80GHz (1796.93-MHz 686-class CPU)
  Origin = "GenuineIntel"  Id = 0xf29  Stepping = 9
  Features=0xbfebfbff&lt;FPU,VME,DE,PSE,TSC,MSR,PAE,MCE,CX8,APIC,SEP,MTRR,PGE,MCA,CMOV,PAT,PSE36,CLFLUSH,
  DTS,ACPI,MMX,FXSR,SSE,SSE2,SS,HTT,TM,PBE&gt;
  Features2=0x4400&lt;CNTX-ID,&lt;b14&gt;&gt;
real memory  = 265244672 (252 MB)
avail memory = 255963136 (244 MB)
xc0: &lt;Xen Console&gt; on motherboard
cpu0 on motherboard
Timecounters tick every 10.000 msec
[XEN] Initialising virtual ethernet driver.
xn0: Ethernet address: 00:16:3e:6b:de:3a
[XEN] 
Trying to mount root from ufs:/dev/xbd769a
WARNING: / was not properly dismounted
Loading configuration files.
No suitable dump device was found.
Entropy harvesting: interrupts ethernet point_to_point kickstart.
Starting file system checks:
/dev/xbd769a: 18859 files, 140370 used, 113473 free (10769 frags, 12838 blocks, 4.2% fragmentation)
Setting hostname: demo.freebsd.org.
lo0: flags=8049&lt;UP,LOOPBACK,RUNNING,MULTICAST&gt; mtu 16384
      inet6 ::1 prefixlen 128 
      inet6 fe80::1%lo0 prefixlen 64 scopeid 0x2 
      inet 127.0.0.1 netmask 0xff000000 
Additional routing options:.
Mounting NFS file systems:.
Starting syslogd.
/etc/rc: WARNING: Dump device does not exist.  Savecore not run.
ELF ldconfig path: /lib /usr/lib /usr/lib/compat /usr/X11R6/lib /usr/local/lib
a.out ldconfig path: /usr/lib/aout /usr/lib/compat/aout /usr/X11R6/lib/aout
Starting usbd.
usb: Kernel module not available: No such file or directory
Starting local daemons:.
Updating motd.
Starting sshd.
Initial i386 initialization:.
Additional ABI support: linux.
Starting cron.
Local package initialization:.
Additional TCP options:.
Starting background file system checks in 60 seconds.

Sun Apr  1 02:11:43 UTC 2007

FreeBSD/i386 (demo.freebsd.org) (xc0)

login:
</pre>

<p>現在 domU 應該可以跑 FreeBSD&nbsp;7.0-CURRENT kernel：</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">uname -a</kbd>
FreeBSD demo.freebsd.org 7.0-CURRENT FreeBSD 7.0-CURRENT #113: Wed Jan  4 06:25:43 UTC 2006     
kmacy@freebsd7.gateway.2wire.net:/usr/home/kmacy/p4/freebsd7_xen3/src/sys/i386-xen/compile/XENCONF  i386
</pre>

<p>接下來是設定 domU 的網路，FreeBSD domU 會用代號為 <tt class="DEVICENAME">xn0</tt>
的特殊網路卡：</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">ifconfig xn0 10.10.10.200 netmask 255.0.0.0</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">ifconfig</kbd>
xn0: flags=843&lt;UP,BROADCAST,RUNNING,SIMPLEX&gt; mtu 1500
    inet 10.10.10.200 netmask 0xff000000 broadcast 10.255.255.255
    ether 00:16:3e:6b:de:3a
lo0: flags=8049&lt;UP,LOOPBACK,RUNNING,MULTICAST&gt; mtu 16384
      inet6 ::1 prefixlen 128 
      inet6 fe80::1%lo0 prefixlen 64 scopeid 0x2 
      inet 127.0.0.1 netmask 0xff000000
</pre>

<p>在 dom0 Slackware 上應該會出現一些 <b class="APPLICATION"><span
class="TRADEMARK">Xen</span></b> 專用的網路卡：</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">ifconfig</kbd>
eth0      Link encap:Ethernet  HWaddr 00:07:E9:A0:02:C2  
          inet addr:10.10.10.130  Bcast:0.0.0.0  Mask:255.0.0.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:815 errors:0 dropped:0 overruns:0 frame:0
          TX packets:1400 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:204857 (200.0 KiB)  TX bytes:129915 (126.8 KiB)

lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          UP LOOPBACK RUNNING  MTU:16436  Metric:1
          RX packets:99 errors:0 dropped:0 overruns:0 frame:0
          TX packets:99 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:9744 (9.5 KiB)  TX bytes:9744 (9.5 KiB)

peth0     Link encap:Ethernet  HWaddr FE:FF:FF:FF:FF:FF  
          UP BROADCAST RUNNING NOARP  MTU:1500  Metric:1
          RX packets:1853349 errors:0 dropped:0 overruns:0 frame:0
          TX packets:952923 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:2432115831 (2.2 GiB)  TX bytes:86528526 (82.5 MiB)
          Base address:0xc000 Memory:ef020000-ef040000 

vif0.1    Link encap:Ethernet  HWaddr FE:FF:FF:FF:FF:FF  
          UP BROADCAST RUNNING NOARP  MTU:1500  Metric:1
          RX packets:1400 errors:0 dropped:0 overruns:0 frame:0
          TX packets:815 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:129915 (126.8 KiB)  TX bytes:204857 (200.0 KiB)

vif1.0    Link encap:Ethernet  HWaddr FE:FF:FF:FF:FF:FF  
          UP BROADCAST RUNNING NOARP  MTU:1500  Metric:1
          RX packets:3 errors:0 dropped:0 overruns:0 frame:0
          TX packets:2 errors:0 dropped:157 overruns:0 carrier:0
          collisions:0 txqueuelen:1 
          RX bytes:140 (140.0 b)  TX bytes:158 (158.0 b)

xenbr1    Link encap:Ethernet  HWaddr FE:FF:FF:FF:FF:FF  
          UP BROADCAST RUNNING NOARP  MTU:1500  Metric:1
          RX packets:4 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:112 (112.0 b)  TX bytes:0 (0.0 b)
</pre>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">brctl show</kbd>
bridge name     bridge id           STP enabled         interfaces
xenbr1          8000.feffffffffff   no                  vif0.1
                                                        peth0
                                                        vif1.0
</pre>
</div>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="VIRTUALIZATION-GUEST-VIRTUALPC"
name="VIRTUALIZATION-GUEST-VIRTUALPC">21.2.3 <span class="TRADEMARK">Windows</span>&reg;
上的 Virtual PC</a></h2>

<p><b class="APPLICATION">Virtual PC</b> 是 <span class="TRADEMARK">Microsoft</span>&reg;
的 <span class="TRADEMARK">Windows</span>&reg; 軟體產品，可以免費下載使用。
相關系統需求，請參閱 <a
href="http://www.microsoft.com/windows/downloads/virtualpc/sysreq.mspx"
target="_top">system requirements</a> 說明。 在 <span
class="TRADEMARK">Microsoft</span>&nbsp;<span class="TRADEMARK">Windows</span> 裝完 <b
class="APPLICATION">Virtual PC</b> 之後， 必須針對所欲安裝的虛擬機器來作相關設定。</p>

<div class="SECT3">
<h3 class="SECT3"><a id="VIRTUALIZATION-GUEST-VIRTUALPC-INSTALL"
name="VIRTUALIZATION-GUEST-VIRTUALPC-INSTALL">21.2.3.1 在 Virtual PC/<span
class="TRADEMARK">Microsoft</span>&reg;&nbsp;<span class="TRADEMARK">Windows</span>
上安裝 FreeBSD</a></h3>

<p>在 <span class="TRADEMARK">Microsoft</span>&nbsp;<span
class="TRADEMARK">Windows</span>/<b class="APPLICATION">Virtual PC</b> 上安裝 FreeBSD
的第一步是新增虛擬機器。 如下所示， 在提示視窗內請選擇 <span class="GUIMENUITEM">Create a
virtual machine</span>：</p>

<p><img src="virtualization/virtualpc-freebsd1.png" /></p>

<p><img src="virtualization/virtualpc-freebsd2.png" /></p>

<p>然後在 <span class="GUIMENUITEM">Operating system</span> 處選 <span
class="GUIMENUITEM">Other</span>：</p>

<p><img src="virtualization/virtualpc-freebsd3.png" /></p>

<p>並依據自身需求來規劃硬碟容量跟記憶體的分配。 對大多數在 <b class="APPLICATION">Virtual
PC</b> 使用 FreeBSD 的情況而言，大約 4GB 硬碟空間以及 512MB RAM 就夠用了：</p>

<p><img src="virtualization/virtualpc-freebsd4.png" /></p>

<p><img src="virtualization/virtualpc-freebsd5.png" /></p>

<p>儲存設定檔：</p>

<p><img src="virtualization/virtualpc-freebsd6.png" /></p>

<p>接下來選剛剛所新增的 FreeBSD 虛擬機器，並按下 <span
class="GUIMENU">Settings</span>，以設定網路種類以及網路卡：</p>

<p><img src="virtualization/virtualpc-freebsd7.png" /></p>

<p><img src="virtualization/virtualpc-freebsd8.png" /></p>

<p>在 FreeBSD 虛擬機器新增後，就可以繼續以其安裝 FreeBSD。
安裝方面，比較好的作法是使用官方的 FreeBSD 光碟或者從官方 FTP 站下載 ISO image 檔。
若您的 <span class="TRADEMARK">Windows</span> 檔案系統內已經有該 ISO 檔，
或者光碟機內有放安裝片，那麼就可以在 FreeBSD 虛擬機器上連按兩下，以開始啟動。 接著在 <b
class="APPLICATION">Virtual PC</b> 視窗內按 <span class="GUIMENU">CD</span> 再按 <span
class="GUIMENU">Capture ISO Image...</span> 。
接著會出現一個視窗，可以把虛擬機器內的光碟機設定到該 ISO 檔， 或者是實體光碟機。</p>

<p><img src="virtualization/virtualpc-freebsd9.png" /></p>

<p><img src="virtualization/virtualpc-freebsd10.png" /></p>

<p>設好光碟片來源之後，就可以重開機，也就是先按 <span class="GUIMENU">Action</span> 再按
<span class="GUIMENU">Reset</span> 即可。 <b class="APPLICATION">Virtual PC</b> 會以特殊
BIOS 開機，並與普通 BIOS 一樣會先檢查是否有光碟機。</p>

<p><img src="virtualization/virtualpc-freebsd11.png" /></p>

<p>此時，它就會找到 FreeBSD 安裝片，並開始在 <a href="install.html">Chapter 2</a>
內所介紹到的 <b class="APPLICATION">sysinstall</b> 安裝過程。 這時候也可順便裝
X11，但先不要進行相關設定。</p>

<p><img src="virtualization/virtualpc-freebsd12.png" /></p>

<p>完成安裝之後，記得把光碟片退出或者 ISO image 退片。 最後， 把裝好的 FreeBSD
虛擬機器重開機即可。</p>

<p><img src="virtualization/virtualpc-freebsd13.png" /></p>
</div>

<div class="SECT3">
<h3 class="SECT3"><a id="VIRTUALIZATION-GUEST-VIRTUALPC-CONFIGURE"
name="VIRTUALIZATION-GUEST-VIRTUALPC-CONFIGURE">21.2.3.2 調整 <span
class="TRADEMARK">Microsoft</span>&nbsp;<span class="TRADEMARK">Windows</span>/Virtual PC
上的 FreeBSD</a></h3>

<p>在 <span class="TRADEMARK">Microsoft</span>&nbsp;<span
class="TRADEMARK">Windows</span> 上以 <b class="APPLICATION">Virtual PC</b> 裝好 FreeBSD
後，還需要作一些設定步驟， 以便將虛擬機器內的 FreeBSD 最佳化。</p>

<div class="PROCEDURE">
<ol type="1">
<li class="STEP">
<p><b>設定 boot loader 參數</b></p>

<p>最重要的步驟乃是藉由調降 <code class="OPTION">kern.hz</code> 來降低 <b
class="APPLICATION">Virtual PC</b> 環境內 FreeBSD 的 CPU 佔用率。 可以在 <tt
class="FILENAME">/boot/loader.conf</tt> 內加上下列設定即可：</p>

<pre class="PROGRAMLISTING">
kern.hz=100
</pre>

<p>若不作這設定，那麼光是 idle 狀態的 FreeBSD <b class="APPLICATION">Virtual PC</b> guest
OS 就會在僅單一處理器的電腦上佔了大約 40% 的 CPU 佔用率。
作上述修改之後，佔用率就會降至大約 3%。</p>
</li>

<li class="STEP">
<p><b>設定新的 kernel 設定檔</b></p>

<p>可以放心把所有 SCSI、FireWire、USB 相關設備都移除。 <b class="APPLICATION">Virtual
PC</b> 有提供 <a href="http://www.FreeBSD.org/cgi/man.cgi?query=de&amp;sektion=4"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">de</span>(4)</span></a>
的虛擬網卡，因此除了 <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=de&amp;sektion=4"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">de</span>(4)</span></a> 以及 <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=miibus&amp;sektion=4"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">miibus</span>(4)</span></a>
以外的其他網路卡也都可以從 kernel 中移除。</p>
</li>

<li class="STEP">
<p><b>設定網路</b></p>

<p>可以替虛擬機器簡單用 DHCP 來設定與 host(<span
class="TRADEMARK">Microsoft</span>&nbsp;<span class="TRADEMARK">Windows</span>) 相同的
LAN 網路環境，只要在 <tt class="FILENAME">/etc/rc.conf</tt> 加上 <tt
class="LITERAL">ifconfig_de0="DHCP"</tt> 即可完成。 其他進階的網路設定方式，請參閱 <a
href="advanced-networking.html">Chapter 29</a>。</p>
</li>
</ol>
</div>
</div>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="VIRTUALIZATION-GUEST-VMWARE"
name="VIRTUALIZATION-GUEST-VMWARE">21.2.4 在 MacOS 上的 VMware</a></h2>

<p><span class="TRADEMARK">Mac</span> 上的 <b class="APPLICATION">VMWare Fusion</b>
乃是可用於搭配 <span class="TRADEMARK">Intel</span> CPU 以及 <span
class="TRADEMARK">Mac&nbsp;OS</span> 10.4.9 之 <span class="TRADEMARK">Apple</span> <span
class="TRADEMARK">Mac</span> 以上的 <span class="TRADEMARK">Apple</span> <span
class="TRADEMARK">Mac</span> 電腦之商業軟體。 FreeBSD 是其有完整支援的 guest OS 之一。 在
<span class="TRADEMARK">Mac&nbsp;OS</span> X 上裝完 <b class="APPLICATION">VMWare
Fusion</b> 之後， 必須針對所欲安裝的 guest OS 來作相關的虛擬機器設定。</p>

<div class="SECT3">
<h3 class="SECT3"><a id="VIRTUALIZATION-GUEST-VMWARE-INSTALL"
name="VIRTUALIZATION-GUEST-VMWARE-INSTALL">21.2.4.1 在 VMWare/<span
class="TRADEMARK">Mac&nbsp;OS</span> X 上安裝 FreeBSD</a></h3>

<p>首先執行 VMWare Fusion，而其 Virtual Machine Library 也會隨之一併載入，這時請按 "New"
來建立 VM(虛擬機器)：</p>

<p><img src="virtualization/vmware-freebsd01.png" /></p>

<p>接著會有 New Virtual Machine Assistant 來協助您建立 VM，請按 Continue 繼續：</p>

<p><img src="virtualization/vmware-freebsd02.png" /></p>

<p>在 <span class="GUIMENUITEM">Operating System</span> 選 <span
class="GUIMENUITEM">Other</span>，以及 <span class="GUIMENU">Version</span>
處請選擇是否要 <span class="GUIMENUITEM">FreeBSD</span> 或 <span
class="GUIMENUITEM">FreeBSD 64-bit</span>，這部份請依自身需求是否有要 64-bit
支援而定：</p>

<p><img src="virtualization/vmware-freebsd03.png" /></p>

<p>接著設定 VM image 檔要存到何處，以及決定名稱：</p>

<p><img src="virtualization/vmware-freebsd04.png" /></p>

<p>決定該 VM 的虛擬硬碟要用多大：</p>

<p><img src="virtualization/vmware-freebsd05.png" /></p>

<p>選擇要裝 VM 的方式為何，要用 ISO image 檔或者光碟機：</p>

<p><img src="virtualization/vmware-freebsd06.png" /></p>

<p>按 Finish 以完畢，接著就會啟動該 VM：</p>

<p><img src="virtualization/vmware-freebsd07.png" /></p>

<p>接著就照以往安裝 FreeBSD 的方式來裝，若不熟的話請參閱 <a href="install.html">Chapter
2</a>：</p>

<p><img src="virtualization/vmware-freebsd08.png" /></p>

<p>裝完之後，就可以修改一些 VM 設定，像是記憶體大小：</p>

<div class="NOTE">
<blockquote class="NOTE">
<p><b>Note:</b> VM 在運作之時，不能修改 VM 的硬體設定。</p>
</blockquote>
</div>

<p><img src="virtualization/vmware-freebsd09.png" /></p>

<p>調整 VM 的 CPU 數量：</p>

<p><img src="virtualization/vmware-freebsd10.png" /></p>

<p>光碟機狀態，通常不再需要用的時候，就可以切斷其與 VM 的連接：</p>

<p><img src="virtualization/vmware-freebsd11.png" /></p>

<p>最後要改的則是 VM 的網路設定。 若除了 Host OS 之外的機器也能連到 VM，那麼請選 <span
class="GUIMENUITEM">Connect directly to the physical network (Bridged)</span>，否則就選
<span class="GUIMENUITEM">Share the host's internet connection (NAT)</span> 即可讓 VM
連到 Internet， 但外面則無法連入該 VM。</p>

<p><img src="virtualization/vmware-freebsd12.png" /></p>

<p>改完上述設定之後，就可以啟動新裝妥的 FreeBSD 虛擬機器。</p>
</div>

<div class="SECT3">
<h3 class="SECT3"><a id="VIRTUALIZATION-GUEST-VMWARE-CONFIGURE"
name="VIRTUALIZATION-GUEST-VMWARE-CONFIGURE">21.2.4.2 調整 <span
class="TRADEMARK">Mac&nbsp;OS</span> X/VMWare 上的 FreeBSD</a></h3>

<p>把 FreeBSD 成功裝到 <span class="TRADEMARK">Mac&nbsp;OS</span> X 的 <b
class="APPLICATION">VMWare</b> 之後，還需要作一些設定步驟， 以便將虛擬機器內的 FreeBSD
最佳化。</p>

<div class="PROCEDURE">
<ol type="1">
<li class="STEP">
<p><b>設定 boot loader 參數</b></p>

<p>最重要的步驟乃是藉由調降 <code class="OPTION">kern.hz</code> 來降低 <b
class="APPLICATION">VMWare</b> 環境內 FreeBSD 的 CPU 佔用率。 可以在 <tt
class="FILENAME">/boot/loader.conf</tt> 內加上下列設定即可：</p>

<pre class="PROGRAMLISTING">
kern.hz=100
</pre>

<p>若不作這設定，那麼光是 idle 狀態的 FreeBSD (<b class="APPLICATION">VMWare</b> guest
OS) 就會在僅單一處理器的 <span class="TRADEMARK">iMac</span> 上佔了大約 15% 的 CPU
佔用率。 作上述修改之後， 佔用率就會降至大約 5%。</p>
</li>

<li class="STEP">
<p><b>設定新的 kernel 設定檔</b></p>

<p>可以放心把所有 FireWire、USB 相關設備都移除。 <b class="APPLICATION">VMWare</b> 有提供
<a href="http://www.FreeBSD.org/cgi/man.cgi?query=em&amp;sektion=4"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">em</span>(4)</span></a> 的虛擬網卡，
因此，除了 <a href="http://www.FreeBSD.org/cgi/man.cgi?query=em&amp;sektion=4"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">em</span>(4)</span></a> 以及 <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=miibus&amp;sektion=4"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">miibus</span>(4)</span></a>
以外的其他網路卡， 也都可以從 kernel 中移除。</p>
</li>

<li class="STEP">
<p><b>設定網路</b></p>

<p>可以替虛擬機器簡單用 DHCP 來設定與 host <span class="TRADEMARK">Mac</span> 相同的 LAN
網路環境，只要在 <tt class="FILENAME">/etc/rc.conf</tt> 加上 <tt
class="LITERAL">ifconfig_em0="DHCP"</tt> 即可。 其他進階的網路設定方式，請參考 <a
href="advanced-networking.html">Chapter 29</a>。</p>
</li>
</ol>
</div>
</div>
</div>
</div>

<div class="NAVFOOTER">
<hr align="LEFT" width="100%" />
<table summary="Footer navigation table" width="100%" border="0" cellpadding="0"
cellspacing="0">
<tr>
<td width="33%" align="left" valign="top"><a href="virtualization.html"
accesskey="P">Prev</a></td>
<td width="34%" align="center" valign="top"><a href="index.html"
accesskey="H">Home</a></td>
<td width="33%" align="right" valign="top"><a href="virtualization-host.html"
accesskey="N">Next</a></td>
</tr>

<tr>
<td width="33%" align="left" valign="top">Virtualization(虛擬機器)</td>
<td width="34%" align="center" valign="top"><a href="virtualization.html"
accesskey="U">Up</a></td>
<td width="33%" align="right" valign="top">以 FreeBSD 為 Host OS</td>
</tr>
</table>
</div>

<p align="center"><small>本文及其他文件，可由此下載：<a
href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>。</small></p>

<p align="center"><small>若有 FreeBSD 方面疑問，請先閱讀 <a
href="http://www.FreeBSD.org/docs.html">FreeBSD 相關文件</a>，如不能解決的話，再洽詢
&#60;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&#62;。<br />
關於本文件的問題，請洽詢 &#60;<a
href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&#62;。</small></p>
</body>
</html>

