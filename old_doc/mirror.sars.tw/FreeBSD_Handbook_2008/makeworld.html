<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="generator" content="HTML Tidy, see www.w3.org" />
<title>重新編譯 world</title>
<meta name="GENERATOR" content="Modular DocBook HTML Stylesheet Version 1.79" />
<link rel="HOME" title="FreeBSD 使用手冊" href="index.html" />
<link rel="UP" title="更新、升級 FreeBSD" href="cutting-edge.html" />
<link rel="PREVIOUS" title="更新你的 Source" href="synching.html" />
<link rel="NEXT" title="Tracking for Multiple Machines" href="small-lan.html" />
<link rel="STYLESHEET" type="text/css" href="docbook.css" />
<meta http-equiv="Content-Type" content="text/html; charset=Big5" />
</head>
<body class="SECT1" bgcolor="#FFFFFF" text="#000000" link="#0000FF" vlink="#840084"
alink="#0000FF">
<div class="NAVHEADER">
<table summary="Header navigation table" width="100%" border="0" cellpadding="0"
cellspacing="0">
<tr>
<th colspan="3" align="center">FreeBSD 使用手冊</th>
</tr>

<tr>
<td width="10%" align="left" valign="bottom"><a href="synching.html"
accesskey="P">Prev</a></td>
<td width="80%" align="center" valign="bottom">Chapter 23 更新、升級 FreeBSD</td>
<td width="10%" align="right" valign="bottom"><a href="small-lan.html"
accesskey="N">Next</a></td>
</tr>
</table>

<hr align="LEFT" width="100%" />
</div>

<div class="SECT1">
<h1 class="SECT1"><a id="MAKEWORLD" name="MAKEWORLD">23.4 重新編譯 “world”</a></h1>

<p>在更新 FreeBSD 的 source tree 到最新之後(無論是 FreeBSD-STABLE、 FreeBSD-CURRENT
等等)，接下來就可以用這些 source tree 來重新編譯系統 。</p>

<div class="WARNING">
<blockquote class="WARNING">
<p><b>做好備份:</b> 在作任何大動作 <span class="emphasis"><b
class="EMPHASIS">之前</b></span> 要記得先把系統作備份的重要性無須強調。 儘管重新編譯
world 是 (只要有照文件指示去作的話)一件很簡單的事情，但出錯也是在所難免的。 另外，別人在
source tree 不慎搞混的錯誤，也可能會造成系統無法開機 。</p>

<p>請確認自己已作妥相關備份，並且手邊有 fixit 磁片或開機光碟。
您可能永遠也用不到這些東西， 但安全第一總比事後說抱歉來得好吧！</p>
</blockquote>
</div>

<div class="WARNING">
<blockquote class="WARNING">
<p><b>訂閱相關的 Mailing List:</b> FreeBSD-STABLE 以及 FreeBSD-CURRENT
分支，本質上就是屬於 <span class="emphasis"><b class="EMPHASIS">開發階段</b></span>。 為
FreeBSD 作貢獻的也都是人，偶爾也會犯錯誤。</p>

<p>有時候這些錯誤並無大礙，只是會讓系統產生新的錯誤警告而已。
有時則是災難，可能會導致不能開機或檔案系統的毀損(或更糟)。</p>

<p>若遇到類似問題，貼封標題為 “heads up(注意)” 開頭的信到相關的 mailing
list，並講清楚問題點以及會影響哪些系統。 在問題獲解決後，再貼標題為 “all clear(已解決)”
開頭的聲明信。</p>

<p>若用的是 FreeBSD-STABLE 或 FreeBSD-CURRENT，卻又不閱讀 <a
href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-stable"
target="_top">FreeBSD-STABLE 郵遞論壇</a> 或 <a
href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-current"
target="_top">FreeBSD-CURRENT 郵遞論壇</a> 的討論，那麼會是自找麻煩而已。</p>
</blockquote>
</div>

<div class="WARNING">
<blockquote class="WARNING">
<p><b>不要用 <tt class="COMMAND">make world</tt>:</b> 一堆早期的舊文件都會建議說使用 <tt
class="COMMAND">make world</tt>。
這樣做會跳過一些重要步驟，建議只有在你知道自己在作什麼，再這麼做。
在絕大多數的情況下，請不要亂用 <tt class="COMMAND">make world</tt>，
而該改用下面介紹的方式。</p>
</blockquote>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN28790" name="AEN28790">23.4.1 更新系統的標準方式</a></h2>

<p>要升級系統前，一定要先查閱 <tt class="FILENAME">/usr/src/UPDATING</tt> 文件，以瞭解
buildworld 之前需要作哪些事情或注意事項， 然後才用下列步驟：</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make buildworld</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make buildkernel</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make installkernel</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">reboot</kbd>
</pre>

<div class="NOTE">
<blockquote class="NOTE">
<p><b>Note:</b> 在少數狀況，可能需要先在 <tt class="MAKETARGET">buildworld</tt>
步驟之前先作 <tt class="COMMAND">mergemaster -p</tt> 才能完成。
至於何時需要或不需要，請參閱 <tt class="FILENAME">UPDATING</tt> 內的說明。
一般來說，只要不是進行跨版號(major)的 FreeBSD 版本升級， 就可略過這步驟。</p>
</blockquote>
</div>

<p>完成 <tt class="MAKETARGET">installkernel</tt> 之後，需要重開機並切到 single user
模式(舉例：也可以在 loader 提示符號後面加上 <tt class="COMMAND">boot -s</tt>)。
接下來執行：</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">mergemaster -p</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make installworld</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">mergemaster</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">reboot</kbd>
</pre>

<div class="WARNING">
<blockquote class="WARNING">
<p><b>Read Further Explanations:</b>
上述步驟只是協助您升級的簡單說明而已，若要清楚瞭解每一步驟， 尤其是若欲自行打造 kernel
設定，就更該閱讀下面的內容。</p>
</blockquote>
</div>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN28823" name="AEN28823">23.4.2 閱讀 <tt
class="FILENAME">/usr/src/UPDATING</tt></a></h2>

<p>在作任何事情之前，請務必先閱讀 <tt class="FILENAME">/usr/src/UPDATING</tt> (或在
source code 內類似的文件) 。
這份文件會寫到可能遭遇的問題，或指定那些會執行的指令順序為何。 如果你機器現在的 <tt
class="FILENAME">UPDATING</tt> 文件與這邊的描述有衝突、矛盾之處，那麼請以機器上的 <tt
class="FILENAME">UPDATING</tt> 為準。</p>

<div class="IMPORTANT">
<blockquote class="IMPORTANT">
<p><b>Important:</b> 然而，如同先前所述，單單只靠閱讀 <tt class="FILENAME">UPDATING</tt>
並不能完全取代 mailing list。 這兩者都是互補的，而不相排斥。</p>
</blockquote>
</div>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN28833" name="AEN28833">23.4.3 檢查 <tt
class="FILENAME">/etc/make.conf</tt></a></h2>

<p>檢查 <tt class="FILENAME">/usr/share/examples/etc/make.conf</tt> 以及 <tt
class="FILENAME">/etc/make.conf</tt>。 第一份文件乃是一些系統預設值 -
不過，大部分都被註解起來。 為了在重新編譯時能夠使用這些， 請把這些設定加到 <tt
class="FILENAME">/etc/make.conf</tt>。 請注意在 <tt class="FILENAME">/etc/make.conf</tt>
的任何設定也會影響到每次使用 <tt class="COMMAND">make</tt> 的結果，
因此設定一些適合自己系統的選項會是不錯的作法。</p>

<p>一般使用者通常會從 <tt class="FILENAME">/usr/share/examples/etc/make.conf</tt> 複製
<tt class="MAKEVAR">CFLAGS</tt> 以及 <tt class="MAKEVAR">NO_PROFILE</tt> 之類的設定到 <tt
class="FILENAME">/etc/make.conf</tt>，並解除相關註解印記 。</p>

<p>此外，也可以試試看其他設定 (<tt class="MAKEVAR">COPTFLAGS</tt>、 <tt
class="MAKEVAR">NOPORTDOCS</tt> 等等)，是否符合自己所需。</p>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN28853" name="AEN28853">23.4.4 更新 <tt
class="FILENAME">/etc</tt> 內的設定檔</a></h2>

<p>在 <tt class="FILENAME">/etc</tt> 目錄會有系統的相關設定檔， 以及開機時的各項服務啟動
script。 有些 script 隨 FreeBSD 版本的不同而有些差異。</p>

<p>其中有些設定檔會在每日運作的系統裡也會用到。 尤其是 <tt
class="FILENAME">/etc/group</tt>。</p>

<p>有時候在 <tt class="COMMAND">make installworld</tt> 安裝過程中，
會需要先建立某些特定帳號或群組。 在進行升級之前，它們可能並不存在，
因此升級時就會造成問題。 有時候 <tt class="COMMAND">make buildworld</tt>
會先檢查這些所需的帳號或群組是否已有存在。</p>

<p>舉個這樣的例子，像是某次升級之後必須新增 <tt class="USERNAME">smmsp</tt> 帳號。
若使用者尚未新增該帳號就要完成升級操作的話， 會在 <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=mtree&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">mtree</span>(8)</span></a> 嘗試建立 <tt
class="FILENAME">/var/spool/clientmqueue</tt> 時發生失敗。</p>

<p>解法是在 buildworld 階段之前，先執行 <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">mergemaster</span>(8)</span></a> 並搭配
<code class="OPTION">-p</code> 選項。 它會比對那些執行 <tt
class="MAKETARGET">buildworld</tt> 或 <tt class="MAKETARGET">installworld</tt>
所需之關鍵設定檔。 若你所用的是早期仍未支援 <code class="OPTION">-p</code> 的 <tt
class="COMMAND">mergemaster</tt> 版本，那麼直接使用 source tree 內的新版即可：</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">cd /usr/src/usr.sbin/mergemaster</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">./mergemaster.sh -p</kbd>
</pre>

<div class="TIP">
<blockquote class="TIP">
<p><b>Tip:</b> 若您是偏執狂(paranoid)，
可以像下面這樣去試著檢查系統上有哪些檔案屬於已改名或被刪除的群組 ：</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">find / -group <tt
class="REPLACEABLE"><i>GID</i></tt> -print</kbd>
</pre>

<p>這會顯示所有符合要找的 <tt class="REPLACEABLE"><i>GID</i></tt> 群組
(可以是群組名稱，或者是群組的數字代號)的所有檔案。</p>
</blockquote>
</div>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="MAKEWORLD-SINGLEUSER" name="MAKEWORLD-SINGLEUSER">23.4.5 切換到
Single User 模式</a></h2>

<p>您可能會想在 single user 模式下編譯系統。
除了可以明顯更快完成之外，安裝過程中將會牽涉許多重要的系統檔案， 包括所有系統
binaries、libraries、include 檔案等。
若在運作中的系統(尤其有許多使用者在用的時候)內更改這些檔案， 那簡直是自找麻煩的作法。</p>

<p>另一種模式是先在 multi-user 模式下編譯好系統，然後再切到 single user 模式去安裝。
若您比較喜歡這種方式，只需在 build(編譯過程) 完成之後， 再去執行下面的步驟即可。
一直到可切換 single user 模式時，再去執行 <tt class="MAKETARGET">installkernel</tt> 或
<tt class="MAKETARGET">installworld</tt> 即可。</p>

<p>切換為 root 身份打：</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">shutdown now</kbd>
</pre>

<p>這樣就會從原本的 multi-user 模式切換到 single user 模式。</p>

<p>除此之外也可以重開機，接著在開機選單處選擇 “single user” 選項。 如此一來就會進入
single user 模式， 然後在 shell 提示符號處輸入：</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">fsck -p</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">mount -u /</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">mount -a -t ufs</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">swapon -a</kbd>
</pre>

<p>這樣會先檢查檔案系統，並重新將 <tt class="FILENAME">/</tt> 改以可讀寫的模式掛載，以及
<tt class="FILENAME">/etc/fstab</tt> 內所設定的其他 UFS 檔案系統，最後啟用 swap
磁區。</p>

<div class="NOTE">
<blockquote class="NOTE">
<p><b>Note:</b> 若 CMOS 時鐘是設為當地時間，而非 GMT 時區(若 <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=date&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">date</span>(1)</span></a>
指令沒顯示正確的時間、時區)，那可能需要再輸入下列指令：</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">adjkerntz -i</kbd>
</pre>

<p>這步驟可以確認您的當地時區設定是否正確 —— 否則日後會造成一些問題。</p>
</blockquote>
</div>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN28929" name="AEN28929">23.4.6 移除 <tt
class="FILENAME">/usr/obj</tt></a></h2>

<p>在重新編譯系統的過程中，編譯結果會放到(預設情況) <tt class="FILENAME">/usr/obj</tt>
內。 這裡面的目錄會對應到 <tt class="FILENAME">/usr/src</tt> 的目錄結構。</p>

<p>砍掉這目錄，可以讓以後的 <tt class="COMMAND">make buildworld</tt>
過程更快一些，而且可避免以前編譯的東西跟現在的混淆在一起的相依錯亂 。</p>

<p>而有些 <tt class="FILENAME">/usr/obj</tt> 內的檔案可能會設定不可更動的 flag(細節請參閱
<a href="http://www.FreeBSD.org/cgi/man.cgi?query=chflags&amp;sektion=1"><span
class="CITEREFENTRY"><span
class="REFENTRYTITLE">chflags</span>(1)</span></a>)，而必須先拿掉這些 flag 設定才行
。</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /usr/obj</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">chflags -R noschg *</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">rm -rf *</kbd>
</pre>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="CUTTING-EDGE-COMPILEBASE" name="CUTTING-EDGE-COMPILEBASE">23.4.7
重新編譯 Base System</a></h2>

<div class="SECT3">
<h3 class="SECT3"><a id="AEN28951" name="AEN28951">23.4.7.1 保留編譯的紀錄</a></h3>

<p>建議養成好習慣，把執行 <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">make</span>(1)</span></a>
時產生的紀錄存起來。 這樣若有哪邊出錯，就會有錯誤訊息的紀錄。 雖然單單這樣，
你可能不知道如何分析是哪邊出了岔，但若把你問題記錄貼到 FreeBSD 相關的 mailing list
就可以有人可以幫忙看是怎麼一回事情。</p>

<p>最簡單的方是就是用 <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=script&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">script</span>(1)</span></a>
指令，並加上參數 (你想存放記錄的檔案位置、檔名)即可。
這步驟應該在重新編譯系統時就要作，然後在完成編譯後輸入 <kbd class="USERINPUT">exit</kbd>
即可離開。</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">script /var/tmp/mw.out</kbd>
Script started, output file is /var/tmp/mw.out   
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make TARGET</kbd>
<span class="emphasis"><b
class="EMPHASIS">... compile, compile, compile ...</b></span>     
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">exit</kbd>
Script done, ...
</pre>

<p>對了，還有一點儘量<span class="emphasis"><b class="EMPHASIS">別把</b></span>檔案存到
<tt class="FILENAME">/tmp</tt> 目錄內。 因為重開機之後， 這目錄內的東西都會被清空。
比較妥善的地方是 <tt class="FILENAME">/var/tmp</tt> (如上例所示) 或者是 <tt
class="USERNAME">root</tt> 的家目錄。</p>
</div>

<div class="SECT3">
<h3 class="SECT3"><a id="MAKE-BUILDWORLD" name="MAKE-BUILDWORLD">23.4.7.2 編譯 Base
System</a></h3>

<p>首先請先切換到 <tt class="FILENAME">/usr/src</tt> 目錄：</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /usr/src</kbd>
</pre>

<p>(當然，除非你把 source code 放到其他地方，若真是這樣， 就切換到那個目錄即可)。</p>

<p>使用 <a href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">make</span>(1)</span></a> 指令來重新編譯
world。 這指令會從 <tt class="FILENAME">Makefile</tt> 檔(這檔會寫 FreeBSD
的程式該如何重新編譯、以哪些順序來編譯等等)去讀取相關指令。</p>

<p>一般下指令的格式如下：</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make -<tt
class="REPLACEABLE"><i>x</i></tt> -D<tt class="REPLACEABLE"><i>VARIABLE</i></tt> <tt
class="REPLACEABLE"><i>target</i></tt></kbd>
</pre>

<p>在這個例子，<code class="OPTION">-<tt class="REPLACEABLE"><i>x</i></tt></code>
是你想傳給 <a href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">make</span>(1)</span></a>
的選項，細節說明請參閱 <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">make</span>(1)</span></a> 說明，
裡面有相關範例說明。</p>

<p><code class="OPTION">-D<tt class="REPLACEABLE"><i>VARIABLE</i></tt></code>
則是把變數設定傳給 <tt class="FILENAME">Makefile</tt>。 這些變數會控制 <tt
class="FILENAME">Makefile</tt> 的行為。 這些設定與 <tt
class="FILENAME">/etc/make.conf</tt> 的變數設定是一樣， 只是另一種設定方式而已。</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make -DNO_PROFILE <tt
class="REPLACEABLE"><i>target</i></tt></kbd>
</pre>

<p>上面的例子則是另一種設定方式，也就是哪些不要。 這個例子中的意思是不去編譯 profiled
libraries，效果就如同設定在 <tt class="FILENAME">/etc/make.conf</tt> 的</p>

<pre class="PROGRAMLISTING">
NO_PROFILE=    true    #    Avoid compiling profiled libraries
</pre>

<p><tt class="REPLACEABLE"><i>target</i></tt> 則是告訴 <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">make</span>(1)</span></a> 該去做哪些。
每個 <tt class="FILENAME">Makefile</tt> 都會定義不同的 “targets”，然後依您所給的 target
就會決定會做哪些動作 。</p>

<p>某些 targets 會在 <tt class="FILENAME">Makefile</tt> 列出，但是不一定是給您使用的。
Instead, they are used by the build process to break out the steps necessary to rebuild
the system into a number of sub-steps.</p>

<p>通常，您不需要給 <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">make</span>(1)</span></a>
任何參數，所以您的指令看起來像這樣：</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make <tt
class="REPLACEABLE"><i>target</i></tt></kbd>
</pre>

<p>這裡的 <tt class="REPLACEABLE"><i>target</i></tt>可以是一個或多個建立選項。 第一個
target 應該都要是 <tt class="MAKEVAR">buildworld</tt>。</p>

<p>正如其名，<tt class="MAKETARGET">buildworld</tt> 建立一個完整的系統放在 <tt
class="FILENAME">/usr/obj</tt>； 而另一個 target <tt class="MAKETARGET">installworld</tt>
則將這些東西安裝到機器上。</p>

<p>將選項獨立有兩個好理由。第一，it allows you to do the build safe in the knowledge that
no components of your running system will be affected. The build is “self hosted”.
Because of this, you can safely run <tt class="MAKETARGET">buildworld</tt> on a machine
running in multi-user mode with no fear of ill-effects. It is still recommended that you
run the <tt class="MAKETARGET">installworld</tt> part in single user mode, though.</p>

<p>Secondly, it allows you to use NFS mounts to upgrade multiple machines on your
network. If you have three machines, <tt class="HOSTID">A</tt>, <tt class="HOSTID">B</tt>
and <tt class="HOSTID">C</tt> that you want to upgrade, run <tt class="COMMAND">make
buildworld</tt> and <tt class="COMMAND">make installworld</tt> on <tt
class="HOSTID">A</tt>. <tt class="HOSTID">B</tt> and <tt class="HOSTID">C</tt> should
then NFS mount <tt class="FILENAME">/usr/src</tt> and <tt class="FILENAME">/usr/obj</tt>
from <tt class="HOSTID">A</tt>, and you can then run <tt class="COMMAND">make
installworld</tt> to install the results of the build on <tt class="HOSTID">B</tt> and
<tt class="HOSTID">C</tt>.</p>

<p>Although the <tt class="MAKETARGET">world</tt> target still exists, you are strongly
encouraged not to use it.</p>

<p>Run</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make buildworld</kbd>
</pre>

<p>It is possible to specify a <code class="OPTION">-j</code> option to <tt
class="COMMAND">make</tt> which will cause it to spawn several simultaneous processes.
This is most useful on multi-CPU machines. However, since much of the compiling process
is IO bound rather than CPU bound it is also useful on single CPU machines.</p>

<p>On a typical single-CPU machine you would run:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make -j4 buildworld</kbd>
</pre>

<p><a href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">make</span>(1)</span></a> will then have
up to 4 processes running at any one time. Empirical evidence posted to the mailing lists
shows this generally gives the best performance benefit.</p>

<p>If you have a multi-CPU machine and you are using an SMP configured kernel try values
between 6 and 10 and see how they speed things up.</p>
</div>

<div class="SECT3">
<h3 class="SECT3"><a id="AEN29081" name="AEN29081">23.4.7.3 Timings</a></h3>

<p>Many factors influence the build time, but fairly recent machines may only take a one
or two hours to build the FreeBSD-STABLE tree, with no tricks or shortcuts used during
the process. A FreeBSD-CURRENT tree will take somewhat longer.</p>
</div>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN29088" name="AEN29088">23.4.8 Compile and Install a New
Kernel</a></h2>

<p>To take full advantage of your new system you should recompile the kernel. This is
practically a necessity, as certain memory structures may have changed, and programs like
<a href="http://www.FreeBSD.org/cgi/man.cgi?query=ps&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ps</span>(1)</span></a> and <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=top&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">top</span>(1)</span></a> will fail to
work until the kernel and source code versions are the same.</p>

<p>The simplest, safest way to do this is to build and install a kernel based on <tt
class="FILENAME">GENERIC</tt>. While <tt class="FILENAME">GENERIC</tt> may not have all
the necessary devices for your system, it should contain everything necessary to boot
your system back to single user mode. This is a good test that the new system works
properly. After booting from <tt class="FILENAME">GENERIC</tt> and verifying that your
system works you can then build a new kernel based on your normal kernel configuration
file.</p>

<p>On FreeBSD it is important to <a href="makeworld.html#MAKE-BUILDWORLD">build world</a>
before building a new kernel.</p>

<div class="NOTE">
<blockquote class="NOTE">
<p><b>Note:</b> If you want to build a custom kernel, and already have a configuration
file, just use <tt class="LITERAL">KERNCONF=<tt
class="REPLACEABLE"><i>MYKERNEL</i></tt></tt> like this:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /usr/src</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make buildkernel KERNCONF=<tt
class="REPLACEABLE"><i>MYKERNEL</i></tt></kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make installkernel KERNCONF=<tt
class="REPLACEABLE"><i>MYKERNEL</i></tt></kbd>
</pre>
</blockquote>
</div>

<p>Note that if you have raised <tt class="LITERAL">kern.securelevel</tt> above 1 <span
class="emphasis"><b class="EMPHASIS">and</b></span> you have set either the <tt
class="LITERAL">noschg</tt> or similar flags to your kernel binary, you might find it
necessary to drop into single user mode to use <tt class="MAKETARGET">installkernel</tt>.
Otherwise you should be able to run both these commands from multi user mode without
problems. See <a href="http://www.FreeBSD.org/cgi/man.cgi?query=init&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">init</span>(8)</span></a> for details
about <tt class="LITERAL">kern.securelevel</tt> and <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=chflags&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">chflags</span>(1)</span></a> for details
about the various file flags.</p>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN29131" name="AEN29131">23.4.9 Reboot into Single User
Mode</a></h2>

<p>You should reboot into single user mode to test the new kernel works. Do this by
following the instructions in <a href="makeworld.html#MAKEWORLD-SINGLEUSER">Section
23.4.5</a>.</p>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="MAKE-INSTALLWORLD" name="MAKE-INSTALLWORLD">23.4.10 Install the
New System Binaries</a></h2>

<p>If you were building a version of FreeBSD recent enough to have used <tt
class="COMMAND">make buildworld</tt> then you should now use <tt
class="MAKETARGET">installworld</tt> to install the new system binaries.</p>

<p>Run</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /usr/src</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make installworld</kbd>
</pre>

<div class="NOTE">
<blockquote class="NOTE">
<p><b>Note:</b> If you specified variables on the <tt class="COMMAND">make
buildworld</tt> command line, you must specify the same variables in the <tt
class="COMMAND">make installworld</tt> command line. This does not necessarily hold true
for other options; for example, <code class="OPTION">-j</code> must never be used with
<tt class="MAKETARGET">installworld</tt>.</p>

<p>For example, if you ran:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make -DNO_PROFILE buildworld</kbd>
</pre>

<p>you must install the results with:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make -DNO_PROFILE installworld</kbd>
</pre>

<p>otherwise it would try to install profiled libraries that had not been built during
the <tt class="COMMAND">make buildworld</tt> phase.</p>
</blockquote>
</div>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN29164" name="AEN29164">23.4.11 Update Files Not Updated by
<tt class="COMMAND">make installworld</tt></a></h2>

<p>Remaking the world will not update certain directories (in particular, <tt
class="FILENAME">/etc</tt>, <tt class="FILENAME">/var</tt> and <tt
class="FILENAME">/usr</tt>) with new or changed configuration files.</p>

<p>The simplest way to update these files is to use <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">mergemaster</span>(8)</span></a>, though
it is possible to do it manually if you would prefer to do that. Regardless of which way
you choose, be sure to make a backup of <tt class="FILENAME">/etc</tt> in case anything
goes wrong.</p>

<div class="SECT3">
<h3 class="SECT3"><a id="MERGEMASTER" name="MERGEMASTER">23.4.11.1 <tt
class="COMMAND">mergemaster</tt></a></h3>

<i class="AUTHORGROUP"><span class="CONTRIB">Contributed by</span> Tom Rhodes.</i> 

<p>The <a href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">mergemaster</span>(8)</span></a> utility
is a Bourne script that will aid you in determining the differences between your
configuration files in <tt class="FILENAME">/etc</tt>, and the configuration files in the
source tree <tt class="FILENAME">/usr/src/etc</tt>. This is the recommended solution for
keeping the system configuration files up to date with those located in the source
tree.</p>

<p>To begin simply type <tt class="COMMAND">mergemaster</tt> at your prompt, and watch it
start going. <tt class="COMMAND">mergemaster</tt> will then build a temporary root
environment, from <tt class="FILENAME">/</tt> down, and populate it with various system
configuration files. Those files are then compared to the ones currently installed in
your system. At this point, files that differ will be shown in <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">diff</span>(1)</span></a> format, with
the <code class="OPTION">+</code> sign representing added or modified lines, and <code
class="OPTION">-</code> representing lines that will be either removed completely, or
replaced with a new line. See the <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">diff</span>(1)</span></a> manual page
for more information about the <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">diff</span>(1)</span></a> syntax and how
file differences are shown.</p>

<p><a href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">mergemaster</span>(8)</span></a> will
then show you each file that displays variances, and at this point you will have the
option of either deleting the new file (referred to as the temporary file), installing
the temporary file in its unmodified state, merging the temporary file with the currently
installed file, or viewing the <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">diff</span>(1)</span></a> results
again.</p>

<p>Choosing to delete the temporary file will tell <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">mergemaster</span>(8)</span></a> that we
wish to keep our current file unchanged, and to delete the new version. This option is
not recommended, unless you see no reason to change the current file. You can get help at
any time by typing <b class="KEYCAP">?</b> at the <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">mergemaster</span>(8)</span></a> prompt.
If the user chooses to skip a file, it will be presented again after all other files have
been dealt with.</p>

<p>Choosing to install the unmodified temporary file will replace the current file with
the new one. For most unmodified files, this is the best option.</p>

<p>Choosing to merge the file will present you with a text editor, and the contents of
both files. You can now merge them by reviewing both files side by side on the screen,
and choosing parts from both to create a finished product. When the files are compared
side by side, the <b class="KEYCAP">l</b> key will select the left contents and the <b
class="KEYCAP">r</b> key will select contents from your right. The final output will be a
file consisting of both parts, which can then be installed. This option is customarily
used for files where settings have been modified by the user.</p>

<p>Choosing to view the <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">diff</span>(1)</span></a> results again
will show you the file differences just like <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">mergemaster</span>(8)</span></a> did
before prompting you for an option.</p>

<p>After <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">mergemaster</span>(8)</span></a> is done
with the system files you will be prompted for other options. <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">mergemaster</span>(8)</span></a> may ask
if you want to rebuild the password file and will finish up with an option to remove
left-over temporary files.</p>
</div>

<div class="SECT3">
<h3 class="SECT3"><a id="AEN29242" name="AEN29242">23.4.11.2 Manual Update</a></h3>

<p>If you wish to do the update manually, however, you cannot just copy over the files
from <tt class="FILENAME">/usr/src/etc</tt> to <tt class="FILENAME">/etc</tt> and have it
work. Some of these files must be “installed” first. This is because the <tt
class="FILENAME">/usr/src/etc</tt> directory <span class="emphasis"><b
class="EMPHASIS">is not</b></span> a copy of what your <tt class="FILENAME">/etc</tt>
directory should look like. In addition, there are files that should be in <tt
class="FILENAME">/etc</tt> that are not in <tt class="FILENAME">/usr/src/etc</tt>.</p>

<p>If you are using <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">mergemaster</span>(8)</span></a> (as
recommended), you can skip forward to the <a
href="makeworld.html#CUTTING-EDGE-REBOOTING">next section</a>.</p>

<p>The simplest way to do this by hand is to install the files into a new directory, and
then work through them looking for differences.</p>

<div class="WARNING">
<blockquote class="WARNING">
<p><b>Backup Your Existing <tt class="FILENAME">/etc</tt>:</b> Although, in theory,
nothing is going to touch this directory automatically, it is always better to be sure.
So copy your existing <tt class="FILENAME">/etc</tt> directory somewhere safe. Something
like:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cp -Rp /etc /etc.old</kbd>
</pre>

<p><code class="OPTION">-R</code> does a recursive copy, <code class="OPTION">-p</code>
preserves times, ownerships on files and suchlike.</p>
</blockquote>
</div>

<p>You need to build a dummy set of directories to install the new <tt
class="FILENAME">/etc</tt> and other files into. <tt class="FILENAME">/var/tmp/root</tt>
is a reasonable choice, and there are a number of subdirectories required under this as
well.</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">mkdir /var/tmp/root</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /usr/src/etc</kbd>
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">make DESTDIR=/var/tmp/root distrib-dirs distribution</kbd>
</pre>

<p>This will build the necessary directory structure and install the files. A lot of the
subdirectories that have been created under <tt class="FILENAME">/var/tmp/root</tt> are
empty and should be deleted. The simplest way to do this is to:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /var/tmp/root</kbd>
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">find -d . -type d | xargs rmdir 2&gt;/dev/null</kbd>
</pre>

<p>This will remove all empty directories. (Standard error is redirected to <tt
class="FILENAME">/dev/null</tt> to prevent the warnings about the directories that are
not empty.)</p>

<p><tt class="FILENAME">/var/tmp/root</tt> now contains all the files that should be
placed in appropriate locations below <tt class="FILENAME">/</tt>. You now have to go
through each of these files, determining how they differ with your existing files.</p>

<p>Note that some of the files that will have been installed in <tt
class="FILENAME">/var/tmp/root</tt> have a leading “.”. At the time of writing the only
files like this are shell startup files in <tt class="FILENAME">/var/tmp/root/</tt> and
<tt class="FILENAME">/var/tmp/root/root/</tt>, although there may be others (depending on
when you are reading this). Make sure you use <tt class="COMMAND">ls -a</tt> to catch
them.</p>

<p>The simplest way to do this is to use <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">diff</span>(1)</span></a> to compare the
two files:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">diff /etc/shells /var/tmp/root/etc/shells</kbd>
</pre>

<p>This will show you the differences between your <tt class="FILENAME">/etc/shells</tt>
file and the new <tt class="FILENAME">/var/tmp/root/etc/shells</tt> file. Use these to
decide whether to merge in changes that you have made or whether to copy over your old
file.</p>

<div class="TIP">
<blockquote class="TIP">
<p><b>Name the New Root Directory (<tt class="FILENAME">/var/tmp/root</tt>) with a Time
Stamp, so You Can Easily Compare Differences Between Versions:</b> Frequently rebuilding
the world means that you have to update <tt class="FILENAME">/etc</tt> frequently as
well, which can be a bit of a chore.</p>

<p>You can speed this process up by keeping a copy of the last set of changed files that
you merged into <tt class="FILENAME">/etc</tt>. The following procedure gives one idea of
how to do this.</p>

<div class="PROCEDURE">
<ol type="1">
<li class="STEP">
<p>Make the world as normal. When you want to update <tt class="FILENAME">/etc</tt> and
the other directories, give the target directory a name based on the current date. If you
were doing this on the 14th of February 1998 you could do the following:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">mkdir /var/tmp/root-19980214</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /usr/src/etc</kbd>
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">make DESTDIR=/var/tmp/root-19980214 \
    distrib-dirs distribution</kbd>
</pre>
</li>

<li class="STEP">
<p>Merge in the changes from this directory as outlined above.</p>

<p><span class="emphasis"><b class="EMPHASIS">Do not</b></span> remove the <tt
class="FILENAME">/var/tmp/root-19980214</tt> directory when you have finished.</p>
</li>

<li class="STEP">
<p>When you have downloaded the latest version of the source and remade it, follow step
1. This will give you a new directory, which might be called <tt
class="FILENAME">/var/tmp/root-19980221</tt> (if you wait a week between doing
updates).</p>
</li>

<li class="STEP">
<p>You can now see the differences that have been made in the intervening week using <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">diff</span>(1)</span></a> to create a
recursive diff between the two directories:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /var/tmp</kbd>
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">diff -r root-19980214 root-19980221</kbd>
</pre>

<p>Typically, this will be a much smaller set of differences than those between <tt
class="FILENAME">/var/tmp/root-19980221/etc</tt> and <tt class="FILENAME">/etc</tt>.
Because the set of differences is smaller, it is easier to migrate those changes across
into your <tt class="FILENAME">/etc</tt> directory.</p>
</li>

<li class="STEP">
<p>You can now remove the older of the two <tt class="FILENAME">/var/tmp/root-*</tt>
directories:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">rm -rf /var/tmp/root-19980214</kbd>
</pre>
</li>

<li class="STEP">
<p>Repeat this process every time you need to merge in changes to <tt
class="FILENAME">/etc</tt>.</p>
</li>
</ol>
</div>

<p>You can use <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=date&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">date</span>(1)</span></a> to automate
the generation of the directory names:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">mkdir /var/tmp/root-`date "+%Y%m%d"`</kbd>
</pre>
</blockquote>
</div>
</div>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="CUTTING-EDGE-REBOOTING" name="CUTTING-EDGE-REBOOTING">23.4.12
Rebooting</a></h2>

<p>You are now done. After you have verified that everything appears to be in the right
place you can reboot the system. A simple <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=shutdown&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">shutdown</span>(8)</span></a> should do
it:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">shutdown -r now</kbd>
</pre>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN29373" name="AEN29373">23.4.13 Finished</a></h2>

<p>You should now have successfully upgraded your FreeBSD system. Congratulations.</p>

<p>If things went slightly wrong, it is easy to rebuild a particular piece of the system.
For example, if you accidentally deleted <tt class="FILENAME">/etc/magic</tt> as part of
the upgrade or merge of <tt class="FILENAME">/etc</tt>, the <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=file&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">file</span>(1)</span></a> command will
stop working. In this case, the fix would be to run:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /usr/src/usr.bin/file</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make all install</kbd>
</pre>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN29387" name="AEN29387">23.4.14 Questions</a></h2>

<div class="QANDASET">
<dl>
<dt>23.4.14.1. <a href="makeworld.html#Q23.4.14.1.">Do I need to re-make the world for
every change?</a></dt>

<dt>23.4.14.2. <a href="makeworld.html#Q23.4.14.2.">My compile failed with lots of signal
11 (or other signal number) errors. What has happened?</a></dt>

<dt>23.4.14.3. <a href="makeworld.html#Q23.4.14.3.">Can I remove <tt
class="FILENAME">/usr/obj</tt> when I have finished?</a></dt>

<dt>23.4.14.4. <a href="makeworld.html#Q23.4.14.4.">Can interrupted builds be
resumed?</a></dt>

<dt>23.4.14.5. <a href="makeworld.html#Q23.4.14.5.">How can I speed up making the
world?</a></dt>

<dt>23.4.14.6. <a href="makeworld.html#Q23.4.14.6.">What do I do if something goes
wrong?</a></dt>
</dl>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="Q23.4.14.1." name="Q23.4.14.1."></a><b>23.4.14.1.</b> Do I need to re-make the
world for every change?</p>
</div>

<div class="ANSWER">
<p><b></b>There is no easy answer to this one, as it depends on the nature of the change.
For example, if you just ran <b class="APPLICATION">CVSup</b>, and it has shown the
following files as being updated:</p>

<pre class="SCREEN">
<tt class="FILENAME">src/games/cribbage/instr.c</tt>
<tt class="FILENAME">src/games/sail/pl_main.c</tt>
<tt class="FILENAME">src/release/sysinstall/config.c</tt>
<tt class="FILENAME">src/release/sysinstall/media.c</tt>
<tt class="FILENAME">src/share/mk/bsd.port.mk</tt>
</pre>

<p>it probably is not worth rebuilding the entire world. You could just go to the
appropriate sub-directories and <tt class="COMMAND">make all install</tt>, and that's
about it. But if something major changed, for example <tt
class="FILENAME">src/lib/libc/stdlib</tt> then you should either re-make the world, or at
least those parts of it that are statically linked (as well as anything else you might
have added that is statically linked).</p>

<p>At the end of the day, it is your call. You might be happy re-making the world every
fortnight say, and let changes accumulate over that fortnight. Or you might want to
re-make just those things that have changed, and be confident you can spot all the
dependencies.</p>

<p>And, of course, this all depends on how often you want to upgrade, and whether you are
tracking FreeBSD-STABLE or FreeBSD-CURRENT.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="Q23.4.14.2." name="Q23.4.14.2."></a><b>23.4.14.2.</b> My compile failed with
lots of signal 11 (or other signal number) errors. What has happened?</p>
</div>

<div class="ANSWER">
<p><b></b>This is normally indicative of hardware problems. (Re)making the world is an
effective way to stress test your hardware, and will frequently throw up memory problems.
These normally manifest themselves as the compiler mysteriously dying on receipt of
strange signals.</p>

<p>A sure indicator of this is if you can restart the make and it dies at a different
point in the process.</p>

<p>In this instance there is little you can do except start swapping around the
components in your machine to determine which one is failing.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="Q23.4.14.3." name="Q23.4.14.3."></a><b>23.4.14.3.</b> Can I remove <tt
class="FILENAME">/usr/obj</tt> when I have finished?</p>
</div>

<div class="ANSWER">
<p><b></b>The short answer is yes.</p>

<p><tt class="FILENAME">/usr/obj</tt> contains all the object files that were produced
during the compilation phase. Normally, one of the first steps in the <tt
class="COMMAND">make buildworld</tt> process is to remove this directory and start
afresh. In this case, keeping <tt class="FILENAME">/usr/obj</tt> around after you have
finished makes little sense, and will free up a large chunk of disk space (currently
about 340&nbsp;MB).</p>

<p>However, if you know what you are doing you can have <tt class="COMMAND">make
buildworld</tt> skip this step. This will make subsequent builds run much faster, since
most of sources will not need to be recompiled. The flip side of this is that subtle
dependency problems can creep in, causing your build to fail in odd ways. This frequently
generates noise on the FreeBSD mailing lists, when one person complains that their build
has failed, not realizing that it is because they have tried to cut corners.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="Q23.4.14.4." name="Q23.4.14.4."></a><b>23.4.14.4.</b> Can interrupted builds be
resumed?</p>
</div>

<div class="ANSWER">
<p><b></b>This depends on how far through the process you got before you found a
problem.</p>

<p><span class="emphasis"><b class="EMPHASIS">In general</b></span> (and this is not a
hard and fast rule) the <tt class="COMMAND">make buildworld</tt> process builds new
copies of essential tools (such as <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=gcc&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">gcc</span>(1)</span></a>, and <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">make</span>(1)</span></a>) and the
system libraries. These tools and libraries are then installed. The new tools and
libraries are then used to rebuild themselves, and are installed again. The entire system
(now including regular user programs, such as <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ls&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ls</span>(1)</span></a> or <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=grep&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">grep</span>(1)</span></a>) is then
rebuilt with the new system files.</p>

<p>If you are at the last stage, and you know it (because you have looked through the
output that you were storing) then you can (fairly safely) do:</p>

<pre class="SCREEN">
<span class="emphasis"><b class="EMPHASIS">... fix the problem ...</b></span>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /usr/src</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make -DNO_CLEAN all</kbd>
</pre>

<p>This will not undo the work of the previous <tt class="COMMAND">make
buildworld</tt>.</p>

<p>If you see the message:</p>

<pre class="SCREEN">
--------------------------------------------------------------
Building everything..
--------------------------------------------------------------
</pre>

<p>in the <tt class="COMMAND">make buildworld</tt> output then it is probably fairly safe
to do so.</p>

<p>If you do not see that message, or you are not sure, then it is always better to be
safe than sorry, and restart the build from scratch.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="Q23.4.14.5." name="Q23.4.14.5."></a><b>23.4.14.5.</b> How can I speed up making
the world?</p>
</div>

<div class="ANSWER">
<p><b></b></p>

<ul class="noindent">
<li>
<p>Run in single user mode.</p>
</li>

<li>
<p>Put the <tt class="FILENAME">/usr/src</tt> and <tt class="FILENAME">/usr/obj</tt>
directories on separate file systems held on separate disks. If possible, put these disks
on separate disk controllers.</p>
</li>

<li>
<p>Better still, put these file systems across multiple disks using the <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ccd</span>(4)</span></a> (concatenated
disk driver) device.</p>
</li>

<li>
<p>Turn off profiling (set “NO_PROFILE=true” in <tt
class="FILENAME">/etc/make.conf</tt>). You almost certainly do not need it.</p>
</li>

<li>
<p>Also in <tt class="FILENAME">/etc/make.conf</tt>, set <tt class="MAKEVAR">CFLAGS</tt>
to something like <code class="OPTION">-O -pipe</code>. The optimization <code
class="OPTION">-O2</code> is much slower, and the optimization difference between <code
class="OPTION">-O</code> and <code class="OPTION">-O2</code> is normally negligible.
<code class="OPTION">-pipe</code> lets the compiler use pipes rather than temporary files
for communication, which saves disk access (at the expense of memory).</p>
</li>

<li>
<p>Pass the <code class="OPTION">-j<tt class="REPLACEABLE"><i>n</i></tt></code> option to
<a href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">make</span>(1)</span></a> to run
multiple processes in parallel. This usually helps regardless of whether you have a
single or a multi processor machine.</p>
</li>

<li>
<p>The file system holding <tt class="FILENAME">/usr/src</tt> can be mounted (or
remounted) with the <code class="OPTION">noatime</code> option. This prevents the file
system from recording the file access time. You probably do not need this information
anyway.</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">mount -u -o noatime /usr/src</kbd>
</pre>

<div class="WARNING">
<blockquote class="WARNING">
<p><b>Warning:</b> The example assumes <tt class="FILENAME">/usr/src</tt> is on its own
file system. If it is not (if it is a part of <tt class="FILENAME">/usr</tt> for example)
then you will need to use that file system mount point, and not <tt
class="FILENAME">/usr/src</tt>.</p>
</blockquote>
</div>
</li>

<li>
<p>The file system holding <tt class="FILENAME">/usr/obj</tt> can be mounted (or
remounted) with the <code class="OPTION">async</code> option. This causes disk writes to
happen asynchronously. In other words, the write completes immediately, and the data is
written to the disk a few seconds later. This allows writes to be clustered together, and
can be a dramatic performance boost.</p>

<div class="WARNING">
<blockquote class="WARNING">
<p><b>Warning:</b> Keep in mind that this option makes your file system more fragile.
With this option there is an increased chance that, should power fail, the file system
will be in an unrecoverable state when the machine restarts.</p>

<p>If <tt class="FILENAME">/usr/obj</tt> is the only thing on this file system then it is
not a problem. If you have other, valuable data on the same file system then ensure your
backups are fresh before you enable this option.</p>
</blockquote>
</div>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">mount -u -o async /usr/obj</kbd>
</pre>

<div class="WARNING">
<blockquote class="WARNING">
<p><b>Warning:</b> As above, if <tt class="FILENAME">/usr/obj</tt> is not on its own file
system, replace it in the example with the name of the appropriate mount point.</p>
</blockquote>
</div>
</li>
</ul>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="Q23.4.14.6." name="Q23.4.14.6."></a><b>23.4.14.6.</b> What do I do if something
goes wrong?</p>
</div>

<div class="ANSWER">
<p><b></b>Make absolutely sure your environment has no extraneous cruft from earlier
builds. This is simple enough.</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">chflags -R noschg /usr/obj/usr</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">rm -rf /usr/obj/usr</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /usr/src</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make cleandir</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make cleandir</kbd>
</pre>

<p>Yes, <tt class="COMMAND">make cleandir</tt> really should be run twice.</p>

<p>Then restart the whole process, starting with <tt class="COMMAND">make
buildworld</tt>.</p>

<p>If you still have problems, send the error and the output of <tt class="COMMAND">uname
-a</tt> to <a href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-questions"
target="_top">FreeBSD general questions 郵遞論壇</a>. Be prepared to answer other
questions about your setup!</p>
</div>
</div>
</div>
</div>
</div>

<div class="NAVFOOTER">
<hr align="LEFT" width="100%" />
<table summary="Footer navigation table" width="100%" border="0" cellpadding="0"
cellspacing="0">
<tr>
<td width="33%" align="left" valign="top"><a href="synching.html"
accesskey="P">Prev</a></td>
<td width="34%" align="center" valign="top"><a href="index.html"
accesskey="H">Home</a></td>
<td width="33%" align="right" valign="top"><a href="small-lan.html"
accesskey="N">Next</a></td>
</tr>

<tr>
<td width="33%" align="left" valign="top">更新你的 Source</td>
<td width="34%" align="center" valign="top"><a href="cutting-edge.html"
accesskey="U">Up</a></td>
<td width="33%" align="right" valign="top">Tracking for Multiple Machines</td>
</tr>
</table>
</div>

<p align="center"><small>本文及其他文件，可由此下載：<a
href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>。</small></p>

<p align="center"><small>若有 FreeBSD 方面疑問，請先閱讀 <a
href="http://www.FreeBSD.org/docs.html">FreeBSD 相關文件</a>，如不能解決的話，再洽詢
&#60;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&#62;。<br />
關於本文件的問題，請洽詢 &#60;<a
href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&#62;。</small></p>
</body>
</html>

