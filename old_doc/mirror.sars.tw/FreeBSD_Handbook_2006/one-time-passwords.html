<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="generator" content="HTML Tidy, see www.w3.org" />
<title>One-time Passwords</title>
<meta name="GENERATOR" content="Modular DocBook HTML Stylesheet Version 1.79" />
<link rel="HOME" title="FreeBSD 使用手冊" href="index.html" />
<link rel="UP" title="系統安全" href="security.html" />
<link rel="PREVIOUS" title="DES, MD5, and Crypt" href="crypt.html" />
<link rel="NEXT" title="TCP Wrappers" href="tcpwrappers.html" />
<link rel="STYLESHEET" type="text/css" href="docbook.css" />
<meta http-equiv="Content-Type" content="text/html; charset=Big5" />
</head>
<body class="SECT1" bgcolor="#FFFFFF" text="#000000" link="#0000FF" vlink="#840084"
alink="#0000FF">
<div class="NAVHEADER">
<table summary="Header navigation table" width="100%" border="0" cellpadding="0"
cellspacing="0">
<tr>
<th colspan="3" align="center">FreeBSD 使用手冊</th>
</tr>

<tr>
<td width="10%" align="left" valign="bottom"><a href="crypt.html"
accesskey="P">Prev</a></td>
<td width="80%" align="center" valign="bottom">Chapter 14 系統安全</td>
<td width="10%" align="right" valign="bottom"><a href="tcpwrappers.html"
accesskey="N">Next</a></td>
</tr>
</table>

<hr align="LEFT" width="100%" />
</div>

<div class="SECT1">
<h1 class="SECT1"><a id="ONE-TIME-PASSWORDS" name="ONE-TIME-PASSWORDS">14.5 One-time
Passwords</a></h1>

<p>S/Key is a one-time password scheme based on a one-way hash function. FreeBSD uses the
MD4 hash for compatibility but other systems have used MD5 and DES-MAC. S/Key has been
part of the FreeBSD base system since version 1.1.5 and is also used on a growing number
of other operating systems. S/Key is a registered trademark of Bell Communications
Research, Inc.</p>

<p>From version 5.0 of FreeBSD, S/Key has been replaced with the functionally equivalent
OPIE (One-time Passwords In Everything). OPIE uses the MD5 hash by default.</p>

<p>There are three different sorts of passwords which we will discuss below. The first is
your usual <span class="TRADEMARK">UNIX</span>&reg; style or Kerberos password; we will
call this a “<span class="TRADEMARK">UNIX</span> password”. The second sort is the
one-time password which is generated by the S/Key <tt class="COMMAND">key</tt> program or
the OPIE <a href="http://www.FreeBSD.org/cgi/man.cgi?query=opiekey&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">opiekey</span>(1)</span></a> program and
accepted by the <tt class="COMMAND">keyinit</tt> or <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=opiepasswd&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">opiepasswd</span>(1)</span></a> programs
and the login prompt; we will call this a “one-time password”. The final sort of
password is the secret password which you give to the <tt class="COMMAND">key</tt>/<tt
class="COMMAND">opiekey</tt> programs (and sometimes the <tt
class="COMMAND">keyinit</tt>/<tt class="COMMAND">opiepasswd</tt> programs) which it uses
to generate one-time passwords; we will call it a “secret password” or just unqualified
“password”.</p>

<p>The secret password does not have anything to do with your <span
class="TRADEMARK">UNIX</span> password; they can be the same but this is not recommended.
S/Key and OPIE secret passwords are not limited to 8 characters like old <span
class="TRADEMARK">UNIX</span> passwords<a id="AEN19468" name="AEN19468"
href="#FTN.AEN19468"><span class="footnote">[1]</span></a>, they can be as long as you
like. Passwords of six or seven word long phrases are fairly common. For the most part,
the S/Key or OPIE system operates completely independently of the <span
class="TRADEMARK">UNIX</span> password system.</p>

<p>Besides the password, there are two other pieces of data that are important to S/Key
and OPIE. One is what is known as the “seed” or “key”, consisting of two letters and
five digits. The other is what is called the “iteration count”, a number between 1 and
100. S/Key creates the one-time password by concatenating the seed and the secret
password, then applying the MD4/MD5 hash as many times as specified by the iteration
count and turning the result into six short English words. These six English words are
your one-time password. The authentication system (primarily PAM) keeps track of the last
one-time password used, and the user is authenticated if the hash of the user-provided
password is equal to the previous password. Because a one-way hash is used it is
impossible to generate future one-time passwords if a successfully used password is
captured; the iteration count is decremented after each successful login to keep the user
and the login program in sync. When the iteration count gets down to 1, S/Key and OPIE
must be reinitialized.</p>

<p>There are three programs involved in each system which we will discuss below. The <tt
class="COMMAND">key</tt> and <tt class="COMMAND">opiekey</tt> programs accept an
iteration count, a seed, and a secret password, and generate a one-time password or a
consecutive list of one-time passwords. The <tt class="COMMAND">keyinit</tt> and <tt
class="COMMAND">opiepasswd</tt> programs are used to initialize S/Key and OPIE
respectively, and to change passwords, iteration counts, or seeds; they take either a
secret passphrase, or an iteration count, seed, and one-time password. The <tt
class="COMMAND">keyinfo</tt> and <tt class="COMMAND">opieinfo</tt> programs examine the
relevant credentials files (<tt class="FILENAME">/etc/skeykeys</tt> or <tt
class="FILENAME">/etc/opiekeys</tt>) and print out the invoking user's current iteration
count and seed.</p>

<p>There are four different sorts of operations we will cover. The first is using <tt
class="COMMAND">keyinit</tt> or <tt class="COMMAND">opiepasswd</tt> over a secure
connection to set up one-time-passwords for the first time, or to change your password or
seed. The second operation is using <tt class="COMMAND">keyinit</tt> or <tt
class="COMMAND">opiepasswd</tt> over an insecure connection, in conjunction with <tt
class="COMMAND">key</tt> or <tt class="COMMAND">opiekey</tt> over a secure connection, to
do the same. The third is using <tt class="COMMAND">key</tt>/<tt
class="COMMAND">opiekey</tt> to log in over an insecure connection. The fourth is using
<tt class="COMMAND">key</tt> or <tt class="COMMAND">opiekey</tt> to generate a number of
keys which can be written down or printed out to carry with you when going to some
location without secure connections to anywhere.</p>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN19495" name="AEN19495">14.5.1 Secure Connection
Initialization</a></h2>

<p>To initialize S/Key for the first time, change your password, or change your seed
while logged in over a secure connection (e.g. on the console of a machine or via <b
class="APPLICATION">ssh</b>), use the <tt class="COMMAND">keyinit</tt> command without
any parameters while logged in as yourself:</p>

<pre class="SCREEN">
<samp class="PROMPT">%</samp> <kbd class="USERINPUT">keyinit</kbd>
Adding unfurl:
Reminder - Only use this method if you are directly connected.
If you are using telnet or rlogin exit with no password and use keyinit -s.
Enter secret password: 
Again secret password: 

ID unfurl s/key is 99 to17757
DEFY CLUB PRO NASH LACE SOFT
</pre>

<p>For OPIE, <tt class="COMMAND">opiepasswd</tt> is used instead:</p>

<pre class="SCREEN">
<samp class="PROMPT">%</samp> <kbd class="USERINPUT">opiepasswd -c</kbd>
[grimreaper] ~ $ opiepasswd -f -c
Adding unfurl:
Only use this method from the console; NEVER from remote. If you are using
telnet, xterm, or a dial-in, type ^C now or exit with no password.
Then run opiepasswd without the -c parameter.
Using MD5 to compute responses.
Enter new secret pass phrase:
Again new secret pass phrase:
ID unfurl OTP key is 499 to4268
MOS MALL GOAT ARM AVID COED
</pre>

<p>At the <samp class="PROMPT">Enter new secret pass phrase:</samp> or <samp
class="PROMPT">Enter secret password:</samp> prompts, you should enter a password or
phrase. Remember, this is not the password that you will use to login with, this is used
to generate your one-time login keys. The “ID” line gives the parameters of your
particular instance: your login name, the iteration count, and seed. When logging in the
system will remember these parameters and present them back to you so you do not have to
remember them. The last line gives the particular one-time password which corresponds to
those parameters and your secret password; if you were to re-login immediately, this
one-time password is the one you would use.</p>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN19512" name="AEN19512">14.5.2 Insecure Connection
Initialization</a></h2>

<p>To initialize or change your secret password over an insecure connection, you will
need to already have a secure connection to some place where you can run <tt
class="COMMAND">key</tt> or <tt class="COMMAND">opiekey</tt>; this might be in the form
of a desk accessory on a <span class="TRADEMARK">Macintosh</span>&reg;, or a shell prompt
on a machine you trust. You will also need to make up an iteration count (100 is probably
a good value), and you may make up your own seed or use a randomly-generated one. Over on
the insecure connection (to the machine you are initializing), use the <tt
class="COMMAND">keyinit -s</tt> command:</p>

<pre class="SCREEN">
<samp class="PROMPT">%</samp> <kbd class="USERINPUT">keyinit -s</kbd>
Updating unfurl:
Old key: to17758
Reminder you need the 6 English words from the key command.
Enter sequence count from 1 to 9999: <kbd class="USERINPUT">100</kbd>
Enter new key [default to17759]: 
s/key 100 to 17759
s/key access password:
s/key access password:<kbd class="USERINPUT">CURE MIKE BANE HIM RACY GORE</kbd>
</pre>

<p>For OPIE, you need to use <tt class="COMMAND">opiepasswd</tt>:</p>

<pre class="SCREEN">
<samp class="PROMPT">%</samp> <kbd class="USERINPUT">opiepasswd</kbd>

Updating unfurl:
You need the response from an OTP generator.
Old secret pass phrase:
        otp-md5 498 to4268 ext
        Response: GAME GAG WELT OUT DOWN CHAT
New secret pass phrase:
        otp-md5 499 to4269
        Response: LINE PAP MILK NELL BUOY TROY

ID mark OTP key is 499 gr4269
LINE PAP MILK NELL BUOY TROY
</pre>

<p>To accept the default seed (which the <tt class="COMMAND">keyinit</tt> program
confusingly calls a <tt class="LITERAL">key</tt>), press <b class="KEYCAP">Return</b>.
Then before entering an access password, move over to your secure connection or S/Key
desk accessory, and give it the same parameters:</p>

<pre class="SCREEN">
<samp class="PROMPT">%</samp> <kbd class="USERINPUT">key 100 to17759</kbd>
Reminder - Do not use this program while logged in via telnet or rlogin.
Enter secret password: <kbd class="USERINPUT">&lt;secret password&gt;</kbd>
CURE MIKE BANE HIM RACY GORE
</pre>

<p>Or for OPIE:</p>

<pre class="SCREEN">
<samp class="PROMPT">%</samp> <kbd class="USERINPUT">opiekey 498 to4268</kbd>
Using the MD5 algorithm to compute response.
Reminder: Don't use opiekey from telnet or dial-in sessions.
Enter secret pass phrase:
GAME GAG WELT OUT DOWN CHAT
</pre>

<p>Now switch back over to the insecure connection, and copy the one-time password
generated over to the relevant program.</p>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN19542" name="AEN19542">14.5.3 Generating a Single One-time
Password</a></h2>

<p>Once you have initialized S/Key or OPIE, when you login you will be presented with a
prompt like this:</p>

<pre class="SCREEN">
<samp class="PROMPT">%</samp> <kbd class="USERINPUT">telnet example.com</kbd>
Trying 10.0.0.1...
Connected to example.com
Escape character is '^]'.

FreeBSD/i386 (example.com) (ttypa)

login: <kbd class="USERINPUT">&lt;username&gt;</kbd>
s/key 97 fw13894
Password:
</pre>

<p>Or for OPIE:</p>

<pre class="SCREEN">
<samp class="PROMPT">%</samp> <kbd class="USERINPUT">telnet example.com</kbd>
Trying 10.0.0.1...
Connected to example.com
Escape character is '^]'.

FreeBSD/i386 (example.com) (ttypa)

login: <kbd class="USERINPUT">&lt;username&gt;</kbd>
otp-md5 498 gr4269 ext
Password:
</pre>

<p>As a side note, the S/Key and OPIE prompts have a useful feature (not shown here): if
you press <b class="KEYCAP">Return</b> at the password prompt, the prompter will turn
echo on, so you can see what you are typing. This can be extremely useful if you are
attempting to type in a password by hand, such as from a printout.</p>

<p>At this point you need to generate your one-time password to answer this login prompt.
This must be done on a trusted system that you can run <tt class="COMMAND">key</tt> or
<tt class="COMMAND">opiekey</tt> on. (There are versions of these for DOS, <span
class="TRADEMARK">Windows</span>&reg; and <span class="TRADEMARK">Mac&nbsp;OS</span>&reg;
as well.) They need both the iteration count and the seed as command line options. You
can cut-and-paste these right from the login prompt on the machine that you are logging
in to.</p>

<p>On the trusted system:</p>

<pre class="SCREEN">
<samp class="PROMPT">%</samp> <kbd class="USERINPUT">key 97 fw13894</kbd>
Reminder - Do not use this program while logged in via telnet or rlogin.
Enter secret password: 
WELD LIP ACTS ENDS ME HAAG
</pre>

<p>For OPIE:</p>

<pre class="SCREEN">
<samp class="PROMPT">%</samp> <kbd class="USERINPUT">opiekey 498 to4268</kbd>
Using the MD5 algorithm to compute response.
Reminder: Don't use opiekey from telnet or dial-in sessions.
Enter secret pass phrase:
GAME GAG WELT OUT DOWN CHAT
</pre>

<p>Now that you have your one-time password you can continue logging in:</p>

<pre class="SCREEN">
login: <kbd class="USERINPUT">&lt;username&gt;</kbd>
s/key 97 fw13894
Password: <kbd class="USERINPUT">&lt;return to enable echo&gt;</kbd>
s/key 97 fw13894
Password [echo on]: WELD LIP ACTS ENDS ME HAAG
Last login: Tue Mar 21 11:56:41 from 10.0.0.2 ...
</pre>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN19579" name="AEN19579">14.5.4 Generating Multiple One-time
Passwords</a></h2>

<p>Sometimes you have to go places where you do not have access to a trusted machine or
secure connection. In this case, it is possible to use the <tt class="COMMAND">key</tt>
and <tt class="COMMAND">opiekey</tt> commands to generate a number of one-time passwords
beforehand to be printed out and taken with you. For example:</p>

<pre class="SCREEN">
<samp class="PROMPT">%</samp> <kbd class="USERINPUT">key -n 5 30 zz99999</kbd>
Reminder - Do not use this program while logged in via telnet or rlogin.
Enter secret password: <kbd class="USERINPUT">&lt;secret password&gt;</kbd>
26: SODA RUDE LEA LIND BUDD SILT 
27: JILT SPY DUTY GLOW COWL ROT  
28: THEM OW COLA RUNT BONG SCOT  
29: COT MASH BARR BRIM NAN FLAG  
30: CAN KNEE CAST NAME FOLK BILK
</pre>

<p>Or for OPIE:</p>

<pre class="SCREEN">
<samp class="PROMPT">%</samp> <kbd class="USERINPUT">opiekey -n 5 30 zz99999</kbd>
Using the MD5 algorithm to compute response.
Reminder: Don't use opiekey from telnet or dial-in sessions.
Enter secret pass phrase: <kbd class="USERINPUT">&lt;secret password&gt;</kbd>
26: JOAN BORE FOSS DES NAY QUIT
27: LATE BIAS SLAY FOLK MUCH TRIG
28: SALT TIN ANTI LOON NEAL USE
29: RIO ODIN GO BYE FURY TIC
30: GREW JIVE SAN GIRD BOIL PHI
</pre>

<p>The <code class="OPTION">-n 5</code> requests five keys in sequence, the <code
class="OPTION">30</code> specifies what the last iteration number should be. Note that
these are printed out in <span class="emphasis"><i class="EMPHASIS">reverse</i></span>
order of eventual use. If you are really paranoid, you might want to write the results
down by hand; otherwise you can cut-and-paste into <tt class="COMMAND">lpr</tt>. Note
that each line shows both the iteration count and the one-time password; you may still
find it handy to scratch off passwords as you use them.</p>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN19598" name="AEN19598">14.5.5 Restricting Use of <span
class="TRADEMARK">UNIX</span>&reg; Passwords</a></h2>

<p>S/Key can place restrictions on the use of <span class="TRADEMARK">UNIX</span>
passwords based on the host name, user name, terminal port, or IP address of a login
session. These restrictions can be found in the configuration file <tt
class="FILENAME">/etc/skey.access</tt>. The <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=skey.access&amp;sektion=5"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">skey.access</span>(5)</span></a> manual
page has more information on the complete format of the file and also details some
security cautions to be aware of before depending on this file for security.</p>

<p>If there is no <tt class="FILENAME">/etc/skey.access</tt> file (this is the default on
FreeBSD&nbsp;4.X systems), then all users will be allowed to use <span
class="TRADEMARK">UNIX</span> passwords. If the file exists, however, then all users will
be required to use S/Key unless explicitly permitted to do otherwise by configuration
statements in the <tt class="FILENAME">skey.access</tt> file. In all cases, <span
class="TRADEMARK">UNIX</span> passwords are permitted on the console.</p>

<p>Here is a sample <tt class="FILENAME">skey.access</tt> configuration file which
illustrates the three most common sorts of configuration statements:</p>

<pre class="PROGRAMLISTING">
permit internet 192.168.0.0 255.255.0.0
permit user fnord
permit port ttyd0
</pre>

<p>The first line (<tt class="LITERAL">permit internet</tt>) allows users whose IP source
address (which is vulnerable to spoofing) matches the specified value and mask, to use
<span class="TRADEMARK">UNIX</span> passwords. This should not be considered a security
mechanism, but rather, a means to remind authorized users that they are using an insecure
network and need to use S/Key for authentication.</p>

<p>The second line (<tt class="LITERAL">permit user</tt>) allows the specified username,
in this case <tt class="USERNAME">fnord</tt>, to use <span class="TRADEMARK">UNIX</span>
passwords at any time. Generally speaking, this should only be used for people who are
either unable to use the <tt class="COMMAND">key</tt> program, like those with dumb
terminals, or those who are ineducable.</p>

<p>The third line (<tt class="LITERAL">permit port</tt>) allows all users logging in on
the specified terminal line to use <span class="TRADEMARK">UNIX</span> passwords; this
would be used for dial-ups.</p>

<p>OPIE can restrict the use of <span class="TRADEMARK">UNIX</span> passwords based on
the IP address of a login session just like S/Key does. The relevant file is <tt
class="FILENAME">/etc/opieaccess</tt>, which is present by default on FreeBSD&nbsp;5.0
and newer systems. Please check <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=opieaccess&amp;sektion=5"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">opieaccess</span>(5)</span></a> for more
information on this file and which security considerations you should be aware of when
using it.</p>

<p>Here is a sample <tt class="FILENAME">opieaccess</tt> file:</p>

<pre class="PROGRAMLISTING">
permit 192.168.0.0 255.255.0.0
</pre>

<p>This line allows users whose IP source address (which is vulnerable to spoofing)
matches the specified value and mask, to use <span class="TRADEMARK">UNIX</span>
passwords at any time.</p>

<p>If no rules in <tt class="FILENAME">opieaccess</tt> are matched, the default is to
deny non-OPIE logins.</p>
</div>
</div>

<h3 class="FOOTNOTES">Notes</h3>

<table border="0" class="FOOTNOTES" width="100%">
<tr>
<td align="LEFT" valign="TOP" width="5%"><a id="FTN.AEN19468" name="FTN.AEN19468"
href="one-time-passwords.html#AEN19468"><span class="footnote">[1]</span></a></td>
<td align="LEFT" valign="TOP" width="95%">
<p>Under FreeBSD the standard login password may be up to 128 characters in length.</p>
</td>
</tr>
</table>

<div class="NAVFOOTER">
<hr align="LEFT" width="100%" />
<table summary="Footer navigation table" width="100%" border="0" cellpadding="0"
cellspacing="0">
<tr>
<td width="33%" align="left" valign="top"><a href="crypt.html"
accesskey="P">Prev</a></td>
<td width="34%" align="center" valign="top"><a href="index.html"
accesskey="H">Home</a></td>
<td width="33%" align="right" valign="top"><a href="tcpwrappers.html"
accesskey="N">Next</a></td>
</tr>

<tr>
<td width="33%" align="left" valign="top">DES, MD5, and Crypt</td>
<td width="34%" align="center" valign="top"><a href="security.html"
accesskey="U">Up</a></td>
<td width="33%" align="right" valign="top">TCP Wrappers</td>
</tr>
</table>
</div>

<p align="center"><small>This, and other documents, can be downloaded from <a
href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>.</small></p>

<p align="center"><small>For questions about FreeBSD, read the <a
href="http://www.FreeBSD.org/docs.html">documentation</a> before contacting &#60;<a
href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&#62;.<br />
For questions about this documentation, e-mail &#60;<a
href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&#62;.</small></p>
</body>
</html>

