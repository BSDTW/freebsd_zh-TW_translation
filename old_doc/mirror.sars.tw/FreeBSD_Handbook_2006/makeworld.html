<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="generator" content="HTML Tidy, see www.w3.org" />
<title>Rebuilding world</title>
<meta name="GENERATOR" content="Modular DocBook HTML Stylesheet Version 1.79" />
<link rel="HOME" title="FreeBSD 使用手冊" href="index.html" />
<link rel="UP" title="The Cutting Edge" href="cutting-edge.html" />
<link rel="PREVIOUS" title="Synchronizing Your Source" href="synching.html" />
<link rel="NEXT" title="Tracking for Multiple Machines" href="small-lan.html" />
<link rel="STYLESHEET" type="text/css" href="docbook.css" />
<meta http-equiv="Content-Type" content="text/html; charset=Big5" />
</head>
<body class="SECT1" bgcolor="#FFFFFF" text="#000000" link="#0000FF" vlink="#840084"
alink="#0000FF">
<div class="NAVHEADER">
<table summary="Header navigation table" width="100%" border="0" cellpadding="0"
cellspacing="0">
<tr>
<th colspan="3" align="center">FreeBSD 使用手冊</th>
</tr>

<tr>
<td width="10%" align="left" valign="bottom"><a href="synching.html"
accesskey="P">Prev</a></td>
<td width="80%" align="center" valign="bottom">Chapter 21 The Cutting Edge</td>
<td width="10%" align="right" valign="bottom"><a href="small-lan.html"
accesskey="N">Next</a></td>
</tr>
</table>

<hr align="LEFT" width="100%" />
</div>

<div class="SECT1">
<h1 class="SECT1"><a id="MAKEWORLD" name="MAKEWORLD">21.4 Rebuilding “world”</a></h1>

<p>Once you have synchronized your local source tree against a particular version of
FreeBSD (FreeBSD-STABLE, FreeBSD-CURRENT, and so on) you can then use the source tree to
rebuild the system.</p>

<div class="WARNING">
<blockquote class="WARNING">
<p><b>Take a Backup:</b> It cannot be stressed enough how important it is to take a
backup of your system <span class="emphasis"><i class="EMPHASIS">before</i></span> you do
this. While rebuilding the world is (as long as you follow these instructions) an easy
task to do, there will inevitably be times when you make mistakes, or when mistakes made
by others in the source tree render your system unbootable.</p>

<p>Make sure you have taken a backup. And have a fixit floppy or bootable CD at hand. You
will probably never have to use it, but it is better to be safe than sorry!</p>
</blockquote>
</div>

<div class="WARNING">
<blockquote class="WARNING">
<p><b>Subscribe to the Right Mailing List:</b> The FreeBSD-STABLE and FreeBSD-CURRENT
branches are, by their nature, <span class="emphasis"><i class="EMPHASIS">in
development</i></span>. People that contribute to FreeBSD are human, and mistakes
occasionally happen.</p>

<p>Sometimes these mistakes can be quite harmless, just causing your system to print a
new diagnostic warning. Or the change may be catastrophic, and render your system
unbootable or destroy your file systems (or worse).</p>

<p>If problems like these occur, a “heads up” is posted to the appropriate mailing
list, explaining the nature of the problem and which systems it affects. And an “all
clear” announcement is posted when the problem has been solved.</p>

<p>If you try to track FreeBSD-STABLE or FreeBSD-CURRENT and do not read the <a
href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-stable"
target="_top">FreeBSD-STABLE mailing list</a> or the <a
href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-current"
target="_top">FreeBSD-CURRENT mailing list</a> respectively, then you are asking for
trouble.</p>
</blockquote>
</div>

<div class="WARNING">
<blockquote class="WARNING">
<p><b>Do not use <tt class="COMMAND">make world</tt>:</b> A lot of older documentation
recommends using <tt class="COMMAND">make world</tt> for this. Doing that skips some
important steps and should only be used if you are sure of what you are doing. For almost
all circumstances <tt class="COMMAND">make world</tt> is the wrong thing to do, and the
procedure described here should be used instead.</p>
</blockquote>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN28429" name="AEN28429">21.4.1 The Canonical Way to Update
Your System</a></h2>

<p>To update your system, you should check <tt class="FILENAME">/usr/src/UPDATING</tt>
for any pre-buildworld steps necessary for your version of the sources and then use the
following procedure:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make buildworld</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make buildkernel</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make installkernel</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">reboot</kbd>
</pre>

<div class="NOTE">
<blockquote class="NOTE">
<p><b>Note:</b> There are a few rare cases when an extra run of <tt
class="COMMAND">mergemaster -p</tt> is needed before the <tt
class="MAKETARGET">buildworld</tt> step. These are described in <tt
class="FILENAME">UPDATING</tt>. In general, though, you can safely omit this step if you
are not updating across one or more major FreeBSD versions.</p>
</blockquote>
</div>

<p>After <tt class="MAKETARGET">installkernel</tt> finishes successfully, you should boot
in single user mode (i.e.&nbsp;using <tt class="COMMAND">boot -s</tt> from the loader
prompt). Then run:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">mergemaster -p</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make installworld</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">mergemaster</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">reboot</kbd>
</pre>

<div class="WARNING">
<blockquote class="WARNING">
<p><b>Read Further Explanations:</b> The sequence described above is only a short resume
to help you getting started. You should however read the following sections to clearly
understand each step, especially if you want to use a custom kernel configuration.</p>
</blockquote>
</div>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN28462" name="AEN28462">21.4.2 Read <tt
class="FILENAME">/usr/src/UPDATING</tt></a></h2>

<p>Before you do anything else, read <tt class="FILENAME">/usr/src/UPDATING</tt> (or the
equivalent file wherever you have a copy of the source code). This file should contain
important information about problems you might encounter, or specify the order in which
you might have to run certain commands. If <tt class="FILENAME">UPDATING</tt> contradicts
something you read here, <tt class="FILENAME">UPDATING</tt> takes precedence.</p>

<div class="IMPORTANT">
<blockquote class="IMPORTANT">
<p><b>Important:</b> Reading <tt class="FILENAME">UPDATING</tt> is not an acceptable
substitute for subscribing to the correct mailing list, as described previously. The two
requirements are complementary, not exclusive.</p>
</blockquote>
</div>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN28472" name="AEN28472">21.4.3 Check <tt
class="FILENAME">/etc/make.conf</tt></a></h2>

<p>Examine the files <tt class="FILENAME">/usr/share/examples/etc/make.conf</tt> (called
<tt class="FILENAME">/etc/defaults/make.conf</tt> in FreeBSD&nbsp;4.X) and <tt
class="FILENAME">/etc/make.conf</tt>. The first contains some default defines - most of
which are commented out. To make use of them when you rebuild your system from source,
add them to <tt class="FILENAME">/etc/make.conf</tt>. Keep in mind that anything you add
to <tt class="FILENAME">/etc/make.conf</tt> is also used every time you run <tt
class="COMMAND">make</tt>, so it is a good idea to set them to something sensible for
your system.</p>

<p>A typical user will probably want to copy the <tt class="MAKEVAR">CFLAGS</tt> and <tt
class="MAKEVAR">NO_PROFILE</tt> (or <tt class="MAKEVAR">NOPROFILE</tt> on
FreeBSD&nbsp;5.X and older) lines found in <tt
class="FILENAME">/usr/share/examples/etc/make.conf</tt> (or in <tt
class="FILENAME">/etc/defaults/make.conf</tt> on FreeBSD&nbsp;4.X) to <tt
class="FILENAME">/etc/make.conf</tt> and uncomment them.</p>

<p>Examine the other definitions (<tt class="MAKEVAR">COPTFLAGS</tt>, <tt
class="MAKEVAR">NOPORTDOCS</tt> and so on) and decide if they are relevant to you.</p>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN28495" name="AEN28495">21.4.4 Update the Files in <tt
class="FILENAME">/etc</tt></a></h2>

<p>The <tt class="FILENAME">/etc</tt> directory contains a large part of your system's
configuration information, as well as scripts that are run at system startup. Some of
these scripts change from version to version of FreeBSD.</p>

<p>Some of the configuration files are also used in the day to day running of the system.
In particular, <tt class="FILENAME">/etc/group</tt>.</p>

<p>There have been occasions when the installation part of <tt class="COMMAND">make
installworld</tt> has expected certain usernames or groups to exist. When performing an
upgrade it is likely that these users or groups did not exist. This caused problems when
upgrading. In some cases <tt class="COMMAND">make buildworld</tt> will check to see if
these users or groups exist.</p>

<p>A recent example of this is when the <tt class="USERNAME">smmsp</tt> user was added.
Users had the installation process fail for them when <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=mtree&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">mtree</span>(8)</span></a> was trying to
create <tt class="FILENAME">/var/spool/clientmqueue</tt>.</p>

<p>The solution is to examine <tt class="FILENAME">/usr/src/etc/group</tt> and compare
its list of groups with your own. If there are any groups in the new file that are not in
your file then copy them over. Similarly, you should rename any groups in <tt
class="FILENAME">/etc/group</tt> which have the same GID but a different name to those in
<tt class="FILENAME">/usr/src/etc/group</tt>.</p>

<p>Since 4.6-RELEASE you can run <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">mergemaster</span>(8)</span></a> in
pre-buildworld mode by providing the <code class="OPTION">-p</code> option. This will
compare only those files that are essential for the success of <tt
class="MAKETARGET">buildworld</tt> or <tt class="MAKETARGET">installworld</tt>. If your
old version of <tt class="COMMAND">mergemaster</tt> does not support <code
class="OPTION">-p</code>, use the new version in the source tree when running for the
first time:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">cd /usr/src/usr.sbin/mergemaster</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">./mergemaster.sh -p</kbd>
</pre>

<div class="TIP">
<blockquote class="TIP">
<p><b>Tip:</b> If you are feeling particularly paranoid, you can check your system to see
which files are owned by the group you are renaming or deleting:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">find / -group <tt
class="REPLACEABLE"><i>GID</i></tt> -print</kbd>
</pre>

<p>will show all files owned by group <tt class="REPLACEABLE"><i>GID</i></tt> (which can
be either a group name or a numeric group ID).</p>
</blockquote>
</div>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="MAKEWORLD-SINGLEUSER" name="MAKEWORLD-SINGLEUSER">21.4.5 Drop to
Single User Mode</a></h2>

<p>You may want to compile the system in single user mode. Apart from the obvious benefit
of making things go slightly faster, reinstalling the system will touch a lot of
important system files, all the standard system binaries, libraries, include files and so
on. Changing these on a running system (particularly if you have active users on the
system at the time) is asking for trouble.</p>

<p>Another method is to compile the system in multi-user mode, and then drop into single
user mode for the installation. If you would like to do it this way, simply hold off on
the following steps until the build has completed. You can postpone dropping to single
user mode until you have to <tt class="MAKETARGET">installkernel</tt> or <tt
class="MAKETARGET">installworld</tt>.</p>

<p>As the superuser, you can execute:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">shutdown now</kbd>
</pre>

<p>from a running system, which will drop it to single user mode.</p>

<p>Alternatively, reboot the system, and at the boot prompt, enter the <code
class="OPTION">-s</code> flag. The system will then boot single user. At the shell prompt
you should then run:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">fsck -p</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">mount -u /</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">mount -a -t ufs</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">swapon -a</kbd>
</pre>

<p>This checks the file systems, remounts <tt class="FILENAME">/</tt> read/write, mounts
all the other UFS file systems referenced in <tt class="FILENAME">/etc/fstab</tt> and
then turns swapping on.</p>

<div class="NOTE">
<blockquote class="NOTE">
<p><b>Note:</b> If your CMOS clock is set to local time and not to GMT (this is true if
the output of the <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=date&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">date</span>(1)</span></a> command does
not show the correct time and zone), you may also need to run the following command:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">adjkerntz -i</kbd>
</pre>

<p>This will make sure that your local time-zone settings get set up correctly -- without
this, you may later run into some problems.</p>
</blockquote>
</div>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN28575" name="AEN28575">21.4.6 Remove <tt
class="FILENAME">/usr/obj</tt></a></h2>

<p>As parts of the system are rebuilt they are placed in directories which (by default)
go under <tt class="FILENAME">/usr/obj</tt>. The directories shadow those under <tt
class="FILENAME">/usr/src</tt>.</p>

<p>You can speed up the <tt class="COMMAND">make buildworld</tt> process, and possibly
save yourself some dependency headaches by removing this directory as well.</p>

<p>Some files below <tt class="FILENAME">/usr/obj</tt> may have the immutable flag set
(see <a href="http://www.FreeBSD.org/cgi/man.cgi?query=chflags&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">chflags</span>(1)</span></a> for more
information) which must be removed first.</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /usr/obj</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">chflags -R noschg *</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">rm -rf *</kbd>
</pre>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN28595" name="AEN28595">21.4.7 Recompile the Source</a></h2>

<div class="SECT3">
<h3 class="SECT3"><a id="AEN28597" name="AEN28597">21.4.7.1 Saving the Output</a></h3>

<p>It is a good idea to save the output you get from running <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">make</span>(1)</span></a> to another
file. If something goes wrong you will have a copy of the error message. While this might
not help you in diagnosing what has gone wrong, it can help others if you post your
problem to one of the FreeBSD mailing lists.</p>

<p>The easiest way to do this is to use the <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=script&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">script</span>(1)</span></a> command,
with a parameter that specifies the name of the file to save all output to. You would do
this immediately before rebuilding the world, and then type <kbd
class="USERINPUT">exit</kbd> when the process has finished.</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">script /var/tmp/mw.out</kbd>
Script started, output file is /var/tmp/mw.out   
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make TARGET</kbd>
<span class="emphasis"><i
class="EMPHASIS">... compile, compile, compile ...</i></span>     
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">exit</kbd>
Script done, ...
</pre>

<p>If you do this, <span class="emphasis"><i class="EMPHASIS">do not</i></span> save the
output in <tt class="FILENAME">/tmp</tt>. This directory may be cleared next time you
reboot. A better place to store it is in <tt class="FILENAME">/var/tmp</tt> (as in the
previous example) or in <tt class="USERNAME">root</tt>'s home directory.</p>
</div>

<div class="SECT3">
<h3 class="SECT3"><a id="MAKE-BUILDWORLD" name="MAKE-BUILDWORLD">21.4.7.2 Compile the
Base System</a></h3>

<p>You must be in the <tt class="FILENAME">/usr/src</tt> directory:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /usr/src</kbd>
</pre>

<p>(unless, of course, your source code is elsewhere, in which case change to that
directory instead).</p>

<p>To rebuild the world you use the <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">make</span>(1)</span></a> command. This
command reads instructions from the <tt class="FILENAME">Makefile</tt>, which describes
how the programs that comprise FreeBSD should be rebuilt, the order in which they should
be built, and so on.</p>

<p>The general format of the command line you will type is as follows:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make -<tt
class="REPLACEABLE"><i>x</i></tt> -D<tt class="REPLACEABLE"><i>VARIABLE</i></tt> <tt
class="REPLACEABLE"><i>target</i></tt></kbd>
</pre>

<p>In this example, <code class="OPTION">-<tt class="REPLACEABLE"><i>x</i></tt></code> is
an option that you would pass to <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">make</span>(1)</span></a>. See the <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">make</span>(1)</span></a> manual page
for an example of the options you can pass.</p>

<p><code class="OPTION">-D<tt class="REPLACEABLE"><i>VARIABLE</i></tt></code> passes a
variable to the <tt class="FILENAME">Makefile</tt>. The behavior of the <tt
class="FILENAME">Makefile</tt> is controlled by these variables. These are the same
variables as are set in <tt class="FILENAME">/etc/make.conf</tt>, and this provides
another way of setting them.</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make -DNO_PROFILE <tt
class="REPLACEABLE"><i>target</i></tt></kbd>
</pre>

<p>is another way of specifying that profiled libraries should not be built, and
corresponds with the</p>

<pre class="PROGRAMLISTING">
NO_PROFILE=    true    #    Avoid compiling profiled libraries
</pre>

<p>line in <tt class="FILENAME">/etc/make.conf</tt>.</p>

<p><tt class="REPLACEABLE"><i>target</i></tt> tells <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">make</span>(1)</span></a> what you want
to do. Each <tt class="FILENAME">Makefile</tt> defines a number of different “targets”,
and your choice of target determines what happens.</p>

<p>Some targets are listed in the <tt class="FILENAME">Makefile</tt>, but are not meant
for you to run. Instead, they are used by the build process to break out the steps
necessary to rebuild the system into a number of sub-steps.</p>

<p>Most of the time you will not need to pass any parameters to <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">make</span>(1)</span></a>, and so your
command like will look like this:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make <tt
class="REPLACEABLE"><i>target</i></tt></kbd>
</pre>

<p>Beginning with version 2.2.5 of FreeBSD (actually, it was first created on the
FreeBSD-CURRENT branch, and then retrofitted to FreeBSD-STABLE midway between 2.2.2 and
2.2.5) the <tt class="MAKETARGET">world</tt> target has been split in two: <tt
class="MAKETARGET">buildworld</tt> and <tt class="MAKETARGET">installworld</tt>.
Beginning with version 5.3 of FreeBSD the <tt class="MAKETARGET">world</tt> target will
be changed so it will not work at all by default because it is actually dangerous for
most users.</p>

<p>As the names imply, <tt class="MAKETARGET">buildworld</tt> builds a complete new tree
under <tt class="FILENAME">/usr/obj</tt>, and <tt class="MAKETARGET">installworld</tt>
installs this tree on the current machine.</p>

<p>This is very useful for 2 reasons. First, it allows you to do the build safe in the
knowledge that no components of your running system will be affected. The build is “self
hosted”. Because of this, you can safely run <tt class="MAKETARGET">buildworld</tt> on a
machine running in multi-user mode with no fear of ill-effects. It is still recommended
that you run the <tt class="MAKETARGET">installworld</tt> part in single user mode,
though.</p>

<p>Secondly, it allows you to use NFS mounts to upgrade multiple machines on your
network. If you have three machines, <tt class="HOSTID">A</tt>, <tt class="HOSTID">B</tt>
and <tt class="HOSTID">C</tt> that you want to upgrade, run <tt class="COMMAND">make
buildworld</tt> and <tt class="COMMAND">make installworld</tt> on <tt
class="HOSTID">A</tt>. <tt class="HOSTID">B</tt> and <tt class="HOSTID">C</tt> should
then NFS mount <tt class="FILENAME">/usr/src</tt> and <tt class="FILENAME">/usr/obj</tt>
from <tt class="HOSTID">A</tt>, and you can then run <tt class="COMMAND">make
installworld</tt> to install the results of the build on <tt class="HOSTID">B</tt> and
<tt class="HOSTID">C</tt>.</p>

<p>Although the <tt class="MAKETARGET">world</tt> target still exists, you are strongly
encouraged not to use it.</p>

<p>Run</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make buildworld</kbd>
</pre>

<p>It is now possible to specify a <code class="OPTION">-j</code> option to <tt
class="COMMAND">make</tt> which will cause it to spawn several simultaneous processes.
This is most useful on multi-CPU machines. However, since much of the compiling process
is IO bound rather than CPU bound it is also useful on single CPU machines.</p>

<p>On a typical single-CPU machine you would run:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make -j4 buildworld</kbd>
</pre>

<p><a href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">make</span>(1)</span></a> will then have
up to 4 processes running at any one time. Empirical evidence posted to the mailing lists
shows this generally gives the best performance benefit.</p>

<p>If you have a multi-CPU machine and you are using an SMP configured kernel try values
between 6 and 10 and see how they speed things up.</p>

<p>Be aware that this is still somewhat experimental, and commits to the source tree may
occasionally break this feature. If the world fails to compile using this parameter try
again without it before you report any problems.</p>
</div>

<div class="SECT3">
<h3 class="SECT3"><a id="AEN28731" name="AEN28731">21.4.7.3 Timings</a></h3>

<p>Many factors influence the build time, but currently a 500&nbsp;MHz <span
class="TRADEMARK">Pentium</span>&reg;&nbsp;III with 128&nbsp;MB of RAM takes about
2&nbsp;hours to build the FreeBSD-STABLE tree, with no tricks or shortcuts used during
the process. A FreeBSD-CURRENT tree will take somewhat longer.</p>
</div>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN28739" name="AEN28739">21.4.8 Compile and Install a New
Kernel</a></h2>

<p>To take full advantage of your new system you should recompile the kernel. This is
practically a necessity, as certain memory structures may have changed, and programs like
<a href="http://www.FreeBSD.org/cgi/man.cgi?query=ps&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ps</span>(1)</span></a> and <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=top&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">top</span>(1)</span></a> will fail to
work until the kernel and source code versions are the same.</p>

<p>The simplest, safest way to do this is to build and install a kernel based on <tt
class="FILENAME">GENERIC</tt>. While <tt class="FILENAME">GENERIC</tt> may not have all
the necessary devices for your system, it should contain everything necessary to boot
your system back to single user mode. This is a good test that the new system works
properly. After booting from <tt class="FILENAME">GENERIC</tt> and verifying that your
system works you can then build a new kernel based on your normal kernel configuration
file.</p>

<p>On modern versions of FreeBSD it is important to <a
href="makeworld.html#MAKE-BUILDWORLD">build world</a> before building a new kernel.</p>

<div class="NOTE">
<blockquote class="NOTE">
<p><b>Note:</b> If you want to build a custom kernel, and already have a configuration
file, just use <tt class="LITERAL">KERNCONF=<tt
class="REPLACEABLE"><i>MYKERNEL</i></tt></tt> like this:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /usr/src</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make buildkernel KERNCONF=<tt
class="REPLACEABLE"><i>MYKERNEL</i></tt></kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make installkernel KERNCONF=<tt
class="REPLACEABLE"><i>MYKERNEL</i></tt></kbd>
</pre>
</blockquote>
</div>

<p>Note that if you have raised <tt class="LITERAL">kern.securelevel</tt> above 1 <span
class="emphasis"><i class="EMPHASIS">and</i></span> you have set either the <tt
class="LITERAL">noschg</tt> or similar flags to your kernel binary, you might find it
necessary to drop into single user mode to use <tt class="MAKETARGET">installkernel</tt>.
Otherwise you should be able to run both these commands from multi user mode without
problems. See <a href="http://www.FreeBSD.org/cgi/man.cgi?query=init&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">init</span>(8)</span></a> for details
about <tt class="LITERAL">kern.securelevel</tt> and <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=chflags&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">chflags</span>(1)</span></a> for details
about the various file flags.</p>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN28782" name="AEN28782">21.4.9 Reboot into Single User
Mode</a></h2>

<p>You should reboot into single user mode to test the new kernel works. Do this by
following the instructions in <a href="makeworld.html#MAKEWORLD-SINGLEUSER">Section
21.4.5</a>.</p>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN28788" name="AEN28788">21.4.10 Install the New System
Binaries</a></h2>

<p>If you were building a version of FreeBSD recent enough to have used <tt
class="COMMAND">make buildworld</tt> then you should now use <tt
class="MAKETARGET">installworld</tt> to install the new system binaries.</p>

<p>Run</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /usr/src</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make installworld</kbd>
</pre>

<div class="NOTE">
<blockquote class="NOTE">
<p><b>Note:</b> If you specified variables on the <tt class="COMMAND">make
buildworld</tt> command line, you must specify the same variables in the <tt
class="COMMAND">make installworld</tt> command line. This does not necessarily hold true
for other options; for example, <code class="OPTION">-j</code> must never be used with
<tt class="MAKETARGET">installworld</tt>.</p>

<p>For example, if you ran:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make -DNO_PROFILE buildworld</kbd>
</pre>

<p>you must install the results with:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make -DNO_PROFILE installworld</kbd>
</pre>

<p>otherwise it would try to install profiled libraries that had not been built during
the <tt class="COMMAND">make buildworld</tt> phase.</p>
</blockquote>
</div>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN28815" name="AEN28815">21.4.11 Update Files Not Updated by
<tt class="COMMAND">make installworld</tt></a></h2>

<p>Remaking the world will not update certain directories (in particular, <tt
class="FILENAME">/etc</tt>, <tt class="FILENAME">/var</tt> and <tt
class="FILENAME">/usr</tt>) with new or changed configuration files.</p>

<p>The simplest way to update these files is to use <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">mergemaster</span>(8)</span></a>, though
it is possible to do it manually if you would prefer to do that. Regardless of which way
you choose, be sure to make a backup of <tt class="FILENAME">/etc</tt> in case anything
goes wrong.</p>

<div class="SECT3">
<h3 class="SECT3"><a id="MERGEMASTER" name="MERGEMASTER">21.4.11.1 <tt
class="COMMAND">mergemaster</tt></a></h3>

<i class="AUTHORGROUP"><span class="CONTRIB">Contributed by</span> Tom Rhodes.</i> 

<p>The <a href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">mergemaster</span>(8)</span></a> utility
is a Bourne script that will aid you in determining the differences between your
configuration files in <tt class="FILENAME">/etc</tt>, and the configuration files in the
source tree <tt class="FILENAME">/usr/src/etc</tt>. This is the recommended solution for
keeping the system configuration files up to date with those located in the source
tree.</p>

<p>To begin simply type <tt class="COMMAND">mergemaster</tt> at your prompt, and watch it
start going. <tt class="COMMAND">mergemaster</tt> will then build a temporary root
environment, from <tt class="FILENAME">/</tt> down, and populate it with various system
configuration files. Those files are then compared to the ones currently installed in
your system. At this point, files that differ will be shown in <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">diff</span>(1)</span></a> format, with
the <code class="OPTION">+</code> sign representing added or modified lines, and <code
class="OPTION">-</code> representing lines that will be either removed completely, or
replaced with a new line. See the <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">diff</span>(1)</span></a> manual page
for more information about the <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">diff</span>(1)</span></a> syntax and how
file differences are shown.</p>

<p><a href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">mergemaster</span>(8)</span></a> will
then show you each file that displays variances, and at this point you will have the
option of either deleting the new file (referred to as the temporary file), installing
the temporary file in its unmodified state, merging the temporary file with the currently
installed file, or viewing the <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">diff</span>(1)</span></a> results
again.</p>

<p>Choosing to delete the temporary file will tell <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">mergemaster</span>(8)</span></a> that we
wish to keep our current file unchanged, and to delete the new version. This option is
not recommended, unless you see no reason to change the current file. You can get help at
any time by typing <b class="KEYCAP">?</b> at the <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">mergemaster</span>(8)</span></a> prompt.
If the user chooses to skip a file, it will be presented again after all other files have
been dealt with.</p>

<p>Choosing to install the unmodified temporary file will replace the current file with
the new one. For most unmodified files, this is the best option.</p>

<p>Choosing to merge the file will present you with a text editor, and the contents of
both files. You can now merge them by reviewing both files side by side on the screen,
and choosing parts from both to create a finished product. When the files are compared
side by side, the <b class="KEYCAP">l</b> key will select the left contents and the <b
class="KEYCAP">r</b> key will select contents from your right. The final output will be a
file consisting of both parts, which can then be installed. This option is customarily
used for files where settings have been modified by the user.</p>

<p>Choosing to view the <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">diff</span>(1)</span></a> results again
will show you the file differences just like <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">mergemaster</span>(8)</span></a> did
before prompting you for an option.</p>

<p>After <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">mergemaster</span>(8)</span></a> is done
with the system files you will be prompted for other options. <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">mergemaster</span>(8)</span></a> may ask
if you want to rebuild the password file and/or run <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=MAKEDEV&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">MAKEDEV</span>(8)</span></a> if you run
a FreeBSD version prior to 5.0, and will finish up with an option to remove left-over
temporary files.</p>
</div>

<div class="SECT3">
<h3 class="SECT3"><a id="AEN28896" name="AEN28896">21.4.11.2 Manual Update</a></h3>

<p>If you wish to do the update manually, however, you cannot just copy over the files
from <tt class="FILENAME">/usr/src/etc</tt> to <tt class="FILENAME">/etc</tt> and have it
work. Some of these files must be “installed” first. This is because the <tt
class="FILENAME">/usr/src/etc</tt> directory <span class="emphasis"><i
class="EMPHASIS">is not</i></span> a copy of what your <tt class="FILENAME">/etc</tt>
directory should look like. In addition, there are files that should be in <tt
class="FILENAME">/etc</tt> that are not in <tt class="FILENAME">/usr/src/etc</tt>.</p>

<p>If you are using <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">mergemaster</span>(8)</span></a> (as
recommended), you can skip forward to the <a href="makeworld.html#UPDATE-DEV">next
section</a>.</p>

<p>The simplest way to do this by hand is to install the files into a new directory, and
then work through them looking for differences.</p>

<div class="WARNING">
<blockquote class="WARNING">
<p><b>Backup Your Existing <tt class="FILENAME">/etc</tt>:</b> Although, in theory,
nothing is going to touch this directory automatically, it is always better to be sure.
So copy your existing <tt class="FILENAME">/etc</tt> directory somewhere safe. Something
like:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cp -Rp /etc /etc.old</kbd>
</pre>

<p><code class="OPTION">-R</code> does a recursive copy, <code class="OPTION">-p</code>
preserves times, ownerships on files and suchlike.</p>
</blockquote>
</div>

<p>You need to build a dummy set of directories to install the new <tt
class="FILENAME">/etc</tt> and other files into. <tt class="FILENAME">/var/tmp/root</tt>
is a reasonable choice, and there are a number of subdirectories required under this as
well.</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">mkdir /var/tmp/root</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /usr/src/etc</kbd>
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">make DESTDIR=/var/tmp/root distrib-dirs distribution</kbd>
</pre>

<p>This will build the necessary directory structure and install the files. A lot of the
subdirectories that have been created under <tt class="FILENAME">/var/tmp/root</tt> are
empty and should be deleted. The simplest way to do this is to:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /var/tmp/root</kbd>
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">find -d . -type d | xargs rmdir 2&gt;/dev/null</kbd>
</pre>

<p>This will remove all empty directories. (Standard error is redirected to <tt
class="FILENAME">/dev/null</tt> to prevent the warnings about the directories that are
not empty.)</p>

<p><tt class="FILENAME">/var/tmp/root</tt> now contains all the files that should be
placed in appropriate locations below <tt class="FILENAME">/</tt>. You now have to go
through each of these files, determining how they differ with your existing files.</p>

<p>Note that some of the files that will have been installed in <tt
class="FILENAME">/var/tmp/root</tt> have a leading “.”. At the time of writing the only
files like this are shell startup files in <tt class="FILENAME">/var/tmp/root/</tt> and
<tt class="FILENAME">/var/tmp/root/root/</tt>, although there may be others (depending on
when you are reading this). Make sure you use <tt class="COMMAND">ls -a</tt> to catch
them.</p>

<p>The simplest way to do this is to use <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">diff</span>(1)</span></a> to compare the
two files:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">diff /etc/shells /var/tmp/root/etc/shells</kbd>
</pre>

<p>This will show you the differences between your <tt class="FILENAME">/etc/shells</tt>
file and the new <tt class="FILENAME">/var/tmp/root/etc/shells</tt> file. Use these to
decide whether to merge in changes that you have made or whether to copy over your old
file.</p>

<div class="TIP">
<blockquote class="TIP">
<p><b>Name the New Root Directory (<tt class="FILENAME">/var/tmp/root</tt>) with a Time
Stamp, so You Can Easily Compare Differences Between Versions:</b> Frequently rebuilding
the world means that you have to update <tt class="FILENAME">/etc</tt> frequently as
well, which can be a bit of a chore.</p>

<p>You can speed this process up by keeping a copy of the last set of changed files that
you merged into <tt class="FILENAME">/etc</tt>. The following procedure gives one idea of
how to do this.</p>

<div class="PROCEDURE">
<ol type="1">
<li class="STEP">
<p>Make the world as normal. When you want to update <tt class="FILENAME">/etc</tt> and
the other directories, give the target directory a name based on the current date. If you
were doing this on the 14th of February 1998 you could do the following:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">mkdir /var/tmp/root-19980214</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /usr/src/etc</kbd>
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">make DESTDIR=/var/tmp/root-19980214 \
    distrib-dirs distribution</kbd>
</pre>
</li>

<li class="STEP">
<p>Merge in the changes from this directory as outlined above.</p>

<p><span class="emphasis"><i class="EMPHASIS">Do not</i></span> remove the <tt
class="FILENAME">/var/tmp/root-19980214</tt> directory when you have finished.</p>
</li>

<li class="STEP">
<p>When you have downloaded the latest version of the source and remade it, follow step
1. This will give you a new directory, which might be called <tt
class="FILENAME">/var/tmp/root-19980221</tt> (if you wait a week between doing
updates).</p>
</li>

<li class="STEP">
<p>You can now see the differences that have been made in the intervening week using <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">diff</span>(1)</span></a> to create a
recursive diff between the two directories:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /var/tmp</kbd>
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">diff -r root-19980214 root-19980221</kbd>
</pre>

<p>Typically, this will be a much smaller set of differences than those between <tt
class="FILENAME">/var/tmp/root-19980221/etc</tt> and <tt class="FILENAME">/etc</tt>.
Because the set of differences is smaller, it is easier to migrate those changes across
into your <tt class="FILENAME">/etc</tt> directory.</p>
</li>

<li class="STEP">
<p>You can now remove the older of the two <tt class="FILENAME">/var/tmp/root-*</tt>
directories:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">rm -rf /var/tmp/root-19980214</kbd>
</pre>
</li>

<li class="STEP">
<p>Repeat this process every time you need to merge in changes to <tt
class="FILENAME">/etc</tt>.</p>
</li>
</ol>
</div>

<p>You can use <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=date&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">date</span>(1)</span></a> to automate
the generation of the directory names:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">mkdir /var/tmp/root-`date "+%Y%m%d"`</kbd>
</pre>
</blockquote>
</div>
</div>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="UPDATE-DEV" name="UPDATE-DEV">21.4.12 Update <tt
class="FILENAME">/dev</tt></a></h2>

<div class="NOTE">
<blockquote class="NOTE">
<p><b>Note:</b> If you are running FreeBSD&nbsp;5.0 or later you can safely skip this
section. These versions use <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=devfs&amp;sektion=5&amp;manpath=FreeBSD+6-current">
<span class="CITEREFENTRY"><span class="REFENTRYTITLE">devfs</span>(5)</span></a> to
allocate device nodes transparently for the user.</p>
</blockquote>
</div>

<p>In most cases, the <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">mergemaster</span>(8)</span></a> tool
will realize when it is necessary to update the device nodes, and offer to complete it
automatically. These instructions tell how to update the device nodes manually.</p>

<p>For safety's sake, this is a multi-step process.</p>

<div class="PROCEDURE">
<ol type="1">
<li class="STEP">
<p>Copy <tt class="FILENAME">/var/tmp/root/dev/MAKEDEV</tt> to <tt
class="FILENAME">/dev</tt>:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">cp /var/tmp/root/dev/MAKEDEV /dev</kbd>
</pre>

<p>If you used <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=mergemaster&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">mergemaster</span>(8)</span></a> to
update <tt class="FILENAME">/etc</tt>, then your <tt class="FILENAME">MAKEDEV</tt> script
should have been updated already, though it cannot hurt to check (with <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=diff&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">diff</span>(1)</span></a>) and copy it
manually if necessary.</p>
</li>

<li class="STEP">
<p>Now, take a snapshot of your current <tt class="FILENAME">/dev</tt>. This snapshot
needs to contain the permissions, ownerships, major and minor numbers of each filename,
but it should not contain the time stamps. The easiest way to do this is to use <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=awk&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">awk</span>(1)</span></a> to strip out
some of the information:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /dev</kbd>
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">ls -l | awk '{print $1, $2, $3, $4, $5, $6, $NF}' &#62; /var/tmp/dev.out</kbd>
</pre>
</li>

<li class="STEP">
<p>Remake all the device nodes:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">sh MAKEDEV all</kbd>
</pre>
</li>

<li class="STEP">
<p>Write another snapshot of the directory, this time to <tt
class="FILENAME">/var/tmp/dev2.out</tt>. Now look through these two files for any device
node that you missed creating. There should not be any, but it is better to be safe than
sorry.</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">diff /var/tmp/dev.out /var/tmp/dev2.out</kbd>
</pre>

<p>You are most likely to notice disk slice discrepancies which will involve commands
such as:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">sh MAKEDEV sd0s1</kbd>
</pre>

<p>to recreate the slice entries. Your precise circumstances may vary.</p>
</li>
</ol>
</div>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN29080" name="AEN29080">21.4.13 Update <tt
class="FILENAME">/stand</tt></a></h2>

<div class="NOTE">
<blockquote class="NOTE">
<p><b>Note:</b> This step is included only for completeness. It can safely be omitted. If
you are using FreeBSD&nbsp;5.2 or later, the <tt class="FILENAME">/rescue</tt> directory
is automatically updated for the user with current, statically compiled binaries during
<tt class="COMMAND">make installworld</tt>, thus obsoleting the need to update <tt
class="FILENAME">/stand</tt> (which does not exist at all on FreeBSD&nbsp;6.0 and
later).</p>
</blockquote>
</div>

<p>For the sake of completeness, you may want to update the files in <tt
class="FILENAME">/stand</tt> as well. These files consist of hard links to the <tt
class="FILENAME">/stand/sysinstall</tt> binary. This binary should be statically linked,
so that it can work when no other file systems (and in particular <tt
class="FILENAME">/usr</tt>) have been mounted.</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /usr/src/release/sysinstall</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make all install</kbd>
</pre>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN29097" name="AEN29097">21.4.14 Rebooting</a></h2>

<p>You are now done. After you have verified that everything appears to be in the right
place you can reboot the system. A simple <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=shutdown&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">shutdown</span>(8)</span></a> should do
it:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">shutdown -r now</kbd>
</pre>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN29106" name="AEN29106">21.4.15 Finished</a></h2>

<p>You should now have successfully upgraded your FreeBSD system. Congratulations.</p>

<p>If things went slightly wrong, it is easy to rebuild a particular piece of the system.
For example, if you accidentally deleted <tt class="FILENAME">/etc/magic</tt> as part of
the upgrade or merge of <tt class="FILENAME">/etc</tt>, the <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=file&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">file</span>(1)</span></a> command will
stop working. In this case, the fix would be to run:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /usr/src/usr.bin/file</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make all install</kbd>
</pre>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN29120" name="AEN29120">21.4.16 Questions</a></h2>

<div class="QANDASET">
<dl>
<dt>21.4.16.1. <a href="makeworld.html#Q21.4.16.1.">Do I need to re-make the world for
every change?</a></dt>

<dt>21.4.16.2. <a href="makeworld.html#Q21.4.16.2.">My compile failed with lots of signal
11 (or other signal number) errors. What has happened?</a></dt>

<dt>21.4.16.3. <a href="makeworld.html#Q21.4.16.3.">Can I remove <tt
class="FILENAME">/usr/obj</tt> when I have finished?</a></dt>

<dt>21.4.16.4. <a href="makeworld.html#Q21.4.16.4.">Can interrupted builds be
resumed?</a></dt>

<dt>21.4.16.5. <a href="makeworld.html#Q21.4.16.5.">How can I speed up making the
world?</a></dt>

<dt>21.4.16.6. <a href="makeworld.html#Q21.4.16.6.">What do I do if something goes
wrong?</a></dt>
</dl>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="Q21.4.16.1." name="Q21.4.16.1."></a><b>21.4.16.1.</b> Do I need to re-make the
world for every change?</p>
</div>

<div class="ANSWER">
<p><b></b>There is no easy answer to this one, as it depends on the nature of the change.
For example, if you just ran <b class="APPLICATION">CVSup</b>, and it has shown the
following files as being updated:</p>

<pre class="SCREEN">
<tt class="FILENAME">src/games/cribbage/instr.c</tt>
<tt class="FILENAME">src/games/sail/pl_main.c</tt>
<tt class="FILENAME">src/release/sysinstall/config.c</tt>
<tt class="FILENAME">src/release/sysinstall/media.c</tt>
<tt class="FILENAME">src/share/mk/bsd.port.mk</tt>
</pre>

<p>it probably is not worth rebuilding the entire world. You could just go to the
appropriate sub-directories and <tt class="COMMAND">make all install</tt>, and that's
about it. But if something major changed, for example <tt
class="FILENAME">src/lib/libc/stdlib</tt> then you should either re-make the world, or at
least those parts of it that are statically linked (as well as anything else you might
have added that is statically linked).</p>

<p>At the end of the day, it is your call. You might be happy re-making the world every
fortnight say, and let changes accumulate over that fortnight. Or you might want to
re-make just those things that have changed, and be confident you can spot all the
dependencies.</p>

<p>And, of course, this all depends on how often you want to upgrade, and whether you are
tracking FreeBSD-STABLE or FreeBSD-CURRENT.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="Q21.4.16.2." name="Q21.4.16.2."></a><b>21.4.16.2.</b> My compile failed with
lots of signal 11 (or other signal number) errors. What has happened?</p>
</div>

<div class="ANSWER">
<p><b></b>This is normally indicative of hardware problems. (Re)making the world is an
effective way to stress test your hardware, and will frequently throw up memory problems.
These normally manifest themselves as the compiler mysteriously dying on receipt of
strange signals.</p>

<p>A sure indicator of this is if you can restart the make and it dies at a different
point in the process.</p>

<p>In this instance there is little you can do except start swapping around the
components in your machine to determine which one is failing.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="Q21.4.16.3." name="Q21.4.16.3."></a><b>21.4.16.3.</b> Can I remove <tt
class="FILENAME">/usr/obj</tt> when I have finished?</p>
</div>

<div class="ANSWER">
<p><b></b>The short answer is yes.</p>

<p><tt class="FILENAME">/usr/obj</tt> contains all the object files that were produced
during the compilation phase. Normally, one of the first steps in the <tt
class="COMMAND">make buildworld</tt> process is to remove this directory and start
afresh. In this case, keeping <tt class="FILENAME">/usr/obj</tt> around after you have
finished makes little sense, and will free up a large chunk of disk space (currently
about 340&nbsp;MB).</p>

<p>However, if you know what you are doing you can have <tt class="COMMAND">make
buildworld</tt> skip this step. This will make subsequent builds run much faster, since
most of sources will not need to be recompiled. The flip side of this is that subtle
dependency problems can creep in, causing your build to fail in odd ways. This frequently
generates noise on the FreeBSD mailing lists, when one person complains that their build
has failed, not realizing that it is because they have tried to cut corners.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="Q21.4.16.4." name="Q21.4.16.4."></a><b>21.4.16.4.</b> Can interrupted builds be
resumed?</p>
</div>

<div class="ANSWER">
<p><b></b>This depends on how far through the process you got before you found a
problem.</p>

<p><span class="emphasis"><i class="EMPHASIS">In general</i></span> (and this is not a
hard and fast rule) the <tt class="COMMAND">make buildworld</tt> process builds new
copies of essential tools (such as <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=gcc&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">gcc</span>(1)</span></a>, and <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">make</span>(1)</span></a>) and the
system libraries. These tools and libraries are then installed. The new tools and
libraries are then used to rebuild themselves, and are installed again. The entire system
(now including regular user programs, such as <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ls&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ls</span>(1)</span></a> or <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=grep&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">grep</span>(1)</span></a>) is then
rebuilt with the new system files.</p>

<p>If you are at the last stage, and you know it (because you have looked through the
output that you were storing) then you can (fairly safely) do:</p>

<pre class="SCREEN">
<span class="emphasis"><i class="EMPHASIS">... fix the problem ...</i></span>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /usr/src</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make -DNO_CLEAN all</kbd>
</pre>

<div class="NOTE">
<blockquote class="NOTE">
<p><b>Note:</b> On FreeBSD&nbsp;5.X and older, use <tt class="MAKEVAR">-DNOCLEAN</tt>
instead.</p>
</blockquote>
</div>

<p>This will not undo the work of the previous <tt class="COMMAND">make
buildworld</tt>.</p>

<p>If you see the message:</p>

<pre class="SCREEN">
--------------------------------------------------------------
Building everything..
--------------------------------------------------------------
</pre>

<p>in the <tt class="COMMAND">make buildworld</tt> output then it is probably fairly safe
to do so.</p>

<p>If you do not see that message, or you are not sure, then it is always better to be
safe than sorry, and restart the build from scratch.</p>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="Q21.4.16.5." name="Q21.4.16.5."></a><b>21.4.16.5.</b> How can I speed up making
the world?</p>
</div>

<div class="ANSWER">
<p><b></b></p>

<ul class="noindent">
<li>
<p>Run in single user mode.</p>
</li>

<li>
<p>Put the <tt class="FILENAME">/usr/src</tt> and <tt class="FILENAME">/usr/obj</tt>
directories on separate file systems held on separate disks. If possible, put these disks
on separate disk controllers.</p>
</li>

<li>
<p>Better still, put these file systems across multiple disks using the <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ccd&amp;sektion=4"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ccd</span>(4)</span></a> (concatenated
disk driver) device.</p>
</li>

<li>
<p>Turn off profiling (set “NO_PROFILE=true” in <tt
class="FILENAME">/etc/make.conf</tt>). You almost certainly do not need it.</p>
</li>

<li>
<p>Also in <tt class="FILENAME">/etc/make.conf</tt>, set <tt class="MAKEVAR">CFLAGS</tt>
to something like <code class="OPTION">-O -pipe</code>. The optimization <code
class="OPTION">-O2</code> is much slower, and the optimization difference between <code
class="OPTION">-O</code> and <code class="OPTION">-O2</code> is normally negligible.
<code class="OPTION">-pipe</code> lets the compiler use pipes rather than temporary files
for communication, which saves disk access (at the expense of memory).</p>
</li>

<li>
<p>Pass the <code class="OPTION">-j<tt class="REPLACEABLE"><i>n</i></tt></code> option to
<a href="http://www.FreeBSD.org/cgi/man.cgi?query=make&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">make</span>(1)</span></a> to run
multiple processes in parallel. This usually helps regardless of whether you have a
single or a multi processor machine.</p>
</li>

<li>
<p>The file system holding <tt class="FILENAME">/usr/src</tt> can be mounted (or
remounted) with the <code class="OPTION">noatime</code> option. This prevents the file
system from recording the file access time. You probably do not need this information
anyway.</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">mount -u -o noatime /usr/src</kbd>
</pre>

<div class="WARNING">
<blockquote class="WARNING">
<p><b>Warning:</b> The example assumes <tt class="FILENAME">/usr/src</tt> is on its own
file system. If it is not (if it is a part of <tt class="FILENAME">/usr</tt> for example)
then you will need to use that file system mount point, and not <tt
class="FILENAME">/usr/src</tt>.</p>
</blockquote>
</div>
</li>

<li>
<p>The file system holding <tt class="FILENAME">/usr/obj</tt> can be mounted (or
remounted) with the <code class="OPTION">async</code> option. This causes disk writes to
happen asynchronously. In other words, the write completes immediately, and the data is
written to the disk a few seconds later. This allows writes to be clustered together, and
can be a dramatic performance boost.</p>

<div class="WARNING">
<blockquote class="WARNING">
<p><b>Warning:</b> Keep in mind that this option makes your file system more fragile.
With this option there is an increased chance that, should power fail, the file system
will be in an unrecoverable state when the machine restarts.</p>

<p>If <tt class="FILENAME">/usr/obj</tt> is the only thing on this file system then it is
not a problem. If you have other, valuable data on the same file system then ensure your
backups are fresh before you enable this option.</p>
</blockquote>
</div>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">mount -u -o async /usr/obj</kbd>
</pre>

<div class="WARNING">
<blockquote class="WARNING">
<p><b>Warning:</b> As above, if <tt class="FILENAME">/usr/obj</tt> is not on its own file
system, replace it in the example with the name of the appropriate mount point.</p>
</blockquote>
</div>
</li>
</ul>
</div>
</div>

<div class="QANDAENTRY">
<div class="QUESTION">
<p><a id="Q21.4.16.6." name="Q21.4.16.6."></a><b>21.4.16.6.</b> What do I do if something
goes wrong?</p>
</div>

<div class="ANSWER">
<p><b></b>Make absolutely sure your environment has no extraneous cruft from earlier
builds. This is simple enough.</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">chflags -R noschg /usr/obj/usr</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">rm -rf /usr/obj/usr</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /usr/src</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make cleandir</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make cleandir</kbd>
</pre>

<p>Yes, <tt class="COMMAND">make cleandir</tt> really should be run twice.</p>

<p>Then restart the whole process, starting with <tt class="COMMAND">make
buildworld</tt>.</p>

<p>If you still have problems, send the error and the output of <tt class="COMMAND">uname
-a</tt> to <a href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-questions"
target="_top">FreeBSD general questions mailing list</a>. Be prepared to answer other
questions about your setup!</p>
</div>
</div>
</div>
</div>
</div>

<div class="NAVFOOTER">
<hr align="LEFT" width="100%" />
<table summary="Footer navigation table" width="100%" border="0" cellpadding="0"
cellspacing="0">
<tr>
<td width="33%" align="left" valign="top"><a href="synching.html"
accesskey="P">Prev</a></td>
<td width="34%" align="center" valign="top"><a href="index.html"
accesskey="H">Home</a></td>
<td width="33%" align="right" valign="top"><a href="small-lan.html"
accesskey="N">Next</a></td>
</tr>

<tr>
<td width="33%" align="left" valign="top">Synchronizing Your Source</td>
<td width="34%" align="center" valign="top"><a href="cutting-edge.html"
accesskey="U">Up</a></td>
<td width="33%" align="right" valign="top">Tracking for Multiple Machines</td>
</tr>
</table>
</div>

<p align="center"><small>This, and other documents, can be downloaded from <a
href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>.</small></p>

<p align="center"><small>For questions about FreeBSD, read the <a
href="http://www.FreeBSD.org/docs.html">documentation</a> before contacting &#60;<a
href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&#62;.<br />
For questions about this documentation, e-mail &#60;<a
href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&#62;.</small></p>
</body>
</html>

