<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="generator" content="HTML Tidy, see www.w3.org" />
<title>Network Information System (NIS/YP)</title>
<meta name="GENERATOR" content="Modular DocBook HTML Stylesheet Version 1.79" />
<link rel="HOME" title="FreeBSD 使用手冊" href="index.html" />
<link rel="UP" title="Network Servers" href="network-servers.html" />
<link rel="PREVIOUS" title="Network File System (NFS)" href="network-nfs.html" />
<link rel="NEXT" title="Automatic Network Configuration (DHCP)"
href="network-dhcp.html" />
<link rel="STYLESHEET" type="text/css" href="docbook.css" />
<meta http-equiv="Content-Type" content="text/html; charset=Big5" />
</head>
<body class="SECT1" bgcolor="#FFFFFF" text="#000000" link="#0000FF" vlink="#840084"
alink="#0000FF">
<div class="NAVHEADER">
<table summary="Header navigation table" width="100%" border="0" cellpadding="0"
cellspacing="0">
<tr>
<th colspan="3" align="center">FreeBSD 使用手冊</th>
</tr>

<tr>
<td width="10%" align="left" valign="bottom"><a href="network-nfs.html"
accesskey="P">Prev</a></td>
<td width="80%" align="center" valign="bottom">Chapter 25 Network Servers</td>
<td width="10%" align="right" valign="bottom"><a href="network-dhcp.html"
accesskey="N">Next</a></td>
</tr>
</table>

<hr align="LEFT" width="100%" />
</div>

<div class="SECT1">
<h1 class="SECT1"><a id="NETWORK-NIS" name="NETWORK-NIS">25.4 Network Information System
(NIS/YP)</a></h1>

<i class="AUTHORGROUP"><span class="CONTRIB">Written by</span> Bill Swingle.</i> <i
class="AUTHORGROUP"><span class="CONTRIB">Enhanced by</span> Eric Ogren and Udo
Erdelhoff.</i> 

<div class="SECT2">
<h2 class="SECT2"><a id="AEN34939" name="AEN34939">25.4.1 What Is It?</a></h2>

<p><acronym title="Network Information System" class="ACRONYM">NIS</acronym>, which
stands for Network Information Services, was developed by Sun Microsystems to centralize
administration of <span class="TRADEMARK">UNIX</span>&reg; (originally <span
class="TRADEMARK">SunOS</span>&#8482;) systems. It has now essentially become an industry
standard; all major <span class="TRADEMARK">UNIX</span> like systems (<span
class="TRADEMARK">Solaris</span>&#8482;, HP-UX, <span class="TRADEMARK">AIX</span>&reg;,
Linux, NetBSD, OpenBSD, FreeBSD, etc) support <acronym title="Network Information System"
class="ACRONYM">NIS</acronym>.</p>

<p><acronym title="Network Information System" class="ACRONYM">NIS</acronym> was formerly
known as Yellow Pages, but because of trademark issues, Sun changed the name. The old
term (and yp) is still often seen and used.</p>

<p>It is a RPC-based client/server system that allows a group of machines within an NIS
domain to share a common set of configuration files. This permits a system administrator
to set up NIS client systems with only minimal configuration data and add, remove or
modify configuration data from a single location.</p>

<p>It is similar to the <span class="TRADEMARK">Windows&nbsp;NT</span>&reg; domain
system; although the internal implementation of the two are not at all similar, the basic
functionality can be compared.</p>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN34976" name="AEN34976">25.4.2 Terms/Processes You Should
Know</a></h2>

<p>There are several terms and several important user processes that you will come across
when attempting to implement NIS on FreeBSD, whether you are trying to create an NIS
server or act as an NIS client:</p>

<div class="INFORMALTABLE"><a id="AEN34985" name="AEN34985"></a>
<table border="0" frame="void" width="100%" class="CALSTABLE">
<col width="25%" />
<col width="75%" />
<thead>
<tr>
<th>Term</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>NIS domainname</td>
<td>An NIS master server and all of its clients (including its slave servers) have a NIS
domainname. Similar to an <span class="TRADEMARK">Windows&nbsp;NT</span> domain name, the
NIS domainname does not have anything to do with <acronym
class="ACRONYM">DNS</acronym>.</td>
</tr>

<tr>
<td><b class="APPLICATION">rpcbind</b></td>
<td>Must be running in order to enable <acronym class="ACRONYM">RPC</acronym> (Remote
Procedure Call, a network protocol used by NIS). If <b class="APPLICATION">rpcbind</b> is
not running, it will be impossible to run an NIS server, or to act as an NIS client
(Under FreeBSD&nbsp;4.X <b class="APPLICATION">portmap</b> is used in place of <b
class="APPLICATION">rpcbind</b>).</td>
</tr>

<tr>
<td><b class="APPLICATION">ypbind</b></td>
<td>“Binds” an NIS client to its NIS server. It will take the NIS domainname from the
system, and using <acronym class="ACRONYM">RPC</acronym>, connect to the server. <b
class="APPLICATION">ypbind</b> is the core of client-server communication in an NIS
environment; if <b class="APPLICATION">ypbind</b> dies on a client machine, it will not
be able to access the NIS server.</td>
</tr>

<tr>
<td><b class="APPLICATION">ypserv</b></td>
<td>Should only be running on NIS servers; this is the NIS server process itself. If <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ypserv&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ypserv</span>(8)</span></a> dies, then
the server will no longer be able to respond to NIS requests (hopefully, there is a slave
server to take over for it). There are some implementations of NIS (but not the FreeBSD
one), that do not try to reconnect to another server if the server it used before dies.
Often, the only thing that helps in this case is to restart the server process (or even
the whole server) or the <b class="APPLICATION">ypbind</b> process on the client.</td>
</tr>

<tr>
<td><b class="APPLICATION">rpc.yppasswdd</b></td>
<td>Another process that should only be running on NIS master servers; this is a daemon
that will allow NIS clients to change their NIS passwords. If this daemon is not running,
users will have to login to the NIS master server and change their passwords there.</td>
</tr>
</tbody>
</table>
</div>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN35027" name="AEN35027">25.4.3 How Does It Work?</a></h2>

<p>There are three types of hosts in an NIS environment: master servers, slave servers,
and clients. Servers act as a central repository for host configuration information.
Master servers hold the authoritative copy of this information, while slave servers
mirror this information for redundancy. Clients rely on the servers to provide this
information to them.</p>

<p>Information in many files can be shared in this manner. The <tt
class="FILENAME">master.passwd</tt>, <tt class="FILENAME">group</tt>, and <tt
class="FILENAME">hosts</tt> files are commonly shared via NIS. Whenever a process on a
client needs information that would normally be found in these files locally, it makes a
query to the NIS server that it is bound to instead.</p>

<div class="SECT3">
<h3 class="SECT3"><a id="AEN35034" name="AEN35034">25.4.3.1 Machine Types</a></h3>

<ul>
<li>
<p>A <span class="emphasis"><i class="EMPHASIS">NIS master server</i></span>. This
server, analogous to a <span class="TRADEMARK">Windows&nbsp;NT</span> primary domain
controller, maintains the files used by all of the NIS clients. The <tt
class="FILENAME">passwd</tt>, <tt class="FILENAME">group</tt>, and other various files
used by the NIS clients live on the master server.</p>

<div class="NOTE">
<blockquote class="NOTE">
<p><b>Note:</b> It is possible for one machine to be an NIS master server for more than
one NIS domain. However, this will not be covered in this introduction, which assumes a
relatively small-scale NIS environment.</p>
</blockquote>
</div>
</li>

<li>
<p><span class="emphasis"><i class="EMPHASIS">NIS slave servers</i></span>. Similar to
the <span class="TRADEMARK">Windows&nbsp;NT</span> backup domain controllers, NIS slave
servers maintain copies of the NIS master's data files. NIS slave servers provide the
redundancy, which is needed in important environments. They also help to balance the load
of the master server: NIS Clients always attach to the NIS server whose response they get
first, and this includes slave-server-replies.</p>
</li>

<li>
<p><span class="emphasis"><i class="EMPHASIS">NIS clients</i></span>. NIS clients, like
most <span class="TRADEMARK">Windows&nbsp;NT</span> workstations, authenticate against
the NIS server (or the <span class="TRADEMARK">Windows&nbsp;NT</span> domain controller
in the <span class="TRADEMARK">Windows&nbsp;NT</span> workstations case) to log on.</p>
</li>
</ul>
</div>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN35064" name="AEN35064">25.4.4 Using NIS/YP</a></h2>

<p>This section will deal with setting up a sample NIS environment.</p>

<div class="NOTE">
<blockquote class="NOTE">
<p><b>Note:</b> This section assumes that you are running FreeBSD&nbsp;3.3 or later. The
instructions given here will <span class="emphasis"><i
class="EMPHASIS">probably</i></span> work for any version of FreeBSD greater than 3.0,
but there are no guarantees that this is true.</p>
</blockquote>
</div>

<div class="SECT3">
<h3 class="SECT3"><a id="AEN35070" name="AEN35070">25.4.4.1 Planning</a></h3>

<p>Let us assume that you are the administrator of a small university lab. This lab,
which consists of 15 FreeBSD machines, currently has no centralized point of
administration; each machine has its own <tt class="FILENAME">/etc/passwd</tt> and <tt
class="FILENAME">/etc/master.passwd</tt>. These files are kept in sync with each other
only through manual intervention; currently, when you add a user to the lab, you must run
<tt class="COMMAND">adduser</tt> on all 15 machines. Clearly, this has to change, so you
have decided to convert the lab to use NIS, using two of the machines as servers.</p>

<p>Therefore, the configuration of the lab now looks something like:</p>

<div class="INFORMALTABLE"><a id="AEN35077" name="AEN35077"></a>
<table border="0" frame="void" width="100%" class="CALSTABLE">
<col />
<col />
<col />
<thead>
<tr>
<th>Machine name</th>
<th>IP address</th>
<th>Machine role</th>
</tr>
</thead>

<tbody>
<tr>
<td><tt class="HOSTID">ellington</tt></td>
<td><tt class="HOSTID">10.0.0.2</tt></td>
<td>NIS master</td>
</tr>

<tr>
<td><tt class="HOSTID">coltrane</tt></td>
<td><tt class="HOSTID">10.0.0.3</tt></td>
<td>NIS slave</td>
</tr>

<tr>
<td><tt class="HOSTID">basie</tt></td>
<td><tt class="HOSTID">10.0.0.4</tt></td>
<td>Faculty workstation</td>
</tr>

<tr>
<td><tt class="HOSTID">bird</tt></td>
<td><tt class="HOSTID">10.0.0.5</tt></td>
<td>Client machine</td>
</tr>

<tr>
<td><tt class="HOSTID">cli[1-11]</tt></td>
<td><tt class="HOSTID">10.0.0.[6-17]</tt></td>
<td>Other client machines</td>
</tr>
</tbody>
</table>
</div>

<p>If you are setting up a NIS scheme for the first time, it is a good idea to think
through how you want to go about it. No matter what the size of your network, there are a
few decisions that need to be made.</p>

<div class="SECT4">
<h4 class="SECT4"><a id="AEN35116" name="AEN35116">25.4.4.1.1 Choosing a NIS Domain
Name</a></h4>

<p>This might not be the “domainname” that you are used to. It is more accurately
called the “NIS domainname”. When a client broadcasts its requests for info, it
includes the name of the NIS domain that it is part of. This is how multiple servers on
one network can tell which server should answer which request. Think of the NIS
domainname as the name for a group of hosts that are related in some way.</p>

<p>Some organizations choose to use their Internet domainname for their NIS domainname.
This is not recommended as it can cause confusion when trying to debug network problems.
The NIS domainname should be unique within your network and it is helpful if it describes
the group of machines it represents. For example, the Art department at Acme Inc. might
be in the “acme-art” NIS domain. For this example, assume you have chosen the name <tt
class="LITERAL">test-domain</tt>.</p>

<p>However, some operating systems (notably <span class="TRADEMARK">SunOS</span>) use
their NIS domain name as their Internet domain name. If one or more machines on your
network have this restriction, you <span class="emphasis"><i
class="EMPHASIS">must</i></span> use the Internet domain name as your NIS domain
name.</p>
</div>

<div class="SECT4">
<h4 class="SECT4"><a id="AEN35132" name="AEN35132">25.4.4.1.2 Physical Server
Requirements</a></h4>

<p>There are several things to keep in mind when choosing a machine to use as a NIS
server. One of the unfortunate things about NIS is the level of dependency the clients
have on the server. If a client cannot contact the server for its NIS domain, very often
the machine becomes unusable. The lack of user and group information causes most systems
to temporarily freeze up. With this in mind you should make sure to choose a machine that
will not be prone to being rebooted regularly, or one that might be used for development.
The NIS server should ideally be a stand alone machine whose sole purpose in life is to
be an NIS server. If you have a network that is not very heavily used, it is acceptable
to put the NIS server on a machine running other services, just keep in mind that if the
NIS server becomes unavailable, it will affect <span class="emphasis"><i
class="EMPHASIS">all</i></span> of your NIS clients adversely.</p>
</div>
</div>

<div class="SECT3">
<h3 class="SECT3"><a id="AEN35136" name="AEN35136">25.4.4.2 NIS Servers</a></h3>

<p>The canonical copies of all NIS information are stored on a single machine called the
NIS master server. The databases used to store the information are called NIS maps. In
FreeBSD, these maps are stored in <tt class="FILENAME">/var/yp/[domainname]</tt> where
<tt class="FILENAME">[domainname]</tt> is the name of the NIS domain being served. A
single NIS server can support several domains at once, therefore it is possible to have
several such directories, one for each supported domain. Each domain will have its own
independent set of maps.</p>

<p>NIS master and slave servers handle all NIS requests with the <tt
class="COMMAND">ypserv</tt> daemon. <tt class="COMMAND">ypserv</tt> is responsible for
receiving incoming requests from NIS clients, translating the requested domain and map
name to a path to the corresponding database file and transmitting data from the database
back to the client.</p>

<div class="SECT4">
<h4 class="SECT4"><a id="AEN35144" name="AEN35144">25.4.4.2.1 Setting Up a NIS Master
Server</a></h4>

<p>Setting up a master NIS server can be relatively straight forward, depending on your
needs. FreeBSD comes with support for NIS out-of-the-box. All you need is to add the
following lines to <tt class="FILENAME">/etc/rc.conf</tt>, and FreeBSD will do the rest
for you.</p>

<div class="PROCEDURE">
<ol type="1">
<li class="STEP">
<pre class="PROGRAMLISTING">
nisdomainname="test-domain"
</pre>

This line will set the NIS domainname to <tt class="LITERAL">test-domain</tt> upon
network setup (e.g. after reboot).<br />
<br />
</li>

<li class="STEP">
<pre class="PROGRAMLISTING">
nis_server_enable="YES"
</pre>

This will tell FreeBSD to start up the NIS server processes when the networking is next
brought up.<br />
<br />
</li>

<li class="STEP">
<pre class="PROGRAMLISTING">
nis_yppasswdd_enable="YES"
</pre>

This will enable the <tt class="COMMAND">rpc.yppasswdd</tt> daemon which, as mentioned
above, will allow users to change their NIS password from a client machine.<br />
<br />
</li>
</ol>
</div>

<div class="NOTE">
<blockquote class="NOTE">
<p><b>Note:</b> Depending on your NIS setup, you may need to add further entries. See the
<a href="network-nis.html#NETWORK-NIS-SERVER-IS-CLIENT">section about NIS servers that
are also NIS clients</a>, below, for details.</p>
</blockquote>
</div>

<p>Now, all you have to do is to run the command <tt class="COMMAND">/etc/netstart</tt>
as superuser. It will set up everything for you, using the values you defined in <tt
class="FILENAME">/etc/rc.conf</tt>.</p>
</div>

<div class="SECT4">
<h4 class="SECT4"><a id="AEN35169" name="AEN35169">25.4.4.2.2 Initializing the NIS
Maps</a></h4>

<p>The <span class="emphasis"><i class="EMPHASIS">NIS maps</i></span> are database files,
that are kept in the <tt class="FILENAME">/var/yp</tt> directory. They are generated from
configuration files in the <tt class="FILENAME">/etc</tt> directory of the NIS master,
with one exception: the <tt class="FILENAME">/etc/master.passwd</tt> file. This is for a
good reason, you do not want to propagate passwords to your <tt
class="USERNAME">root</tt> and other administrative accounts to all the servers in the
NIS domain. Therefore, before we initialize the NIS maps, you should:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">cp /etc/master.passwd /var/yp/master.passwd</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /var/yp</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">vi master.passwd</kbd>
</pre>

<p>You should remove all entries regarding system accounts (<tt
class="USERNAME">bin</tt>, <tt class="USERNAME">tty</tt>, <tt class="USERNAME">kmem</tt>,
<tt class="USERNAME">games</tt>, etc), as well as any accounts that you do not want to be
propagated to the NIS clients (for example <tt class="USERNAME">root</tt> and any other
UID 0 (superuser) accounts).</p>

<div class="NOTE">
<blockquote class="NOTE">
<p><b>Note:</b> Make sure the <tt class="FILENAME">/var/yp/master.passwd</tt> is neither
group nor world readable (mode 600)! Use the <tt class="COMMAND">chmod</tt> command, if
appropriate.</p>
</blockquote>
</div>

<p>When you have finished, it is time to initialize the NIS maps! FreeBSD includes a
script named <tt class="COMMAND">ypinit</tt> to do this for you (see its manual page for
more information). Note that this script is available on most <span
class="TRADEMARK">UNIX</span> Operating Systems, but not on all. On Digital UNIX/Compaq
Tru64 UNIX it is called <tt class="COMMAND">ypsetup</tt>. Because we are generating maps
for an NIS master, we are going to pass the <code class="OPTION">-m</code> option to <tt
class="COMMAND">ypinit</tt>. To generate the NIS maps, assuming you already performed the
steps above, run:</p>

<pre class="SCREEN">
ellington<samp class="PROMPT">#</samp> <kbd class="USERINPUT">ypinit -m test-domain</kbd>
Server Type: MASTER Domain: test-domain
Creating an YP server will require that you answer a few questions.
Questions will all be asked at the beginning of the procedure.
Do you want this procedure to quit on non-fatal errors? [y/n: n] <kbd
class="USERINPUT">n</kbd>
Ok, please remember to go back and redo manually whatever fails.
If you don't, something might not work.
At this point, we have to construct a list of this domains YP servers.
rod.darktech.org is already known as master server.
Please continue to add any slave servers, one per line. When you are
done with the list, type a &lt;control D&gt;.
master server   :  ellington
next host to add:  <kbd class="USERINPUT">coltrane</kbd>
next host to add:  <kbd class="USERINPUT">^D</kbd>
The current list of NIS servers looks like this:
ellington
coltrane
Is this correct?  [y/n: y] <kbd class="USERINPUT">y</kbd>

[..output from map generation..]

NIS Map update completed.
ellington has been setup as an YP master server without any errors.
</pre>

<p><tt class="COMMAND">ypinit</tt> should have created <tt
class="FILENAME">/var/yp/Makefile</tt> from <tt
class="FILENAME">/var/yp/Makefile.dist</tt>. When created, this file assumes that you are
operating in a single server NIS environment with only FreeBSD machines. Since <tt
class="LITERAL">test-domain</tt> has a slave server as well, you must edit <tt
class="FILENAME">/var/yp/Makefile</tt>:</p>

<pre class="SCREEN">
ellington<samp class="PROMPT">#</samp> <kbd class="USERINPUT">vi /var/yp/Makefile</kbd>
</pre>

<p>You should comment out the line that says</p>

<pre class="PROGRAMLISTING">
NOPUSH = "True"
</pre>

<p>(if it is not commented out already).</p>
</div>

<div class="SECT4">
<h4 class="SECT4"><a id="AEN35224" name="AEN35224">25.4.4.2.3 Setting up a NIS Slave
Server</a></h4>

<p>Setting up an NIS slave server is even more simple than setting up the master. Log on
to the slave server and edit the file <tt class="FILENAME">/etc/rc.conf</tt> as you did
before. The only difference is that we now must use the <code class="OPTION">-s</code>
option when running <tt class="COMMAND">ypinit</tt>. The <code class="OPTION">-s</code>
option requires the name of the NIS master be passed to it as well, so our command line
looks like:</p>

<pre class="SCREEN">
coltrane<samp class="PROMPT">#</samp> <kbd
class="USERINPUT">ypinit -s ellington test-domain</kbd>

Server Type: SLAVE Domain: test-domain Master: ellington

Creating an YP server will require that you answer a few questions.
Questions will all be asked at the beginning of the procedure.

Do you want this procedure to quit on non-fatal errors? [y/n: n]  <kbd
class="USERINPUT">n</kbd>

Ok, please remember to go back and redo manually whatever fails.
If you don't, something might not work.
There will be no further questions. The remainder of the procedure
should take a few minutes, to copy the databases from ellington.
Transferring netgroup...
ypxfr: Exiting: Map successfully transferred
Transferring netgroup.byuser...
ypxfr: Exiting: Map successfully transferred
Transferring netgroup.byhost...
ypxfr: Exiting: Map successfully transferred
Transferring master.passwd.byuid...
ypxfr: Exiting: Map successfully transferred
Transferring passwd.byuid...
ypxfr: Exiting: Map successfully transferred
Transferring passwd.byname...
ypxfr: Exiting: Map successfully transferred
Transferring group.bygid...
ypxfr: Exiting: Map successfully transferred
Transferring group.byname...
ypxfr: Exiting: Map successfully transferred
Transferring services.byname...
ypxfr: Exiting: Map successfully transferred
Transferring rpc.bynumber...
ypxfr: Exiting: Map successfully transferred
Transferring rpc.byname...
ypxfr: Exiting: Map successfully transferred
Transferring protocols.byname...
ypxfr: Exiting: Map successfully transferred
Transferring master.passwd.byname...
ypxfr: Exiting: Map successfully transferred
Transferring networks.byname...
ypxfr: Exiting: Map successfully transferred
Transferring networks.byaddr...
ypxfr: Exiting: Map successfully transferred
Transferring netid.byname...
ypxfr: Exiting: Map successfully transferred
Transferring hosts.byaddr...
ypxfr: Exiting: Map successfully transferred
Transferring protocols.bynumber...
ypxfr: Exiting: Map successfully transferred
Transferring ypservers...
ypxfr: Exiting: Map successfully transferred
Transferring hosts.byname...
ypxfr: Exiting: Map successfully transferred

coltrane has been setup as an YP slave server without any errors.
Don't forget to update map ypservers on ellington.
</pre>

<p>You should now have a directory called <tt class="FILENAME">/var/yp/test-domain</tt>.
Copies of the NIS master server's maps should be in this directory. You will need to make
sure that these stay updated. The following <tt class="FILENAME">/etc/crontab</tt>
entries on your slave servers should do the job:</p>

<pre class="PROGRAMLISTING">
20      *       *       *       *       root   /usr/libexec/ypxfr passwd.byname
21      *       *       *       *       root   /usr/libexec/ypxfr passwd.byuid
</pre>

<p>These two lines force the slave to sync its maps with the maps on the master server.
Although these entries are not mandatory, since the master server attempts to ensure any
changes to its NIS maps are communicated to its slaves and because password information
is vital to systems depending on the server, it is a good idea to force the updates. This
is more important on busy networks where map updates might not always complete.</p>

<p>Now, run the command <tt class="COMMAND">/etc/netstart</tt> on the slave server as
well, which again starts the NIS server.</p>
</div>
</div>

<div class="SECT3">
<h3 class="SECT3"><a id="AEN35245" name="AEN35245">25.4.4.3 NIS Clients</a></h3>

<p>An NIS client establishes what is called a binding to a particular NIS server using
the <tt class="COMMAND">ypbind</tt> daemon. <tt class="COMMAND">ypbind</tt> checks the
system's default domain (as set by the <tt class="COMMAND">domainname</tt> command), and
begins broadcasting RPC requests on the local network. These requests specify the name of
the domain for which <tt class="COMMAND">ypbind</tt> is attempting to establish a
binding. If a server that has been configured to serve the requested domain receives one
of the broadcasts, it will respond to <tt class="COMMAND">ypbind</tt>, which will record
the server's address. If there are several servers available (a master and several
slaves, for example), <tt class="COMMAND">ypbind</tt> will use the address of the first
one to respond. From that point on, the client system will direct all of its NIS requests
to that server. <tt class="COMMAND">ypbind</tt> will occasionally “ping” the server to
make sure it is still up and running. If it fails to receive a reply to one of its pings
within a reasonable amount of time, <tt class="COMMAND">ypbind</tt> will mark the domain
as unbound and begin broadcasting again in the hopes of locating another server.</p>

<div class="SECT4">
<h4 class="SECT4"><a id="AEN35257" name="AEN35257">25.4.4.3.1 Setting Up a NIS
Client</a></h4>

<p>Setting up a FreeBSD machine to be a NIS client is fairly straightforward.</p>

<div class="PROCEDURE">
<ol type="1">
<li class="STEP">
<p>Edit the file <tt class="FILENAME">/etc/rc.conf</tt> and add the following lines in
order to set the NIS domainname and start <tt class="COMMAND">ypbind</tt> upon network
startup:</p>

<pre class="PROGRAMLISTING">
nisdomainname="test-domain"
nis_client_enable="YES"
</pre>
</li>

<li class="STEP">
<p>To import all possible password entries from the NIS server, remove all user accounts
from your <tt class="FILENAME">/etc/master.passwd</tt> file and use <tt
class="COMMAND">vipw</tt> to add the following line to the end of the file:</p>

<pre class="PROGRAMLISTING">
+:::::::::
</pre>

<div class="NOTE">
<blockquote class="NOTE">
<p><b>Note:</b> This line will afford anyone with a valid account in the NIS server's
password maps an account. There are many ways to configure your NIS client by changing
this line. See the <a href="network-nis.html#NETWORK-NETGROUPS">netgroups section</a>
below for more information. For more detailed reading see O'Reilly's book on <tt
class="LITERAL">Managing NFS and NIS</tt>.</p>
</blockquote>
</div>

<div class="NOTE">
<blockquote class="NOTE">
<p><b>Note:</b> You should keep at least one local account (i.e. not imported via NIS) in
your <tt class="FILENAME">/etc/master.passwd</tt> and this account should also be a
member of the group <tt class="GROUPNAME">wheel</tt>. If there is something wrong with
NIS, this account can be used to log in remotely, become <tt class="USERNAME">root</tt>,
and fix things.</p>
</blockquote>
</div>
</li>

<li class="STEP">
<p>To import all possible group entries from the NIS server, add this line to your <tt
class="FILENAME">/etc/group</tt> file:</p>

<pre class="PROGRAMLISTING">
+:*::
</pre>
</li>
</ol>
</div>

<p>After completing these steps, you should be able to run <tt class="COMMAND">ypcat
passwd</tt> and see the NIS server's passwd map.</p>
</div>
</div>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN35289" name="AEN35289">25.4.5 NIS Security</a></h2>

<p>In general, any remote user can issue an RPC to <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ypserv&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ypserv</span>(8)</span></a> and retrieve
the contents of your NIS maps, provided the remote user knows your domainname. To prevent
such unauthorized transactions, <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ypserv&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ypserv</span>(8)</span></a> supports a
feature called “securenets” which can be used to restrict access to a given set of
hosts. At startup, <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ypserv&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ypserv</span>(8)</span></a> will attempt
to load the securenets information from a file called <tt
class="FILENAME">/var/yp/securenets</tt>.</p>

<div class="NOTE">
<blockquote class="NOTE">
<p><b>Note:</b> This path varies depending on the path specified with the <code
class="OPTION">-p</code> option. This file contains entries that consist of a network
specification and a network mask separated by white space. Lines starting with “#” are
considered to be comments. A sample securenets file might look like this:</p>
</blockquote>
</div>

<pre class="PROGRAMLISTING">
# allow connections from local host -- mandatory
127.0.0.1     255.255.255.255
# allow connections from any host
# on the 192.168.128.0 network
192.168.128.0 255.255.255.0
# allow connections from any host
# between 10.0.0.0 to 10.0.15.255
# this includes the machines in the testlab
10.0.0.0      255.255.240.0
</pre>

<p>If <a href="http://www.FreeBSD.org/cgi/man.cgi?query=ypserv&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ypserv</span>(8)</span></a> receives a
request from an address that matches one of these rules, it will process the request
normally. If the address fails to match a rule, the request will be ignored and a warning
message will be logged. If the <tt class="FILENAME">/var/yp/securenets</tt> file does not
exist, <tt class="COMMAND">ypserv</tt> will allow connections from any host.</p>

<p>The <tt class="COMMAND">ypserv</tt> program also has support for Wietse Venema's <b
class="APPLICATION">TCP Wrapper</b> package. This allows the administrator to use the <b
class="APPLICATION">TCP Wrapper</b> configuration files for access control instead of <tt
class="FILENAME">/var/yp/securenets</tt>.</p>

<div class="NOTE">
<blockquote class="NOTE">
<p><b>Note:</b> While both of these access control mechanisms provide some security,
they, like the privileged port test, are vulnerable to “IP spoofing” attacks. All
NIS-related traffic should be blocked at your firewall.</p>

<p>Servers using <tt class="FILENAME">/var/yp/securenets</tt> may fail to serve
legitimate NIS clients with archaic TCP/IP implementations. Some of these implementations
set all host bits to zero when doing broadcasts and/or fail to observe the subnet mask
when calculating the broadcast address. While some of these problems can be fixed by
changing the client configuration, other problems may force the retirement of the client
systems in question or the abandonment of <tt
class="FILENAME">/var/yp/securenets</tt>.</p>

<p>Using <tt class="FILENAME">/var/yp/securenets</tt> on a server with such an archaic
implementation of TCP/IP is a really bad idea and will lead to loss of NIS functionality
for large parts of your network.</p>

<p>The use of the <b class="APPLICATION">TCP Wrapper</b> package increases the latency of
your NIS server. The additional delay may be long enough to cause timeouts in client
programs, especially in busy networks or with slow NIS servers. If one or more of your
client systems suffers from these symptoms, you should convert the client systems in
question into NIS slave servers and force them to bind to themselves.</p>
</blockquote>
</div>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN35331" name="AEN35331">25.4.6 Barring Some Users from Logging
On</a></h2>

<p>In our lab, there is a machine <tt class="HOSTID">basie</tt> that is supposed to be a
faculty only workstation. We do not want to take this machine out of the NIS domain, yet
the <tt class="FILENAME">passwd</tt> file on the master NIS server contains accounts for
both faculty and students. What can we do?</p>

<p>There is a way to bar specific users from logging on to a machine, even if they are
present in the NIS database. To do this, all you must do is add <tt class="LITERAL">-<tt
class="REPLACEABLE"><i>username</i></tt></tt> to the end of the <tt
class="FILENAME">/etc/master.passwd</tt> file on the client machine, where <tt
class="REPLACEABLE"><i>username</i></tt> is the username of the user you wish to bar from
logging in. This should preferably be done using <tt class="COMMAND">vipw</tt>, since <tt
class="COMMAND">vipw</tt> will sanity check your changes to <tt
class="FILENAME">/etc/master.passwd</tt>, as well as automatically rebuild the password
database when you finish editing. For example, if we wanted to bar user <tt
class="USERNAME">bill</tt> from logging on to <tt class="HOSTID">basie</tt> we would:</p>

<pre class="SCREEN">
basie<samp class="PROMPT">#</samp> <kbd class="USERINPUT">vipw</kbd>
<kbd class="USERINPUT">[add -bill to the end, exit]</kbd>
vipw: rebuilding the database...
vipw: done

basie<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cat /etc/master.passwd</kbd>

root:[password]:0:0::0:0:The super-user:/root:/bin/csh
toor:[password]:0:0::0:0:The other super-user:/root:/bin/sh
daemon:*:1:1::0:0:Owner of many system processes:/root:/sbin/nologin
operator:*:2:5::0:0:System &#38;:/:/sbin/nologin
bin:*:3:7::0:0:Binaries Commands and Source,,,:/:/sbin/nologin
tty:*:4:65533::0:0:Tty Sandbox:/:/sbin/nologin
kmem:*:5:65533::0:0:KMem Sandbox:/:/sbin/nologin
games:*:7:13::0:0:Games pseudo-user:/usr/games:/sbin/nologin
news:*:8:8::0:0:News Subsystem:/:/sbin/nologin
man:*:9:9::0:0:Mister Man Pages:/usr/share/man:/sbin/nologin
bind:*:53:53::0:0:Bind Sandbox:/:/sbin/nologin
uucp:*:66:66::0:0:UUCP pseudo-user:/var/spool/uucppublic:/usr/libexec/uucp/uucico
xten:*:67:67::0:0:X-10 daemon:/usr/local/xten:/sbin/nologin
pop:*:68:6::0:0:Post Office Owner:/nonexistent:/sbin/nologin
nobody:*:65534:65534::0:0:Unprivileged user:/nonexistent:/sbin/nologin
+:::::::::
-bill

basie<samp class="PROMPT">#</samp>
</pre>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="NETWORK-NETGROUPS" name="NETWORK-NETGROUPS">25.4.7 Using
Netgroups</a></h2>

<i class="AUTHORGROUP"><span class="CONTRIB">Contributed by</span> Udo Erdelhoff.</i> 

<p>The method shown in the previous section works reasonably well if you need special
rules for a very small number of users and/or machines. On larger networks, you <span
class="emphasis"><i class="EMPHASIS">will</i></span> forget to bar some users from
logging onto sensitive machines, or you may even have to modify each machine separately,
thus losing the main benefit of NIS: <span class="emphasis"><i
class="EMPHASIS">centralized</i></span> administration.</p>

<p>The NIS developers' solution for this problem is called <span class="emphasis"><i
class="EMPHASIS">netgroups</i></span>. Their purpose and semantics can be compared to the
normal groups used by <span class="TRADEMARK">UNIX</span> file systems. The main
differences are the lack of a numeric ID and the ability to define a netgroup by
including both user accounts and other netgroups.</p>

<p>Netgroups were developed to handle large, complex networks with hundreds of users and
machines. On one hand, this is a Good Thing if you are forced to deal with such a
situation. On the other hand, this complexity makes it almost impossible to explain
netgroups with really simple examples. The example used in the remainder of this section
demonstrates this problem.</p>

<p>Let us assume that your successful introduction of NIS in your laboratory caught your
superiors' interest. Your next job is to extend your NIS domain to cover some of the
other machines on campus. The two tables contain the names of the new users and new
machines as well as brief descriptions of them.</p>

<div class="INFORMALTABLE"><a id="AEN35371" name="AEN35371"></a>
<table border="0" frame="void" width="100%" class="CALSTABLE">
<col />
<col />
<thead>
<tr>
<th>User Name(s)</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td><tt class="USERNAME">alpha</tt>, <tt class="USERNAME">beta</tt></td>
<td>Normal employees of the IT department</td>
</tr>

<tr>
<td><tt class="USERNAME">charlie</tt>, <tt class="USERNAME">delta</tt></td>
<td>The new apprentices of the IT department</td>
</tr>

<tr>
<td><tt class="USERNAME">echo</tt>, <tt class="USERNAME">foxtrott</tt>, <tt
class="USERNAME">golf</tt>, ...</td>
<td>Ordinary employees</td>
</tr>

<tr>
<td><tt class="USERNAME">able</tt>, <tt class="USERNAME">baker</tt>, ...</td>
<td>The current interns</td>
</tr>
</tbody>
</table>
</div>

<div class="INFORMALTABLE"><a id="AEN35399" name="AEN35399"></a>
<table border="0" frame="void" width="100%" class="CALSTABLE">
<col />
<col />
<thead>
<tr>
<th>Machine Name(s)</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td><tt class="HOSTID">war</tt>, <tt class="HOSTID">death</tt>, <tt
class="HOSTID">famine</tt>, <tt class="HOSTID">pollution</tt></td>
<td>Your most important servers. Only the IT employees are allowed to log onto these
machines.</td>
</tr>

<tr>
<td><tt class="HOSTID">pride</tt>, <tt class="HOSTID">greed</tt>, <tt
class="HOSTID">envy</tt>, <tt class="HOSTID">wrath</tt>, <tt class="HOSTID">lust</tt>,
<tt class="HOSTID">sloth</tt></td>
<td>Less important servers. All members of the IT department are allowed to login onto
these machines.</td>
</tr>

<tr>
<td><tt class="HOSTID">one</tt>, <tt class="HOSTID">two</tt>, <tt
class="HOSTID">three</tt>, <tt class="HOSTID">four</tt>, ...</td>
<td>Ordinary workstations. Only the <span class="emphasis"><i
class="EMPHASIS">real</i></span> employees are allowed to use these machines.</td>
</tr>

<tr>
<td><tt class="HOSTID">trashcan</tt></td>
<td>A very old machine without any critical data. Even the intern is allowed to use this
box.</td>
</tr>
</tbody>
</table>
</div>

<p>If you tried to implement these restrictions by separately blocking each user, you
would have to add one <tt class="LITERAL">-<tt class="REPLACEABLE"><i>user</i></tt></tt>
line to each system's <tt class="FILENAME">passwd</tt> for each user who is not allowed
to login onto that system. If you forget just one entry, you could be in trouble. It may
be feasible to do this correctly during the initial setup, however you <span
class="emphasis"><i class="EMPHASIS">will</i></span> eventually forget to add the lines
for new users during day-to-day operations. After all, Murphy was an optimist.</p>

<p>Handling this situation with netgroups offers several advantages. Each user need not
be handled separately; you assign a user to one or more netgroups and allow or forbid
logins for all members of the netgroup. If you add a new machine, you will only have to
define login restrictions for netgroups. If a new user is added, you will only have to
add the user to one or more netgroups. Those changes are independent of each other: no
more “for each combination of user and machine do...” If your NIS setup is planned
carefully, you will only have to modify exactly one central configuration file to grant
or deny access to machines.</p>

<p>The first step is the initialization of the NIS map netgroup. FreeBSD's <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=ypinit&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ypinit</span>(8)</span></a> does not
create this map by default, but its NIS implementation will support it once it has been
created. To create an empty map, simply type</p>

<pre class="SCREEN">
ellington<samp class="PROMPT">#</samp> <kbd class="USERINPUT">vi /var/yp/netgroup</kbd>
</pre>

<p>and start adding content. For our example, we need at least four netgroups: IT
employees, IT apprentices, normal employees and interns.</p>

<pre class="PROGRAMLISTING">
IT_EMP  (,alpha,test-domain)    (,beta,test-domain)
IT_APP  (,charlie,test-domain)  (,delta,test-domain)
USERS   (,echo,test-domain)     (,foxtrott,test-domain) \
        (,golf,test-domain)
INTERNS (,able,test-domain)     (,baker,test-domain)
</pre>

<p><tt class="LITERAL">IT_EMP</tt>, <tt class="LITERAL">IT_APP</tt> etc. are the names of
the netgroups. Each bracketed group adds one or more user accounts to it. The three
fields inside a group are:</p>

<ol type="1">
<li>
<p>The name of the host(s) where the following items are valid. If you do not specify a
hostname, the entry is valid on all hosts. If you do specify a hostname, you will enter a
realm of darkness, horror and utter confusion.</p>
</li>

<li>
<p>The name of the account that belongs to this netgroup.</p>
</li>

<li>
<p>The NIS domain for the account. You can import accounts from other NIS domains into
your netgroup if you are one of the unlucky fellows with more than one NIS domain.</p>
</li>
</ol>

<p>Each of these fields can contain wildcards. See <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=netgroup&amp;sektion=5"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">netgroup</span>(5)</span></a> for
details.</p>

<div class="NOTE">
<blockquote class="NOTE">
<p><b>Note:</b> Netgroup names longer than 8 characters should not be used, especially if
you have machines running other operating systems within your NIS domain. The names are
case sensitive; using capital letters for your netgroup names is an easy way to
distinguish between user, machine and netgroup names.</p>

<p>Some NIS clients (other than FreeBSD) cannot handle netgroups with a large number of
entries. For example, some older versions of <span class="TRADEMARK">SunOS</span> start
to cause trouble if a netgroup contains more than 15 <span class="emphasis"><i
class="EMPHASIS">entries</i></span>. You can circumvent this limit by creating several
sub-netgroups with 15 users or less and a real netgroup that consists of the
sub-netgroups:</p>

<pre class="PROGRAMLISTING">
BIGGRP1  (,joe1,domain)  (,joe2,domain)  (,joe3,domain) [...]
BIGGRP2  (,joe16,domain)  (,joe17,domain) [...]
BIGGRP3  (,joe31,domain)  (,joe32,domain)
BIGGROUP  BIGGRP1 BIGGRP2 BIGGRP3
</pre>

<p>You can repeat this process if you need more than 225 users within a single
netgroup.</p>
</blockquote>
</div>

<p>Activating and distributing your new NIS map is easy:</p>

<pre class="SCREEN">
ellington<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /var/yp</kbd>
ellington<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make</kbd>
</pre>

<p>This will generate the three NIS maps <tt class="FILENAME">netgroup</tt>, <tt
class="FILENAME">netgroup.byhost</tt> and <tt class="FILENAME">netgroup.byuser</tt>. Use
<a href="http://www.FreeBSD.org/cgi/man.cgi?query=ypcat&amp;sektion=1"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ypcat</span>(1)</span></a> to check if
your new NIS maps are available:</p>

<pre class="SCREEN">
ellington<samp class="PROMPT">%</samp> <kbd class="USERINPUT">ypcat -k netgroup</kbd>
ellington<samp class="PROMPT">%</samp> <kbd
class="USERINPUT">ypcat -k netgroup.byhost</kbd>
ellington<samp class="PROMPT">%</samp> <kbd
class="USERINPUT">ypcat -k netgroup.byuser</kbd>
</pre>

<p>The output of the first command should resemble the contents of <tt
class="FILENAME">/var/yp/netgroup</tt>. The second command will not produce output if you
have not specified host-specific netgroups. The third command can be used to get the list
of netgroups for a user.</p>

<p>The client setup is quite simple. To configure the server <tt class="HOSTID">war</tt>,
you only have to start <a
href="http://www.FreeBSD.org/cgi/man.cgi?query=vipw&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">vipw</span>(8)</span></a> and replace
the line</p>

<pre class="PROGRAMLISTING">
+:::::::::
</pre>

<p>with</p>

<pre class="PROGRAMLISTING">
+@IT_EMP:::::::::
</pre>

<p>Now, only the data for the users defined in the netgroup <tt
class="LITERAL">IT_EMP</tt> is imported into <tt class="HOSTID">war</tt>'s password
database and only these users are allowed to login.</p>

<p>Unfortunately, this limitation also applies to the <tt class="LITERAL">~</tt> function
of the shell and all routines converting between user names and numerical user IDs. In
other words, <tt class="COMMAND">cd ~<tt class="REPLACEABLE"><i>user</i></tt></tt> will
not work, <tt class="COMMAND">ls -l</tt> will show the numerical ID instead of the
username and <tt class="COMMAND">find . -user joe -print</tt> will fail with “<tt
class="ERRORNAME">No such user</tt>”. To fix this, you will have to import all user
entries <span class="emphasis"><i class="EMPHASIS">without allowing them to login onto
your servers</i></span>.</p>

<p>This can be achieved by adding another line to <tt
class="FILENAME">/etc/master.passwd</tt>. This line should contain:</p>

<p><tt class="LITERAL">+:::::::::/sbin/nologin</tt>, meaning “Import all entries but
replace the shell with <tt class="FILENAME">/sbin/nologin</tt> in the imported entries”.
You can replace any field in the <tt class="LITERAL">passwd</tt> entry by placing a
default value in your <tt class="FILENAME">/etc/master.passwd</tt>.</p>

<div class="WARNING">
<blockquote class="WARNING">
<p><b>Warning:</b> Make sure that the line <tt
class="LITERAL">+:::::::::/sbin/nologin</tt> is placed after <tt
class="LITERAL">+@IT_EMP:::::::::</tt>. Otherwise, all user accounts imported from NIS
will have <tt class="FILENAME">/sbin/nologin</tt> as their login shell.</p>
</blockquote>
</div>

<p>After this change, you will only have to change one NIS map if a new employee joins
the IT department. You could use a similar approach for the less important servers by
replacing the old <tt class="LITERAL">+:::::::::</tt> in their local version of <tt
class="FILENAME">/etc/master.passwd</tt> with something like this:</p>

<pre class="PROGRAMLISTING">
+@IT_EMP:::::::::
+@IT_APP:::::::::
+:::::::::/sbin/nologin
</pre>

<p>The corresponding lines for the normal workstations could be:</p>

<pre class="PROGRAMLISTING">
+@IT_EMP:::::::::
+@USERS:::::::::
+:::::::::/sbin/nologin
</pre>

<p>And everything would be fine until there is a policy change a few weeks later: The IT
department starts hiring interns. The IT interns are allowed to use the normal
workstations and the less important servers; and the IT apprentices are allowed to login
onto the main servers. You add a new netgroup <tt class="LITERAL">IT_INTERN</tt>, add the
new IT interns to this netgroup and start to change the configuration on each and every
machine... As the old saying goes: “Errors in centralized planning lead to global
mess”.</p>

<p>NIS' ability to create netgroups from other netgroups can be used to prevent
situations like these. One possibility is the creation of role-based netgroups. For
example, you could create a netgroup called <tt class="LITERAL">BIGSRV</tt> to define the
login restrictions for the important servers, another netgroup called <tt
class="LITERAL">SMALLSRV</tt> for the less important servers and a third netgroup called
<tt class="LITERAL">USERBOX</tt> for the normal workstations. Each of these netgroups
contains the netgroups that are allowed to login onto these machines. The new entries for
your NIS map netgroup should look like this:</p>

<pre class="PROGRAMLISTING">
BIGSRV    IT_EMP  IT_APP
SMALLSRV  IT_EMP  IT_APP  ITINTERN
USERBOX   IT_EMP  ITINTERN USERS
</pre>

<p>This method of defining login restrictions works reasonably well if you can define
groups of machines with identical restrictions. Unfortunately, this is the exception and
not the rule. Most of the time, you will need the ability to define login restrictions on
a per-machine basis.</p>

<p>Machine-specific netgroup definitions are the other possibility to deal with the
policy change outlined above. In this scenario, the <tt
class="FILENAME">/etc/master.passwd</tt> of each box contains two lines starting with
“+”. The first of them adds a netgroup with the accounts allowed to login onto this
machine, the second one adds all other accounts with <tt
class="FILENAME">/sbin/nologin</tt> as shell. It is a good idea to use the “ALL-CAPS”
version of the machine name as the name of the netgroup. In other words, the lines should
look like this:</p>

<pre class="PROGRAMLISTING">
+@<tt class="REPLACEABLE"><i>BOXNAME</i></tt>:::::::::
+:::::::::/sbin/nologin
</pre>

<p>Once you have completed this task for all your machines, you will not have to modify
the local versions of <tt class="FILENAME">/etc/master.passwd</tt> ever again. All
further changes can be handled by modifying the NIS map. Here is an example of a possible
netgroup map for this scenario with some additional goodies:</p>

<pre class="PROGRAMLISTING">
# Define groups of users first
IT_EMP    (,alpha,test-domain)    (,beta,test-domain)
IT_APP    (,charlie,test-domain)  (,delta,test-domain)
DEPT1     (,echo,test-domain)     (,foxtrott,test-domain)
DEPT2     (,golf,test-domain)     (,hotel,test-domain)
DEPT3     (,india,test-domain)    (,juliet,test-domain)
ITINTERN  (,kilo,test-domain)     (,lima,test-domain)
D_INTERNS (,able,test-domain)     (,baker,test-domain)
#
# Now, define some groups based on roles
USERS     DEPT1   DEPT2     DEPT3
BIGSRV    IT_EMP  IT_APP
SMALLSRV  IT_EMP  IT_APP    ITINTERN
USERBOX   IT_EMP  ITINTERN  USERS
#
# And a groups for a special tasks
# Allow echo and golf to access our anti-virus-machine
SECURITY  IT_EMP  (,echo,test-domain)  (,golf,test-domain)
#
# machine-based netgroups
# Our main servers
WAR       BIGSRV
FAMINE    BIGSRV
# User india needs access to this server
POLLUTION  BIGSRV  (,india,test-domain)
#
# This one is really important and needs more access restrictions
DEATH     IT_EMP
#
# The anti-virus-machine mentioned above
ONE       SECURITY
#
# Restrict a machine to a single user
TWO       (,hotel,test-domain)
# [...more groups to follow]
</pre>

<p>If you are using some kind of database to manage your user accounts, you should be
able to create the first part of the map with your database's report tools. This way, new
users will automatically have access to the boxes.</p>

<p>One last word of caution: It may not always be advisable to use machine-based
netgroups. If you are deploying a couple of dozen or even hundreds of identical machines
for student labs, you should use role-based netgroups instead of machine-based netgroups
to keep the size of the NIS map within reasonable limits.</p>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN35554" name="AEN35554">25.4.8 Important Things to
Remember</a></h2>

<p>There are still a couple of things that you will need to do differently now that you
are in an NIS environment.</p>

<ul>
<li>
<p>Every time you wish to add a user to the lab, you must add it to the master NIS server
<span class="emphasis"><i class="EMPHASIS">only</i></span>, and <span class="emphasis"><i
class="EMPHASIS">you must remember to rebuild the NIS maps</i></span>. If you forget to
do this, the new user will not be able to login anywhere except on the NIS master. For
example, if we needed to add a new user <tt class="USERNAME">jsmith</tt> to the lab, we
would:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">pw useradd jsmith</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cd /var/yp</kbd>
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">make test-domain</kbd>
</pre>

<p>You could also run <tt class="COMMAND">adduser jsmith</tt> instead of <tt
class="COMMAND">pw useradd jsmith</tt>.</p>
</li>

<li>
<p><span class="emphasis"><i class="EMPHASIS">Keep the administration accounts out of the
NIS maps</i></span>. You do not want to be propagating administrative accounts and
passwords to machines that will have users that should not have access to those
accounts.</p>
</li>

<li>
<p><span class="emphasis"><i class="EMPHASIS">Keep the NIS master and slave secure, and
minimize their downtime</i></span>. If somebody either hacks or simply turns off these
machines, they have effectively rendered many people without the ability to login to the
lab.</p>

<p>This is the chief weakness of any centralized administration system. If you do not
protect your NIS servers, you will have a lot of angry users!</p>
</li>
</ul>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN35580" name="AEN35580">25.4.9 NIS v1 Compatibility</a></h2>

<p>FreeBSD's <b class="APPLICATION">ypserv</b> has some support for serving NIS v1
clients. FreeBSD's NIS implementation only uses the NIS v2 protocol, however other
implementations include support for the v1 protocol for backwards compatibility with
older systems. The <b class="APPLICATION">ypbind</b> daemons supplied with these systems
will try to establish a binding to an NIS v1 server even though they may never actually
need it (and they may persist in broadcasting in search of one even after they receive a
response from a v2 server). Note that while support for normal client calls is provided,
this version of <b class="APPLICATION">ypserv</b> does not handle v1 map transfer
requests; consequently, it cannot be used as a master or slave in conjunction with older
NIS servers that only support the v1 protocol. Fortunately, there probably are not any
such servers still in use today.</p>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="NETWORK-NIS-SERVER-IS-CLIENT"
name="NETWORK-NIS-SERVER-IS-CLIENT">25.4.10 NIS Servers That Are Also NIS
Clients</a></h2>

<p>Care must be taken when running <b class="APPLICATION">ypserv</b> in a multi-server
domain where the server machines are also NIS clients. It is generally a good idea to
force the servers to bind to themselves rather than allowing them to broadcast bind
requests and possibly become bound to each other. Strange failure modes can result if one
server goes down and others are dependent upon it. Eventually all the clients will time
out and attempt to bind to other servers, but the delay involved can be considerable and
the failure mode is still present since the servers might bind to each other all over
again.</p>

<p>You can force a host to bind to a particular server by running <tt
class="COMMAND">ypbind</tt> with the <code class="OPTION">-S</code> flag. If you do not
want to do this manually each time you reboot your NIS server, you can add the following
lines to your <tt class="FILENAME">/etc/rc.conf</tt>:</p>

<pre class="PROGRAMLISTING">
nis_client_enable="YES"    # run client stuff as well
nis_client_flags="-S <tt class="REPLACEABLE"><i>NIS domain</i></tt>,<tt
class="REPLACEABLE"><i>server</i></tt>"
</pre>

<p>See <a href="http://www.FreeBSD.org/cgi/man.cgi?query=ypbind&amp;sektion=8"><span
class="CITEREFENTRY"><span class="REFENTRYTITLE">ypbind</span>(8)</span></a> for further
information.</p>
</div>

<div class="SECT2">
<h2 class="SECT2"><a id="AEN35601" name="AEN35601">25.4.11 Password Formats</a></h2>

<p>One of the most common issues that people run into when trying to implement NIS is
password format compatibility. If your NIS server is using DES encrypted passwords, it
will only support clients that are also using DES. For example, if you have <span
class="TRADEMARK">Solaris</span> NIS clients in your network, then you will almost
certainly need to use DES encrypted passwords.</p>

<p>To check which format your servers and clients are using, look at <tt
class="FILENAME">/etc/login.conf</tt>. If the host is configured to use DES encrypted
passwords, then the <tt class="LITERAL">default</tt> class will contain an entry like
this:</p>

<pre class="PROGRAMLISTING">
default:\
    :passwd_format=des:\
    :copyright=/etc/COPYRIGHT:\
    [Further entries elided]
</pre>

<p>Other possible values for the <tt class="LITERAL">passwd_format</tt> capability
include <tt class="LITERAL">blf</tt> and <tt class="LITERAL">md5</tt> (for Blowfish and
MD5 encrypted passwords, respectively).</p>

<p>If you have made changes to <tt class="FILENAME">/etc/login.conf</tt>, you will also
need to rebuild the login capability database, which is achieved by running the following
command as <tt class="USERNAME">root</tt>:</p>

<pre class="SCREEN">
<samp class="PROMPT">#</samp> <kbd class="USERINPUT">cap_mkdb /etc/login.conf</kbd>
</pre>

<div class="NOTE">
<blockquote class="NOTE">
<p><b>Note:</b> The format of passwords already in <tt
class="FILENAME">/etc/master.passwd</tt> will not be updated until a user changes his
password for the first time <span class="emphasis"><i class="EMPHASIS">after</i></span>
the login capability database is rebuilt.</p>
</blockquote>
</div>

<p>Next, in order to ensure that passwords are encrypted with the format that you have
chosen, you should also check that the <tt class="LITERAL">crypt_default</tt> in <tt
class="FILENAME">/etc/auth.conf</tt> gives precedence to your chosen password format. To
do this, place the format that you have chosen first in the list. For example, when using
DES encrypted passwords, the entry would be:</p>

<pre class="PROGRAMLISTING">
crypt_default  =   des blf md5
</pre>

<p>Having followed the above steps on each of the FreeBSD based NIS servers and clients,
you can be sure that they all agree on which password format is used within your network.
If you have trouble authenticating on an NIS client, this is a pretty good place to start
looking for possible problems. Remember: if you want to deploy an NIS server for a
heterogenous network, you will probably have to use DES on all systems because it is the
lowest common standard.</p>
</div>
</div>

<div class="NAVFOOTER">
<hr align="LEFT" width="100%" />
<table summary="Footer navigation table" width="100%" border="0" cellpadding="0"
cellspacing="0">
<tr>
<td width="33%" align="left" valign="top"><a href="network-nfs.html"
accesskey="P">Prev</a></td>
<td width="34%" align="center" valign="top"><a href="index.html"
accesskey="H">Home</a></td>
<td width="33%" align="right" valign="top"><a href="network-dhcp.html"
accesskey="N">Next</a></td>
</tr>

<tr>
<td width="33%" align="left" valign="top">Network File System (NFS)</td>
<td width="34%" align="center" valign="top"><a href="network-servers.html"
accesskey="U">Up</a></td>
<td width="33%" align="right" valign="top">Automatic Network Configuration (DHCP)</td>
</tr>
</table>
</div>

<p align="center"><small>This, and other documents, can be downloaded from <a
href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>.</small></p>

<p align="center"><small>For questions about FreeBSD, read the <a
href="http://www.FreeBSD.org/docs.html">documentation</a> before contacting &#60;<a
href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&#62;.<br />
For questions about this documentation, e-mail &#60;<a
href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&#62;.</small></p>
</body>
</html>

